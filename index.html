<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>üèÜ PONG CHAMPIONSHIP üèÜ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root {
      --paddle-width: 15px;
      --ball-radius: 6px;
      --paddle-speed: 10;
      --initial-ball-speed: 7;
      --max-ball-speed: 11;
      --four-player-ball-speed: 8;
    }
    
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #000;
      font-family: 'Arial', sans-serif;
      touch-action: manipulation;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      height: 100vh;
      width: 100vw;
    }
    
    #gameContainer {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
    }
    
    canvas {
      background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
      display: block;
      touch-action: none;
      width: 100%;
      height: 100%;
      border-radius: 0;
    }
    
    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    .score {
      position: absolute;
      top: 20px;
      font-size: 3rem;
      color: white;
      text-shadow: 0 0 15px rgba(255,255,255,0.9);
      z-index: 30;
      font-weight: bold;
      font-family: 'Impact', sans-serif;
      display: none;
    }
    
    #leftScore { left: 25%; }
    #rightScore { right: 25%; }
    
    #timer {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 1.8rem;
      color: gold;
      z-index: 30;
      font-weight: bold;
      text-shadow: 0 0 10px rgba(255,215,0,0.7);
      display: none;
    }
    
    #bonusPoints {
      position: absolute;
      top: 60px;
      left: 50%;
      transform: translateX(-50%);
      color: gold;
      font-size: 1.2rem;
      text-shadow: 1px 1px 3px black;
      z-index: 30;
      font-weight: bold;
      display: none;
    }
    
    #matchInfo {
      position: absolute;
      top: 90px;
      left: 50%;
      transform: translateX(-50%);
      color: white;
      font-size: 1rem;
      text-shadow: 1px 1px 2px black;
      z-index: 30;
      display: none;
    }
    
    #commentary {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 12px 24px;
      border-radius: 25px;
      max-width: 90%;
      text-align: center;
      font-size: 1.2rem;
      z-index: 30;
      font-weight: bold;
      border: 3px solid gold;
      box-shadow: 0 0 20px rgba(255,215,0,0.7);
      transition: all 0.3s;
      font-family: 'Arial Black', sans-serif;
    }
    
    .screen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 100;
    }
    
    .screen h1 {
      font-size: 3rem;
      color: gold;
      text-shadow: 0 0 15px rgba(255,215,0,0.9);
      margin-bottom: 2rem;
      text-align: center;
      font-family: 'Impact', sans-serif;
      letter-spacing: 2px;
    }
    
    .btn-championship {
      background: linear-gradient(45deg, #ff8a00, #e52e71);
      border: none;
      font-size: 1.5rem;
      padding: 15px 35px;
      margin: 15px;
      border-radius: 50px;
      color: white;
      box-shadow: 0 8px 20px rgba(0,0,0,0.4);
      transition: all 0.3s;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 2px;
      font-family: 'Arial Black', sans-serif;
    }
    
    .btn-championship:hover {
      transform: scale(1.1);
      box-shadow: 0 12px 25px rgba(0,0,0,0.5);
    }
    
    .control-btn {
      position: absolute;
      z-index: 40;
      background: rgba(255,255,255,0.3);
      border: 2px solid white;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: all 0.2s;
      box-shadow: 0 0 10px rgba(255,255,255,0.5);
    }
    
    .control-btn:hover {
      background: rgba(255,255,255,0.4);
      transform: scale(1.1);
    }
    
    .control-btn:active {
      transform: scale(0.9);
    }
    
    #muteButton { top: 20px; left: 20px; }
    #pauseButton { top: 20px; left: 80px; }
    #fullscreenButton { top: 20px; left: 140px; }
    #musicMuteButton { top: 20px; right: 20px; }
    
    #pauseScreen, #countdown, #halftimeScreen, #gameOverScreen {
      display: none;
    }
    
    #mobileControls {
      position: absolute;
      bottom: 30px;
      width: 100%;
      display: flex;
      justify-content: space-between;
      padding: 0 30px;
      z-index: 20;
    }
    
    .mobile-paddle-controls {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .mobile-btn {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: rgba(255,255,255,0.3);
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
      font-size: 2rem;
      user-select: none;
      touch-action: manipulation;
      border: 2px solid white;
      box-shadow: 0 0 15px rgba(255,255,255,0.5);
    }
    
    .mobile-btn:active {
      background: rgba(255,255,255,0.5);
      transform: scale(0.95);
    }
    
    .confetti {
      position: absolute;
      width: 10px;
      height: 10px;
      background-color: #f00;
      border-radius: 50%;
      pointer-events: none;
      z-index: 100;
    }
    
    @keyframes confetti-fall {
      0% { transform: translateY(-100px) rotate(0deg); }
      100% { transform: translateY(100vh) rotate(360deg); }
    }
    
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 300;
    }
    
    .modal-content {
      background: linear-gradient(135deg, #1a2a6c, #b21f1f);
      padding: 40px;
      border-radius: 25px;
      text-align: center;
      max-width: 90%;
      width: 500px;
      box-shadow: 0 0 40px rgba(0,0,0,0.7);
      border: 4px solid gold;
    }
    
    .modal-title {
      color: gold;
      font-size: 2.2rem;
      margin-bottom: 30px;
      text-shadow: 0 0 15px rgba(255,215,0,0.9);
      font-family: 'Impact', sans-serif;
    }
    
    .modal-input {
      width: 100%;
      padding: 15px;
      margin-bottom: 25px;
      border-radius: 15px;
      border: 3px solid gold;
      font-size: 1.5rem;
      text-align: center;
      background: rgba(0,0,0,0.7);
      color: white;
      font-family: 'Arial', sans-serif;
    }
    
    .modal-btn {
      padding: 15px 35px;
      margin: 0 15px;
      border-radius: 50px;
      border: none;
      background: gold;
      color: #000;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 1.2rem;
      font-family: 'Arial Black', sans-serif;
    }
    
    .modal-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 0 20px rgba(255,215,0,0.9);
    }
    
    #countdown {
      font-size: 10rem;
      font-weight: bold;
      color: gold;
      text-shadow: 0 0 30px rgba(255,215,0,0.9);
      animation: pulse 0.5s infinite alternate;
    }
    
    #halftimeScreen {
      font-size: 5rem;
      font-weight: bold;
      color: gold;
      text-shadow: 0 0 30px rgba(255,215,0,0.9);
    }
    
    #gameOverScreen {
      font-size: 5rem;
      font-weight: bold;
      color: red;
      text-shadow: 0 0 30px rgba(255,0,0,0.9);
    }
    
    @keyframes pulse {
      from { transform: scale(1); opacity: 1; }
      to { transform: scale(1.3); opacity: 0.8; }
    }
    
    #goText {
      font-size: 10rem;
      font-weight: bold;
      color: gold;
      text-shadow: 0 0 30px rgba(255,215,0,0.9);
      animation: goPulse 0.3s infinite alternate, fadeOut 1s 1s forwards;
      display: none;
    }
    
    @keyframes goPulse {
      from { transform: scale(1); text-shadow: 0 0 30px rgba(255,215,0,0.9); }
      to { transform: scale(1.5); text-shadow: 0 0 60px rgba(255,215,0,1); }
    }
    
    @keyframes fadeOut {
      to { opacity: 0; }
    }
    
    /* Power shot effects */
    .fire-trail {
      position: absolute;
      width: 20px;
      height: 20px;
      background: radial-gradient(circle, yellow, orange, red);
      border-radius: 50%;
      pointer-events: none;
      z-index: 10;
      opacity: 0.7;
    }
    
    .paddle-charge {
      position: absolute;
      bottom: 10px;
      height: 10px;
      background: linear-gradient(to right, #00ff00, #ffff00, #ff0000);
      border-radius: 5px;
      z-index: 20;
      transition: width 0.1s;
    }
    
    #leftCharge {
      left: 20px;
      width: 0;
    }
    
    #rightCharge {
      right: 20px;
      width: 0;
    }
    
    .paddle-charge.active {
      animation: chargePulse 0.5s infinite alternate;
    }
    
    @keyframes chargePulse {
      from { box-shadow: 0 0 5px gold; }
      to { box-shadow: 0 0 20px gold; }
    }
    
    /* Leaderboard Styles - Only in menu */
    #menuLeaderboards {
      position: absolute;
      bottom: 20px;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-around;
      z-index: 50;
    }
    
    .leaderboard {
      background: rgba(0, 0, 0, 0.7);
      border: 2px solid gold;
      border-radius: 10px;
      padding: 10px;
      color: white;
      max-height: 30vh;
      overflow-y: auto;
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
      font-family: 'Arial', sans-serif;
      width: 30%;
      max-width: 300px;
    }
    
    .leaderboard h3 {
      color: gold;
      margin-top: 0;
      margin-bottom: 10px;
      text-align: center;
      font-size: 1.2rem;
      border-bottom: 1px solid gold;
      padding-bottom: 5px;
    }
    
    .leaderboard-item {
      padding: 5px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      font-size: 0.9rem;
    }
    
    .leaderboard-item:last-child {
      border-bottom: none;
    }
    
    .leaderboard-rank {
      color: gold;
      font-weight: bold;
      margin-right: 5px;
    }
    
    /* Scrollbar styling */
    .leaderboard::-webkit-scrollbar {
      width: 8px;
    }
    
    .leaderboard::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
    }
    
    .leaderboard::-webkit-scrollbar-thumb {
      background: gold;
      border-radius: 10px;
    }
    
    .leaderboard::-webkit-scrollbar-thumb:hover {
      background: #ffcc00;
    }
    
    /* Tournament stage selector */
    .stage-selector {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 20px;
      gap: 10px;
    }
    
    .stage-btn {
      background: rgba(255, 215, 0, 0.2);
      border: 1px solid gold;
      color: white;
      padding: 8px 15px;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .stage-btn:hover {
      background: rgba(255, 215, 0, 0.4);
    }
    
    .stage-btn.active {
      background: gold;
      color: black;
      font-weight: bold;
    }
    
    @media (max-width: 768px) {
      .score { 
        font-size: 2.5rem; 
        top: 15px; 
      }
      #leftScore { left: 20%; }
      #rightScore { right: 20%; }
      #timer { font-size: 1.5rem; top: 15px; }
      #bonusPoints { font-size: 1rem; top: 50px; }
      #matchInfo { font-size: 0.9rem; top: 80px; }
      #commentary { 
        font-size: 1rem; 
        padding: 10px 20px; 
        bottom: 15px; 
        max-width: 95%;
      }
      .btn-championship { 
        font-size: 1.2rem; 
        padding: 12px 25px; 
        margin: 10px;
      }
      .control-btn {
        width: 45px;
        height: 45px;
        font-size: 1rem;
      }
      #muteButton { left: 10px; top: 10px; }
      #pauseButton { left: 65px; top: 10px; }
      #fullscreenButton { left: 120px; top: 10px; }
      #musicMuteButton { right: 10px; top: 10px; }
      .mobile-btn {
        width: 70px;
        height: 70px;
        font-size: 1.8rem;
      }
      .modal-content {
        width: 90%;
        padding: 30px;
      }
      .modal-title {
        font-size: 1.8rem;
      }
      .modal-input {
        font-size: 1.2rem;
        padding: 12px;
      }
      #countdown, #goText {
        font-size: 6rem;
      }
      #halftimeScreen, #gameOverScreen {
        font-size: 3rem;
      }
      
      /* Adjust leaderboards for mobile */
      #menuLeaderboards {
        flex-direction: column;
        align-items: center;
        gap: 10px;
      }
      
      .leaderboard {
        width: 90%;
        max-width: none;
        font-size: 0.8rem;
      }
    }
    
    @media (max-height: 500px) {
      .screen h1 { font-size: 2rem; }
      .btn-championship { 
        font-size: 1rem; 
        padding: 10px 20px;
        margin: 8px;
      }
      #mobileControls { bottom: 15px; }
      .mobile-btn { 
        width: 60px; 
        height: 60px; 
        font-size: 1.5rem;
      }
      #commentary { 
        bottom: 10px;
        font-size: 0.9rem;
      }
      #countdown, #goText {
        font-size: 4rem;
      }
      #halftimeScreen, #gameOverScreen {
        font-size: 2.5rem;
      }
      
      /* Hide leaderboards on very small screens */
      #menuLeaderboards {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div id="gameContainer">
    <canvas id="pongCanvas"></canvas>
    
    <!-- Game elements (hidden during menu) -->
    <div id="leftScore" class="score">0</div>
    <div id="rightScore" class="score">0</div>
    <div id="timer">1:30.000</div>
    <div id="bonusPoints"></div>
    <div id="matchInfo"></div>
    <div id="commentary">WELCOME TO THE PONG CHAMPIONSHIP!</div>
    
    <!-- Power charge bars -->
    <div id="leftCharge" class="paddle-charge"></div>
    <div id="rightCharge" class="paddle-charge"></div>
    
    <button id="muteButton" class="control-btn">üîä</button>
    <button id="pauseButton" class="control-btn">‚è∏Ô∏è</button>
    <button id="fullscreenButton" class="control-btn">‚õ∂</button>
    <button id="musicMuteButton" class="control-btn">üéµ</button>
    
    <div id="mobileControls" style="display: none;">
      <div class="mobile-paddle-controls">
        <div class="mobile-btn" id="upBtnLeft">‚Üë</div>
        <div class="mobile-btn" id="downBtnLeft">‚Üì</div>
      </div>
      <div class="mobile-paddle-controls">
        <div class="mobile-btn" id="upBtnRight">‚Üë</div>
        <div class="mobile-btn" id="downBtnRight">‚Üì</div>
      </div>
    </div>

    <div id="countdown" class="screen"></div>
    <div id="goText" class="screen">GO!</div>
    <div id="halftimeScreen" class="screen"></div>
    <div id="gameOverScreen" class="screen">GAME OVER</div>

    <div id="pauseScreen" class="screen">
      <h1>GAME CURRENTLY PAUSED</h1>
      <button class="btn-championship" id="resumeButton">RESUME</button>
      <button class="btn-championship" id="returnToMenuButton">RETURN TO MENU</button>
    </div>

    <div id="titleScreen" class="screen">
      <h1>üèÜ PONG CHAMPIONSHIP üèÜ</h1>
      <button class="btn-championship" id="twoPlayerButton">2 PLAYERS</button>
      <button class="btn-championship" id="singlePlayerButton">1 PLAYER VS BOT</button>
      <button class="btn-championship" id="fourPlayerButton">4 PLAYERS</button>
      
      <!-- Leaderboards in menu only -->
      <div id="menuLeaderboards">
        <div id="recentPlays" class="leaderboard">
          <h3>RECENT PLAYS</h3>
          <div id="recentPlaysList"></div>
        </div>
        
        <div id="bestWins" class="leaderboard">
          <h3>BEST WINS</h3>
          <div id="bestWinsList"></div>
        </div>
        
        <div id="botChampion" class="leaderboard">
          <h3>BOT CHAMPIONS</h3>
          <div id="botChampionList"></div>
        </div>
      </div>
    </div>

    <div id="endScreen" class="screen" style="display: none;">
      <h1 id="endMessage" style="color: gold; font-size: 2rem;"></h1>
      <button class="btn-championship" id="endScreenBtn">RETURN TO MENU</button>
    </div>
  </div>

  <div id="twoPlayerPrompt" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-title">ENTER PLAYER NAMES</div>
      <input type="text" id="leftPlayerName" class="modal-input" placeholder="Left Player Name" maxlength="20">
      <input type="text" id="rightPlayerName" class="modal-input" placeholder="Right Player Name" maxlength="20">
      
      <div class="stage-selector">
        <div class="stage-btn" data-stage="Round of 16">Round of 16</div>
        <div class="stage-btn" data-stage="Quarter Finals">Quarter Finals</div>
        <div class="stage-btn" data-stage="Semi Finals">Semi Finals</div>
        <div class="stage-btn" data-stage="Finals">Finals</div>
      </div>
      
      <input type="hidden" id="selectedStage" value="Round of 16">
      
      <button class="modal-btn" id="submitTwoPlayerNames">START GAME</button>
    </div>
  </div>

  <div id="fourPlayerPrompt" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-title">ENTER TEAM NAMES</div>
      <input type="text" id="leftTeamName" class="modal-input" placeholder="Left Team Name" maxlength="20">
      <input type="text" id="rightTeamName" class="modal-input" placeholder="Right Team Name" maxlength="20">
      <button class="modal-btn" id="submitFourPlayerNames">START GAME</button>
    </div>
  </div>

  <div id="singlePlayerPrompt" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-title">WHAT IS YOUR NAME?</div>
      <input type="text" id="playerName" class="modal-input" placeholder="Your Name" maxlength="20">
      <button class="modal-btn" id="submitSinglePlayerName">START GAME</button>
    </div>
  </div>

  <!-- Audio elements -->
  <audio id="backgroundMusic" loop></audio>
  <audio id="paddleSound"></audio>
  <audio id="scoreSound"></audio>
  <audio id="scoreSound1"></audio>
  <audio id="scoreSound2"></audio>
  <audio id="hitSound"></audio>
  <audio id="hitSound1"></audio>
  <audio id="hitSound2"></audio>
  <audio id="hitSound3"></audio>
  <audio id="hitSound4"></audio>
  <audio id="etSound"></audio>
  <audio id="gameOverSound"></audio>
  <audio id="gameOverSound1"></audio>
  <audio id="selectSound"></audio>
  <audio id="startSound"></audio>
  <audio id="startSound1"></audio>
  <audio id="startSound2"></audio>
  <audio id="startSound3"></audio>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Game Constants
    const PADDLE_HEIGHT_RATIO = 0.2;
    const FOUR_PLAYER_PADDLE_HEIGHT_RATIO = 0.15;
    const BALL_RADIUS_RATIO = 0.012;
    const INITIAL_BALL_SPEED = 9;
    const MAX_BALL_SPEED = 17;
    const FOUR_PLAYER_BALL_SPEED = 10;
    const PADDLE_SPEED = 10;
    const WINNING_SCORE = 10;
    const HALF_TIME = 90; // 1 minute 30 seconds per half
    const HALF_TIME_BREAK = 10; // 10 second break
    const OVERTIME_TIME = 30; // 30 seconds for overtime
    const BALL_SPEED_INCREMENT = 0.6;
    const SMASH_SPEED_MULTIPLIER = 2;
    const SMASH_DURATION = 1000; // ms
    const CHARGE_TIME = 4000; // 4 seconds to charge
    const POWER_SHOT_DURATION = 1000; // 1 second to use power shot
    
    // Game Elements
    const canvas = document.getElementById('pongCanvas');
    const ctx = canvas.getContext('2d');
    
    // Audio Elements
    const backgroundMusic = document.getElementById('backgroundMusic');
    const paddleSound = document.getElementById('paddleSound');
    const scoreSound = document.getElementById('scoreSound');
    const scoreSound1 = document.getElementById('scoreSound1');
    const scoreSound2 = document.getElementById('scoreSound2');
    const hitSound = document.getElementById('hitSound');
    const hitSound1 = document.getElementById('hitSound1');
    const hitSound2 = document.getElementById('hitSound2');
    const hitSound3 = document.getElementById('hitSound3');
    const hitSound4 = document.getElementById('hitSound4');
    const etSound = document.getElementById('etSound');
    const gameOverSound = document.getElementById('gameOverSound');
    const gameOverSound1 = document.getElementById('gameOverSound1');
    const selectSound = document.getElementById('selectSound');
    const startSound = document.getElementById('startSound');
    const startSound1 = document.getElementById('startSound1');
    const startSound2 = document.getElementById('startSound2');
    const startSound3 = document.getElementById('startSound3');
    
    // Game State
    const game = {
      ball: { x: 0, y: 0, dx: 0, dy: 0, speed: INITIAL_BALL_SPEED, originalSpeed: INITIAL_BALL_SPEED },
      leftPaddle: { y: 0, score: 0 },
      rightPaddle: { y: 0, score: 0 },
      leftTopPaddle: { y: 0 },
      leftBottomPaddle: { y: 0 },
      rightTopPaddle: { y: 0 },
      rightBottomPaddle: { y: 0 },
      isFourPlayer: false,
      isMuted: false,
      isMusicMuted: false,
      isPaused: false,
      gameStarted: false,
      remainingTime: HALF_TIME,
      currentHalf: 1,
      extraTime: 0,
      halftimeActive: false,
      lastScorer: null,
      matchPoint: false,
      leftPlayer: "PLAYER 1",
      rightPlayer: "PLAYER 2",
      tournamentStage: "Round of 16",
      timerInterval: null,
      countdownInterval: null,
      halftimeInterval: null,
      keysPressed: {},
      bonusPoints: 0,
      deuceActive: false,
      startTime: 0,
      pausedTime: 0,
      commentaryQueue: [],
      isSpeaking: false,
      hasAnnounced30: false,
      hasAnnounced10: false,
      currentUtterance: null,
      lastSpecialMoveTime: 0,
      betweenPointsTimeout: null,
      mobileControls: {
        leftUp: false,
        leftDown: false,
        rightUp: false,
        rightDown: false
      },
      dpadEnabled: false,
      isLocalMultiplayer: false,
      paddleWidth: 0,
      paddleHeight: 0,
      fourPlayerPaddleHeight: 0,
      ballRadius: 0,
      musicStarted: false,
      smashCounter: 0,
      smashTarget: 0,
      isSmashActive: false,
      smashEndTime: 0,
      recentPlays: [],
      bestWins: [],
      botChampions: [],
      leftCharge: 0,
      rightCharge: 0,
      leftCharged: false,
      rightCharged: false,
      leftChargeInterval: null,
      rightChargeInterval: null,
      leftChargeEndTime: 0,
      rightChargeEndTime: 0,
      countdownActive: false,
      last10Seconds: false,
      countdownNumbers: [],
      fireTrails: []
    };

    // Commentary phrases
    const commentaryPhrases = [
      "What a shot!",
      "Incredible reflexes!",
      "The crowd is going wild!",
      "This is championship-level play!",
      "Unbelievable!",
      "Did you see that?!",
      "The tension is palpable!",
      "What a rally!",
      "This match is heating up!",
      "A masterclass in pong!",
      "The players are giving it their all!",
      "This is pong at its finest!",
      "The stakes couldn't be higher!",
      "What a display of skill!",
      "The championship is on the line!",
      "This is what we came to see!",
      "The intensity is through the roof!",
      "Absolutely breathtaking play!",
      "The crowd can't believe their eyes!",
      "This is edge-of-your-seat action!",
      "The players are in the zone!",
      "What a back-and-forth battle!",
      "The energy in the arena is electric!",
      "This is pong perfection!",
      "The skill level is off the charts!",
      "Neither player is backing down!",
      "The determination is incredible!",
      "This is a clash of titans!",
      "The focus is laser-sharp!",
      "Every point is a masterpiece!",
      "The competition is fierce!",
      "This is next-level pong!",
      "The players are pushing their limits!",
      "The crowd is on their feet!",
      "This is a legendary match!",
      "The speed is mind-blowing!",
      "The precision is surgical!",
      "This is pong at warp speed!",
      "The reflexes are superhuman!",
      "The crowd is losing their minds!",
      "This is the match of the century!",
      "The players are unstoppable!",
      "The excitement is unbearable!",
      "This is pong poetry in motion!",
      "The anticipation is killing me!",
      "The players are putting on a clinic!",
      "This is a masterclass in competition!",
      "The drama is intense!",
      "The crowd is roaring with excitement!",
      "This is pong at its absolute best!"
    ];

    // Initialize Game
    function initGame() {
      resizeCanvas();
      window.addEventListener('resize', resizeCanvas);
      setupMobileControls();
      setupKeyboardControls();
      setupControlButtons();
      loadAudioFiles();
      loadLeaderboards();
      setupEventListeners();
      
      // Set up click event to start music
      document.addEventListener('click', startMusicOnInteraction, { once: true });
      
      // Start the game loop
      gameLoop();
    }

    function setupEventListeners() {
      // Menu buttons
      document.getElementById('twoPlayerButton').addEventListener('click', startTwoPlayerGame);
      document.getElementById('singlePlayerButton').addEventListener('click', startSinglePlayerGame);
      document.getElementById('fourPlayerButton').addEventListener('click', startFourPlayerGame);
      
      // Modal submit buttons
      document.getElementById('submitTwoPlayerNames').addEventListener('click', submitTwoPlayerNames);
      document.getElementById('submitSinglePlayerName').addEventListener('click', submitSinglePlayerName);
      document.getElementById('submitFourPlayerNames').addEventListener('click', submitFourPlayerNames);
      
      // Game control buttons
      document.getElementById('resumeButton').addEventListener('click', togglePause);
      document.getElementById('returnToMenuButton').addEventListener('click', returnToMenu);
      document.getElementById('endScreenBtn').addEventListener('click', returnToMenu);
      
      // Stage selection
      const stageBtns = document.querySelectorAll('.stage-btn');
      stageBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          stageBtns.forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          document.getElementById('selectedStage').value = this.dataset.stage;
        });
      });
      // Activate first stage by default
      stageBtns[0].classList.add('active');
    }

    function setupButtonSounds() {
      const buttons = document.querySelectorAll('button');
      buttons.forEach(button => {
        button.addEventListener('click', () => {
          if (!game.isMuted) {
            selectSound.currentTime = 0;
            selectSound.play().catch(e => console.log("Audio play error:", e));
          }
        });
      });
    }

    function startMusicOnInteraction() {
      if (!game.musicStarted) {
        game.musicStarted = true;
        playRandomStartMusic();
      }
    }

    function loadLeaderboards() {
      // Load from localStorage if available
      if (localStorage.getItem('pongRecentPlays')) {
        game.recentPlays = JSON.parse(localStorage.getItem('pongRecentPlays'));
      }
      
      if (localStorage.getItem('pongBestWins')) {
        game.bestWins = JSON.parse(localStorage.getItem('pongBestWins'));
      }
      
      if (localStorage.getItem('pongBotChampions')) {
        game.botChampions = JSON.parse(localStorage.getItem('pongBotChampions'));
      }
      
      updateLeaderboards();
    }

    function updateLeaderboards() {
      // Recent Plays
      const recentPlaysList = document.getElementById('recentPlaysList');
      recentPlaysList.innerHTML = '';
      
      game.recentPlays.slice(0, 10).forEach((play, index) => {
        const item = document.createElement('div');
        item.className = 'leaderboard-item';
        item.innerHTML = `<strong>${play.player1}</strong> vs <strong>${play.player2}</strong><br>
                         ${play.stage} - ${play.score1}-${play.score2}`;
        recentPlaysList.appendChild(item);
      });
      
      // Best Wins
      const bestWinsList = document.getElementById('bestWinsList');
      bestWinsList.innerHTML = '';
      
      game.bestWins.sort((a, b) => (b.score1 - b.score2) - (a.score1 - a.score2)).slice(0, 10).forEach((win, index) => {
        const item = document.createElement('div');
        item.className = 'leaderboard-item';
        item.innerHTML = `<span class="leaderboard-rank">${index + 1}.</span> 
                         <strong>${win.player1}</strong> ${win.score1}-${win.score2} <strong>${win.player2}</strong>`;
        bestWinsList.appendChild(item);
      });
      
      // Bot Champions
      const botChampionList = document.getElementById('botChampionList');
      botChampionList.innerHTML = '';
      
      game.botChampions.sort((a, b) => (b.score1 - b.score2) - (a.score1 - a.score2)).slice(0, 20).forEach((champ, index) => {
        const item = document.createElement('div');
        item.className = 'leaderboard-item';
        item.innerHTML = `<span class="leaderboard-rank">${index + 1}.</span> 
                         <strong>${champ.player1}</strong> ${champ.score1}-${champ.score2} BOT`;
        botChampionList.appendChild(item);
      });
    }

    function saveToLeaderboard(type, data) {
      if (type === 'recent') {
        game.recentPlays.unshift(data);
        if (game.recentPlays.length > 50) game.recentPlays.pop();
        localStorage.setItem('pongRecentPlays', JSON.stringify(game.recentPlays));
      } 
      else if (type === 'best') {
        game.bestWins.push(data);
        if (game.bestWins.length > 50) game.bestWins.pop();
        localStorage.setItem('pongBestWins', JSON.stringify(game.bestWins));
      }
      else if (type === 'bot') {
        game.botChampions.push(data);
        if (game.botChampions.length > 50) game.botChampions.pop();
        localStorage.setItem('pongBotChampions', JSON.stringify(game.botChampions));
      }
      
      updateLeaderboards();
    }

    // Setup functions
    function resizeCanvas() {
      // Set canvas to full window size
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      
      // Calculate dynamic sizes based on canvas dimensions
      game.paddleWidth = Math.max(10, canvas.width * 0.015);
      game.paddleHeight = canvas.height * PADDLE_HEIGHT_RATIO;
      game.fourPlayerPaddleHeight = canvas.height * FOUR_PLAYER_PADDLE_HEIGHT_RATIO;
      game.ballRadius = Math.max(5, canvas.width * BALL_RADIUS_RATIO);
      
      // Reset game elements if game is already started
      if (game.gameStarted) {
        resetBall();
        resetPaddles();
      }
    }

    function setupMobileControls() {
      const upBtnLeft = document.getElementById('upBtnLeft');
      const downBtnLeft = document.getElementById('downBtnLeft');
      const upBtnRight = document.getElementById('upBtnRight');
      const downBtnRight = document.getElementById('downBtnRight');
      
      // Touch events
      const handleTouch = (btn, direction, isLeft) => (e) => {
        e.preventDefault();
        if (isLeft) {
          game.mobileControls.leftUp = direction === 'up';
          game.mobileControls.leftDown = direction === 'down';
        } else {
          game.mobileControls.rightUp = direction === 'up';
          game.mobileControls.rightDown = direction === 'down';
        }
      };
      
      upBtnLeft.addEventListener('touchstart', handleTouch(upBtnLeft, 'up', true));
      upBtnLeft.addEventListener('touchend', handleTouch(upBtnLeft, 'none', true));
      downBtnLeft.addEventListener('touchstart', handleTouch(downBtnLeft, 'down', true));
      downBtnLeft.addEventListener('touchend', handleTouch(downBtnLeft, 'none', true));
      upBtnRight.addEventListener('touchstart', handleTouch(upBtnRight, 'up', false));
      upBtnRight.addEventListener('touchend', handleTouch(upBtnRight, 'none', false));
      downBtnRight.addEventListener('touchstart', handleTouch(downBtnRight, 'down', false));
      downBtnRight.addEventListener('touchend', handleTouch(downBtnRight, 'none', false));
      
      // Mouse events for desktop testing
      upBtnLeft.addEventListener('mousedown', () => game.mobileControls.leftUp = true);
      upBtnLeft.addEventListener('mouseup', () => game.mobileControls.leftUp = false);
      downBtnLeft.addEventListener('mousedown', () => game.mobileControls.leftDown = true);
      downBtnLeft.addEventListener('mouseup', () => game.mobileControls.leftDown = false);
      upBtnRight.addEventListener('mousedown', () => game.mobileControls.rightUp = true);
      upBtnRight.addEventListener('mouseup', () => game.mobileControls.rightUp = false);
      downBtnRight.addEventListener('mousedown', () => game.mobileControls.rightDown = true);
      downBtnRight.addEventListener('mouseup', () => game.mobileControls.rightDown = false);
      
      // Show mobile controls on mobile devices
      if (/Mobi|Android/i.test(navigator.userAgent)) {
        document.getElementById('mobileControls').style.display = 'flex';
      }
    }

    function setupKeyboardControls() {
      // Handle both keydown and keypress events for better iPad compatibility
      document.addEventListener('keydown', handleKeyEvent);
      document.addEventListener('keypress', handleKeyEvent);
    }

    function handleKeyEvent(e) {
      switch(e.key) {
        case 'p':
        case 'P':
          togglePause();
          break;
        case 'm':
        case 'M':
          toggleMute();
          break;
        case 'f':
        case 'F':
          toggleFullscreen();
          break;
        case 'w':
        case 'W':
          game.keysPressed['w'] = true;
          break;
        case 's':
        case 'S':
          game.keysPressed['s'] = true;
          break;
        case 'ArrowUp':
          game.keysPressed['ArrowUp'] = true;
          break;
        case 'ArrowDown':
          game.keysPressed['ArrowDown'] = true;
          break;
        case 'q':
        case 'Q':
          game.keysPressed['q'] = true;
          break;
        case 'a':
        case 'A':
          game.keysPressed['a'] = true;
          break;
        case 'o':
        case 'O':
          game.keysPressed['o'] = true;
          break;
        case 'l':
        case 'L':
          game.keysPressed['l'] = true;
          break;
        case 'e':
        case 'E':
          if (!game.leftCharged && game.leftCharge >= 100) {
            activateLeftPowerShot();
          }
          break;
        case 'm':
        case 'M':
          if (!game.rightCharged && game.rightCharge >= 100) {
            activateRightPowerShot();
          }
          break;
      }
    }

    document.addEventListener('keyup', (e) => {
      switch(e.key) {
        case 'w':
        case 'W':
          game.keysPressed['w'] = false;
          break;
        case 's':
        case 'S':
          game.keysPressed['s'] = false;
          break;
        case 'ArrowUp':
          game.keysPressed['ArrowUp'] = false;
          break;
        case 'ArrowDown':
          game.keysPressed['ArrowDown'] = false;
          break;
        case 'q':
        case 'Q':
          game.keysPressed['q'] = false;
          break;
        case 'a':
        case 'A':
          game.keysPressed['a'] = false;
          break;
        case 'o':
        case 'O':
          game.keysPressed['o'] = false;
          break;
        case 'l':
        case 'L':
          game.keysPressed['l'] = false;
          break;
      }
    });

    function setupControlButtons() {
      document.getElementById('muteButton').addEventListener('click', toggleMute);
      document.getElementById('pauseButton').addEventListener('click', togglePause);
      document.getElementById('fullscreenButton').addEventListener('click', toggleFullscreen);
      document.getElementById('musicMuteButton').addEventListener('click', toggleMusicMute);
    }

    function loadAudioFiles() {
      // Preload sound effects
      paddleSound.src = 'paddle.wav';
      scoreSound.src = 'score.mp3';
      scoreSound1.src = 'score1.mp3';
      scoreSound2.src = 'score2.mp3';
      hitSound.src = 'hit.mp3';
      hitSound1.src = 'hit1.mp3';
      hitSound2.src = 'hit2.mp3';
      hitSound3.src = 'hit3.mp3';
      hitSound4.src = 'hit4.mp3';
      etSound.src = 'et.mp3';
      gameOverSound.src = 'gameover.mp3';
      gameOverSound1.src = 'gameover1.mp3';
      selectSound.src = 'select.mp3';
      startSound.src = 'start.mp3';
      startSound1.src = 'start1.mp3';
      startSound2.src = 'start2.mp3';
      startSound3.src = 'start3.mp3';
    }

    function playRandomStartMusic() {
      const startTracks = [startSound, startSound1, startSound2, startSound3];
      const randomTrack = startTracks[Math.floor(Math.random() * startTracks.length)];
      
      randomTrack.currentTime = 0;
      randomTrack.volume = 0.5;
      randomTrack.play().catch(e => console.log("Audio play error:", e));
      
      randomTrack.onended = function() {
        playRandomMusic();
      };
    }

    function playRandomMusic() {
      if (game.isMusicMuted || !game.musicStarted) return;
      
      const randomTrack = 'music' + (Math.floor(Math.random() * 4) + 1 + '.mp3';
      backgroundMusic.src = randomTrack;
      backgroundMusic.volume = 0.3;
      backgroundMusic.play().catch(e => console.log("Audio play error:", e));
      
      // When music ends, play another random track
      backgroundMusic.onended = function() {
        playRandomMusic();
      };
    }

    function playRandomScoreSound() {
      if (game.isMuted) return;
      
      const sounds = [scoreSound, scoreSound1, scoreSound2];
      const randomSound = sounds[Math.floor(Math.random() * sounds.length)];
      randomSound.currentTime = 0;
      randomSound.play().catch(e => console.log("Audio play error:", e));
    }

    function playRandomHitSound() {
      if (game.isMuted) return;
      
      const sounds = [hitSound, hitSound1, hitSound2, hitSound3, hitSound4];
      const randomSound = sounds[Math.floor(Math.random() * sounds.length)];
      randomSound.currentTime = 0;
      randomSound.play().catch(e => console.log("Audio play error:", e));
    }

    function playGameOverSound() {
      if (game.isMuted) return;
      
      const sounds = [gameOverSound, gameOverSound1];
      const randomSound = sounds[Math.floor(Math.random() * sounds.length)];
      randomSound.currentTime = 0;
      randomSound.volume = 0.5;
      randomSound.play().catch(e => console.log("Audio play error:", e));
    }

    function playETSound() {
      if (game.isMuted) return;
      
      etSound.currentTime = 0;
      etSound.volume = 0.5;
      etSound.play().catch(e => console.log("Audio play error:", e));
    }

    // Game control functions
    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => {
          console.log(`Fullscreen error: ${err.message}`);
        });
      } else {
        if (document.exitFullscreen) {
          document.exitFullscreen();
        }
      }
    }

    // Game logic functions
    function resetBall() {
      game.ball.x = canvas.width / 2;
      game.ball.y = canvas.height / 2;
      game.ball.speed = game.isFourPlayer ? FOUR_PLAYER_BALL_SPEED : INITIAL_BALL_SPEED;
      game.ball.originalSpeed = game.ball.speed;
      game.ball.dx = Math.random() > 0.5 ? game.ball.speed * 0.6 : -game.ball.speed * 0.6;
      game.ball.dy = (Math.random() * 2 - 1) * game.ball.speed * 0.6;
      
      // Reset smash counter
      game.smashCounter = 0;
      game.smashTarget = Math.floor(Math.random() * 5) + 3; // 3-7 hits
    }

    function resetPaddles() {
      const paddleHeight = game.isFourPlayer ? game.fourPlayerPaddleHeight : game.paddleHeight;
      const centerY = (canvas.height - paddleHeight) / 2;
      
      game.leftPaddle.y = centerY;
      game.rightPaddle.y = centerY;
      
      if (game.isFourPlayer) {
        game.leftTopPaddle.y = canvas.height * 0.25 - paddleHeight/2;
        game.leftBottomPaddle.y = canvas.height * 0.75 - paddleHeight/2;
        game.rightTopPaddle.y = canvas.height * 0.25 - paddleHeight/2;
        game.rightBottomPaddle.y = canvas.height * 0.75 - paddleHeight/2;
      }
    }

    function constrainPaddles() {
      const paddleHeight = game.isFourPlayer ? game.fourPlayerPaddleHeight : game.paddleHeight;
      
      if (!game.isFourPlayer) {
        game.leftPaddle.y = Math.max(0, Math.min(canvas.height - paddleHeight, game.leftPaddle.y));
        game.rightPaddle.y = Math.max(0, Math.min(canvas.height - paddleHeight, game.rightPaddle.y));
      } else {
        game.leftTopPaddle.y = Math.max(0, Math.min(canvas.height - paddleHeight, game.leftTopPaddle.y));
        game.leftBottomPaddle.y = Math.max(0, Math.min(canvas.height - paddleHeight, game.leftBottomPaddle.y));
        game.rightTopPaddle.y = Math.max(0, Math.min(canvas.height - paddleHeight, game.rightTopPaddle.y));
        game.rightBottomPaddle.y = Math.max(0, Math.min(canvas.height - paddleHeight, game.rightBottomPaddle.y));
      }
    }

    function startLeftCharge() {
      if (game.leftChargeInterval) clearInterval(game.leftChargeInterval);
      
      game.leftCharge = 0;
      document.getElementById('leftCharge').style.width = '0';
      document.getElementById('leftCharge').classList.remove('active');
      
      game.leftChargeInterval = setInterval(() => {
        game.leftCharge += 100 / (CHARGE_TIME / 100);
        document.getElementById('leftCharge').style.width = `${game.leftCharge}%`;
        
        if (game.leftCharge >= 100) {
          clearInterval(game.leftChargeInterval);
          document.getElementById('leftCharge').classList.add('active');
        }
      }, 100);
    }

    function startRightCharge() {
      if (game.rightChargeInterval) clearInterval(game.rightChargeInterval);
      
      game.rightCharge = 0;
      document.getElementById('rightCharge').style.width = '0';
      document.getElementById('rightCharge').classList.remove('active');
      
      game.rightChargeInterval = setInterval(() => {
        game.rightCharge += 100 / (CHARGE_TIME / 100);
        document.getElementById('rightCharge').style.width = `${game.rightCharge}%`;
        
        if (game.rightCharge >= 100) {
          clearInterval(game.rightChargeInterval);
          document.getElementById('rightCharge').classList.add('active');
        }
      }, 100);
    }

    function activateLeftPowerShot() {
      game.leftCharged = true;
      game.leftChargeEndTime = Date.now() + POWER_SHOT_DURATION;
      document.getElementById('leftCharge').classList.add('active');
      
      setTimeout(() => {
        if (Date.now() > game.leftChargeEndTime) {
          game.leftCharged = false;
          document.getElementById('leftCharge').classList.remove('active');
          startLeftCharge();
        }
      }, POWER_SHOT_DURATION);
    }

    function activateRightPowerShot() {
      game.rightCharged = true;
      game.rightChargeEndTime = Date.now() + POWER_SHOT_DURATION;
      document.getElementById('rightCharge').classList.add('active');
      
      setTimeout(() => {
        if (Date.now() > game.rightChargeEndTime) {
          game.rightCharged = false;
          document.getElementById('rightCharge').classList.remove('active');
          startRightCharge();
        }
      }, POWER_SHOT_DURATION);
    }

    function createFireTrail(x, y) {
      const fire = document.createElement('div');
      fire.className = 'fire-trail';
      fire.style.left = (x - 10) + 'px';
      fire.style.top = (y - 10) + 'px';
      document.getElementById('gameContainer').appendChild(fire);
      
      // Random size and animation
      const size = Math.random() * 15 + 10;
      fire.style.width = size + 'px';
      fire.style.height = size + 'px';
      fire.style.animation = `fadeOut ${Math.random() * 0.5 + 0.3}s forwards`;
      
      // Remove after animation
      setTimeout(() => {
        fire.remove();
      }, 1000);
      
      // Add to game state for tracking
      game.fireTrails.push({
        element: fire,
        createdAt: Date.now()
      });
    }

    // Drawing functions
    function drawPaddles() {
      ctx.fillStyle = 'white';
      const paddleHeight = game.isFourPlayer ? game.fourPlayerPaddleHeight : game.paddleHeight;
      
      if (!game.isFourPlayer) {
        // Left paddle
        if (game.leftCharged) {
          ctx.fillStyle = 'gold';
        }
        ctx.fillRect(20, game.leftPaddle.y, game.paddleWidth, paddleHeight);
        
        // Right paddle
        ctx.fillStyle = 'white';
        if (game.rightCharged) {
          ctx.fillStyle = 'gold';
        }
        ctx.fillRect(canvas.width - 20 - game.paddleWidth, game.rightPaddle.y, game.paddleWidth, paddleHeight);
      } else {
        ctx.fillStyle = 'white';
        ctx.fillRect(20, game.leftTopPaddle.y, game.paddleWidth, paddleHeight);
        ctx.fillRect(20, game.leftBottomPaddle.y, game.paddleWidth, paddleHeight);
        ctx.fillRect(canvas.width - 20 - game.paddleWidth, game.rightTopPaddle.y, game.paddleWidth, paddleHeight);
        ctx.fillRect(canvas.width - 20 - game.paddleWidth, game.rightBottomPaddle.y, game.paddleWidth, paddleHeight);
      }
    }

    function drawBall() {
      // Draw fire trails for smash shots
      if (game.isSmashActive || game.last10Seconds) {
        createFireTrail(game.ball.x, game.ball.y);
      }
      
      ctx.beginPath();
      ctx.arc(game.ball.x, game.ball.y, game.ballRadius, 0, Math.PI * 2);
      
      // Change ball color during smash or last 10 seconds
      if (game.isSmashActive || game.last10Seconds) {
        const gradient = ctx.createRadialGradient(
          game.ball.x, game.ball.y, 0,
          game.ball.x, game.ball.y, game.ballRadius
        );
        gradient.addColorStop(0, 'yellow');
        gradient.addColorStop(0.5, 'orange');
        gradient.addColorStop(1, 'red');
        ctx.fillStyle = gradient;
      } else {
        ctx.fillStyle = 'white';
      }
      
      ctx.fill();
    }

    function drawNet() {
      ctx.setLineDash([10, 15]);
      ctx.beginPath();
      ctx.moveTo(canvas.width / 2, 0);
      ctx.lineTo(canvas.width / 2, canvas.height);
      ctx.strokeStyle = 'rgba(255,255,255,0.5)';
      ctx.lineWidth = 2;
      ctx.stroke();
      ctx.setLineDash([]);
    }

    // Game loop functions
    function gameLoop() {
      if (!game.gameStarted || game.isPaused || game.halftimeActive) {
        requestAnimationFrame(gameLoop);
        return;
      }

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      drawPaddles();
      drawBall();
      drawNet();

      updateBall();
      updatePaddles();
      checkCollisions();
      checkSmash();

      requestAnimationFrame(gameLoop);
    }

    function updateBall() {
      if (game.isPaused || game.halftimeActive) return;
      
      // Prevent ball from getting stuck at edges
      if (game.ball.y - game.ballRadius <= 0) {
        game.ball.y = game.ballRadius + 1;
        game.ball.dy = Math.abs(game.ball.dy);
      }
      
      if (game.ball.y + game.ballRadius >= canvas.height) {
        game.ball.y = canvas.height - game.ballRadius - 1;
        game.ball.dy = -Math.abs(game.ball.dy);
      }
      
      game.ball.x += game.ball.dx;
      game.ball.y += game.ball.dy;

      // Ball collision with top and bottom
      if (game.ball.y - game.ballRadius < 0 || game.ball.y + game.ballRadius > canvas.height) {
        game.ball.dy = -game.ball.dy;
      }
    }

    function updatePaddles() {
      if (game.isPaused || game.halftimeActive) return;

      // Mobile controls
      if (game.mobileControls.leftUp) game.leftPaddle.y -= PADDLE_SPEED;
      if (game.mobileControls.leftDown) game.leftPaddle.y += PADDLE_SPEED;
      if (game.mobileControls.rightUp) game.rightPaddle.y -= PADDLE_SPEED;
      if (game.mobileControls.rightDown) game.rightPaddle.y += PADDLE_SPEED;

      // Keyboard controls
      if (!game.isFourPlayer) {
        if (game.isLocalMultiplayer) {
          if (game.keysPressed['w'] || game.keysPressed['W']) game.leftPaddle.y -= PADDLE_SPEED;
          if (game.keysPressed['s'] || game.keysPressed['S']) game.leftPaddle.y += PADDLE_SPEED;
          if (game.keysPressed['ArrowUp']) game.rightPaddle.y -= PADDLE_SPEED;
          if (game.keysPressed['ArrowDown']) game.rightPaddle.y += PADDLE_SPEED;
        } else {
          // AI for right paddle in single player
          if (game.keysPressed['w'] || game.keysPressed['W']) game.leftPaddle.y -= PADDLE_SPEED;
          if (game.keysPressed['s'] || game.keysPressed['S']) game.leftPaddle.y += PADDLE_SPEED;
          
          // Improved AI for right paddle
          const paddleCenter = game.rightPaddle.y + game.paddleHeight / 2;
          const predictedBallY = game.ball.y + (game.ball.dy * (canvas.width - game.ball.x) / Math.abs(game.ball.dx));
          
          // Add some randomness to make AI less perfect
          const reactionSpeed = 0.7 * (1 + Math.random() * 0.2 - 0.1);
          
          if (paddleCenter < predictedBallY - 15) {
            game.rightPaddle.y += PADDLE_SPEED * reactionSpeed;
          } else if (paddleCenter > predictedBallY + 15) {
            game.rightPaddle.y -= PADDLE_SPEED * reactionSpeed;
          }
        }
      } else {
        // 4-player controls
        if (game.keysPressed['w'] || game.keysPressed['W']) game.leftTopPaddle.y -= PADDLE_SPEED;
        if (game.keysPressed['s'] || game.keysPressed['S']) game.leftTopPaddle.y += PADDLE_SPEED;
        if (game.keysPressed['q'] || game.keysPressed['Q']) game.leftBottomPaddle.y -= PADDLE_SPEED;
        if (game.keysPressed['a'] || game.keysPressed['A']) game.leftBottomPaddle.y += PADDLE_SPEED;
        if (game.keysPressed['o'] || game.keysPressed['O']) game.rightTopPaddle.y -= PADDLE_SPEED;
        if (game.keysPressed['l'] || game.keysPressed['L']) game.rightTopPaddle.y += PADDLE_SPEED;
        if (game.keysPressed['ArrowUp']) game.rightBottomPaddle.y -= PADDLE_SPEED;
        if (game.keysPressed['ArrowDown']) game.rightBottomPaddle.y += PADDLE_SPEED;
      }
      
      constrainPaddles();
    }

    function checkCollisions() {
      if (game.isPaused || game.halftimeActive) return;
      
      const paddleHeight = game.isFourPlayer ? game.fourPlayerPaddleHeight : game.paddleHeight;

      // Ball collision with paddles
      if (!game.isFourPlayer) {
        // Left paddle collision
        if (game.ball.x - game.ballRadius < 20 + game.paddleWidth &&
            game.ball.y > game.leftPaddle.y &&
            game.ball.y < game.leftPaddle.y + paddleHeight) {
          const angle = getBallAngle(game.leftPaddle.y, game.ball.y, paddleHeight);
          
          // Check for power shot
          if (game.leftCharged || game.last10Seconds) {
            game.ball.dx = Math.abs(Math.cos(angle)) * game.ball.speed * SMASH_SPEED_MULTIPLIER;
            game.ball.dy = Math.sin(angle) * game.ball.speed * SMASH_SPEED_MULTIPLIER;
            game.isSmashActive = true;
            game.smashEndTime = Date.now() + SMASH_DURATION;
            game.leftCharged = false;
            document.getElementById('leftCharge').classList.remove('active');
            startLeftCharge();
            queueCommentary("POWER SHOT FROM " + game.leftPlayer + "!", true);
          } else {
            game.ball.dx = Math.abs(Math.cos(angle)) * game.ball.speed;
            game.ball.dy = Math.sin(angle) * game.ball.speed;
          }
          
          // Increase ball speed but cap at MAX_BALL_SPEED
          if (game.ball.speed < MAX_BALL_SPEED) {
            game.ball.speed += BALL_SPEED_INCREMENT;
            game.ball.originalSpeed = game.ball.speed;
          }
          
          game.lastScorer = game.leftPlayer;
          playRandomHitSound();
        }
        
        // Right paddle collision
        if (game.ball.x + game.ballRadius > canvas.width - 20 - game.paddleWidth &&
            game.ball.y > game.rightPaddle.y &&
            game.ball.y < game.rightPaddle.y + paddleHeight) {
          const angle = getBallAngle(game.rightPaddle.y, game.ball.y, paddleHeight);
          
          // Check for power shot
          if (game.rightCharged || game.last10Seconds) {
            game.ball.dx = -Math.abs(Math.cos(angle)) * game.ball.speed * SMASH_SPEED_MULTIPLIER;
            game.ball.dy = Math.sin(angle) * game.ball.speed * SMASH_SPEED_MULTIPLIER;
            game.isSmashActive = true;
            game.smashEndTime = Date.now() + SMASH_DURATION;
            game.rightCharged = false;
            document.getElementById('rightCharge').classList.remove('active');
            startRightCharge();
            queueCommentary("POWER SHOT FROM " + game.rightPlayer + "!", true);
          } else {
            game.ball.dx = -Math.abs(Math.cos(angle)) * game.ball.speed;
            game.ball.dy = Math.sin(angle) * game.ball.speed;
          }
          
          // Increase ball speed but cap at MAX_BALL_SPEED
          if (game.ball.speed < MAX_BALL_SPEED) {
            game.ball.speed += BALL_SPEED_INCREMENT;
            game.ball.originalSpeed = game.ball.speed;
          }
          
          game.lastScorer = game.rightPlayer;
          playRandomHitSound();
        }
      } else {
        // 4-player paddle collisions
        // Left side paddles
        if (game.ball.x - game.ballRadius < 20 + game.paddleWidth) {
          if ((game.ball.y > game.leftTopPaddle.y && game.ball.y < game.leftTopPaddle.y + paddleHeight) ||
              (game.ball.y > game.leftBottomPaddle.y && game.ball.y < game.leftBottomPaddle.y + paddleHeight)) {
            const paddle = game.ball.y < canvas.height/2 ? game.leftTopPaddle : game.leftBottomPaddle;
            const angle = getBallAngle(paddle.y, game.ball.y, paddleHeight);
            game.ball.dx = Math.abs(Math.cos(angle)) * game.ball.speed;
            game.ball.dy = Math.sin(angle) * game.ball.speed;
            
            // Increase ball speed but cap at MAX_BALL_SPEED
            if (game.ball.speed < MAX_BALL_SPEED) {
              game.ball.speed += BALL_SPEED_INCREMENT;
              game.ball.originalSpeed = game.ball.speed;
            }
            
            game.lastScorer = game.leftPlayer;
            playRandomHitSound();
          }
        }
        
        // Right side paddles
        if (game.ball.x + game.ballRadius > canvas.width - 20 - game.paddleWidth) {
          if ((game.ball.y > game.rightTopPaddle.y && game.ball.y < game.rightTopPaddle.y + paddleHeight) ||
              (game.ball.y > game.rightBottomPaddle.y && game.ball.y < game.rightBottomPaddle.y + paddleHeight)) {
            const paddle = game.ball.y < canvas.height/2 ? game.rightTopPaddle : game.rightBottomPaddle;
            const angle = getBallAngle(paddle.y, game.ball.y, paddleHeight);
            game.ball.dx = -Math.abs(Math.cos(angle)) * game.ball.speed;
            game.ball.dy = Math.sin(angle) * game.ball.speed;
            
            // Increase ball speed but cap at MAX_BALL_SPEED
            if (game.ball.speed < MAX_BALL_SPEED) {
              game.ball.speed += BALL_SPEED_INCREMENT;
              game.ball.originalSpeed = game.ball.speed;
            }
            
            game.lastScorer = game.rightPlayer;
            playRandomHitSound();
          }
        }
      }
      
      // Ball out of bounds - scoring
      if (game.ball.x - game.ballRadius < 0) {
        game.rightPaddle.score++;
        document.getElementById('rightScore').textContent = game.rightPaddle.score;
        game.lastScorer = game.rightPlayer;
        handleScore();
      }

      if (game.ball.x + game.ballRadius > canvas.width) {
        game.leftPaddle.score++;
        document.getElementById('leftScore').textContent = game.leftPaddle.score;
        game.lastScorer = game.leftPlayer;
        handleScore();
      }

      // Deuce (tie) situation
      if (game.leftPaddle.score >= 5 && game.rightPaddle.score >= 5 && 
          game.leftPaddle.score === game.rightPaddle.score && !game.deuceActive) {
        game.deuceActive = true;
        game.bonusPoints++;
        document.getElementById('bonusPoints').textContent = `‚ö° BONUS POINT: +${game.bonusPoints}`;
        queueCommentary("WE'RE AT DEUCE! BONUS POINT ACTIVATED! NEXT POINT WINS!", true, true);
      } else if (game.leftPaddle.score !== game.rightPaddle.score) {
        game.deuceActive = false;
      }
    }

    function checkSmash() {
      if (game.isSmashActive && Date.now() > game.smashEndTime) {
        game.isSmashActive = false;
        
        // Return to original speed but maintain direction
        const angle = Math.atan2(game.ball.dy, game.ball.dx);
        game.ball.speed = game.ball.originalSpeed;
        game.ball.dx = Math.cos(angle) * game.ball.speed;
        game.ball.dy = Math.sin(angle) * game.ball.speed;
      }
    }

    function getBallAngle(paddleY, hitY, paddleHeight) {
      const relativeY = (hitY - paddleY) / paddleHeight;
      const normalizedY = (relativeY * 2) - 1;
      return normalizedY * Math.PI / 3;
    }

    function handleScore() {
      const winningThreshold = WINNING_SCORE + game.bonusPoints;

      if (game.betweenPointsTimeout) {
        clearTimeout(game.betweenPointsTimeout);
        game.betweenPointsTimeout = null;
      }

      // Play random score sound
      playRandomScoreSound();

      if (checkForSpecialMove()) {
        queueCommentary("OH MY GOODNESS! WHAT AN INCREDIBLE SHOT!", true, true);
      }
      else if ((game.leftPaddle.score === winningThreshold - 1 || 
               game.rightPaddle.score === winningThreshold - 1) && !game.matchPoint) {
        game.matchPoint = true;
        const leader = game.leftPaddle.score > game.rightPaddle.score ? game.leftPlayer : game.rightPlayer;
        queueCommentary(`THIS IS IT! CHAMPIONSHIP POINT FOR ${leader}!`, true, true);
      }
      else {
        queueCommentary(`${game.lastScorer} SCORES! ${getRandomCommentary()}`, true);
      }

      if (game.leftPaddle.score >= winningThreshold || game.rightPaddle.score >= winningThreshold) {
        endGame();
        return;
      }

      if (Math.random() < 0.3) {
        game.betweenPointsTimeout = setTimeout(() => {
          queueCommentary(getRandomCommentary());
        }, 1500);
      }

      resetBall();
    }

    function getRandomCommentary() {
      return commentaryPhrases[Math.floor(Math.random() * commentaryPhrases.length)];
    }

    function checkForSpecialMove() {
      const speedThreshold = game.isFourPlayer ? FOUR_PLAYER_BALL_SPEED * 1.8 : MAX_BALL_SPEED * 0.9;
      const now = Date.now();
      
      if (game.ball.speed >= speedThreshold && now - game.lastSpecialMoveTime > 5000) {
        game.lastSpecialMoveTime = now;
        return true;
      }
      return false;
    }

    // Game management functions
    function startTwoPlayerGame() {
      document.getElementById('twoPlayerPrompt').style.display = 'flex';
      document.getElementById('leftPlayerName').focus();
    }

    function submitTwoPlayerNames() {
      const leftName = document.getElementById('leftPlayerName').value.trim() || "PLAYER 1";
      const rightName = document.getElementById('rightPlayerName').value.trim() || "PLAYER 2";
      const stage = document.getElementById('selectedStage').value;
      
      game.leftPlayer = leftName.toUpperCase();
      game.rightPlayer = rightName.toUpperCase();
      game.tournamentStage = stage;
      game.isLocalMultiplayer = true;
      game.isFourPlayer = false;
      
      document.getElementById('twoPlayerPrompt').style.display = 'none';
      startGame();
    }

    function startSinglePlayerGame() {
      document.getElementById('singlePlayerPrompt').style.display = 'flex';
      document.getElementById('playerName').focus();
    }

    function submitSinglePlayerName() {
      const playerName = document.getElementById('playerName').value.trim() || "PLAYER";
      
      game.leftPlayer = playerName.toUpperCase();
      game.rightPlayer = "BOT";
      game.isLocalMultiplayer = false;
      game.isFourPlayer = false;
      
      document.getElementById('singlePlayerPrompt').style.display = 'none';
      startGame();
    }

    function startFourPlayerGame() {
      document.getElementById('fourPlayerPrompt').style.display = 'flex';
      document.getElementById('leftTeamName').focus();
    }

    function submitFourPlayerNames() {
      const leftName = document.getElementById('leftTeamName').value.trim() || "TEAM ONE";
      const rightName = document.getElementById('rightTeamName').value.trim() || "TEAM TWO";
      
      game.leftPlayer = leftName.toUpperCase();
      game.rightPlayer = rightName.toUpperCase();
      game.isLocalMultiplayer = true;
      game.isFourPlayer = true;
      
      document.getElementById('fourPlayerPrompt').style.display = 'none';
      document.getElementById('mobileControls').style.display = 'none';
      startGame();
    }

    function startGame() {
      game.isPaused = false;
      game.leftPaddle.score = 0;
      game.rightPaddle.score = 0;
      game.remainingTime = HALF_TIME;
      game.currentHalf = 1;
      game.extraTime = 0;
      game.matchPoint = false;
      game.bonusPoints = 0;
      game.deuceActive = false;
      game.commentaryQueue = [];
      game.hasAnnounced30 = false;
      game.hasAnnounced10 = false;
      game.last10Seconds = false;
      game.countdownNumbers = [];
      
      // Reset charge bars
      game.leftCharge = 0;
      game.rightCharge = 0;
      game.leftCharged = false;
      game.rightCharged = false;
      document.getElementById('leftCharge').style.width = '0';
      document.getElementById('rightCharge').style.width = '0';
      document.getElementById('leftCharge').classList.remove('active');
      document.getElementById('rightCharge').classList.remove('active');
      
      // Start charging
      startLeftCharge();
      startRightCharge();
      
      // Show game elements
      document.getElementById('leftScore').style.display = "block";
      document.getElementById('rightScore').style.display = "block";
      document.getElementById('timer').style.display = "block";
      document.getElementById('bonusPoints').style.display = "block";
      document.getElementById('matchInfo').style.display = "block";
      
      // Hide menu screens
      document.getElementById('titleScreen').style.display = "none";
      document.getElementById('endScreen').style.display = "none";
      document.getElementById('pauseScreen').style.display = "none";
      document.getElementById('gameOverScreen').style.display = "none";
      
      document.getElementById('leftScore').textContent = "0";
      document.getElementById('rightScore').textContent = "0";
      document.getElementById('timer').textContent = "1:30.000";
      document.getElementById('bonusPoints').textContent = "";
      document.getElementById('matchInfo').textContent = "1st Half | Extra Time: +0s";
      
      resetBall();
      resetPaddles();
      
      queueCommentary(`THE CHAMPIONSHIP MATCH BEGINS! ${game.leftPlayer} VS ${game.rightPlayer}!`, true, true);
      
      startCountdown();
    }

    function startCountdown() {
      let count = 3;
      document.getElementById('countdown').style.display = "flex";
      document.getElementById('goText').style.display = "none";
      game.countdownActive = true;
      
      function updateCountdown() {
        if (count > 0) {
          document.getElementById('countdown').textContent = count;
          if (!game.isMuted) {
            const utterance = new SpeechSynthesisUtterance(count.toString());
            utterance.rate = 0.8;
            utterance.pitch = 1.3;
            window.speechSynthesis.speak(utterance);
          }
          count--;
        } else if (count === 0) {
          document.getElementById('countdown').style.display = "none";
          document.getElementById('goText').style.display = "flex";
          if (!game.isMuted) {
            const utterance = new SpeechSynthesisUtterance("GO!");
            utterance.rate = 0.7;
            utterance.pitch = 1.5;
            window.speechSynthesis.speak(utterance);
          }
          count--;
        } else {
          clearInterval(game.countdownInterval);
          document.getElementById('goText').style.display = "none";
          game.gameStarted = true;
          game.startTime = Date.now();
          game.countdownActive = false;
          
          startTimer();
        }
      }
      
      updateCountdown();
      game.countdownInterval = setInterval(updateCountdown, 1000);
    }

    function startTimer() {
      if (game.timerInterval) clearInterval(game.timerInterval);
      
      game.hasAnnounced30 = false;
      game.hasAnnounced10 = false;
      game.last10Seconds = false;
      game.startTime = Date.now();
      
      game.timerInterval = setInterval(() => {
        if (game.isPaused || game.halftimeActive) return;
        
        const elapsed = Date.now() - game.startTime;
        const remaining = Math.max(0, game.remainingTime * 1000 - elapsed + (game.extraTime * 1000));
        
        const minutes = Math.floor(remaining / 60000);
        const seconds = Math.floor((remaining % 60000) / 1000);
        const milliseconds = remaining % 1000;
        
        document.getElementById('timer').textContent = 
          `${minutes}:${seconds < 10 ? '0' : ''}${seconds}.${milliseconds < 100 ? (milliseconds < 10 ? '00' : '0') : ''}${milliseconds}`;
        
        // Update match info
        const halfText = game.currentHalf === 1 ? '1st Half' : (game.extraTime > 0 ? 'ET' : '2nd Half');
        document.getElementById('matchInfo').innerHTML = `
          ${halfText} | Extra Time: +${game.extraTime}s
        `;
        
        if (remaining <= 30000 && !game.hasAnnounced30) {
          game.hasAnnounced30 = true;
          queueCommentary(`ONLY 30 SECONDS REMAINING IN THE ${game.currentHalf === 1 ? '1ST' : '2ND'} HALF!`, true, true);
        }
        
        if (remaining <= 10000 && !game.hasAnnounced10) {
          game.hasAnnounced10 = true;
          queueCommentary(`FINAL COUNTDOWN! 10 SECONDS IN THE ${game.currentHalf === 1 ? '1ST' : '2ND'} HALF!`, true, true);
        }
        
        // Last 10 seconds countdown
        if (remaining <= 10000 && !game.last10Seconds) {
          game.last10Seconds = true;
          startFinalCountdown();
        }
        
        if (remaining <= 0) {
          if (game.currentHalf === 1) {
            startHalftime();
          } else {
            handleTimeExpired();
          }
        }
      }, 10);
    }

    function startFinalCountdown() {
      if (game.countdownNumbers.length > 0) return;
      
      // Clear any existing countdown
      game.countdownNumbers = [10, 9, 8, 7, 6, 5, 4, 3, 2, 1, "FINISH!"];
      
      // Make all shots power shots in last 10 seconds
      game.leftCharged = true;
      game.rightCharged = true;
      document.getElementById('leftCharge').classList.add('active');
      document.getElementById('rightCharge').classList.add('active');
      
      // Start announcing numbers
      announceCountdownNumber();
    }

    function announceCountdownNumber() {
      if (game.countdownNumbers.length === 0 || !game.last10Seconds) return;
      
      const number = game.countdownNumbers.shift();
      queueCommentary(number.toString(), true, true);
      
      if (game.countdownNumbers.length > 0) {
        setTimeout(announceCountdownNumber, 1000);
      }
    }

    function startHalftime() {
      clearInterval(game.timerInterval);
      game.halftimeActive = true;
      game.last10Seconds = false;
      document.getElementById('halftimeScreen').style.display = "flex";
      document.getElementById('halftimeScreen').textContent = "HALFTIME";
      
      // Reset ball position
      resetBall();
      
      // Show halftime stats
      queueCommentary(`HALFTIME! SCORE IS ${game.leftPaddle.score}-${game.rightPaddle.score}`, true, true);
      
      // Start halftime countdown
      let halftimeCount = HALF_TIME_BREAK;
      game.halftimeInterval = setInterval(() => {
        document.getElementById('halftimeScreen').textContent = `HALFTIME\n${halftimeCount}`;
        halftimeCount--;
        
        if (halftimeCount < 0) {
          clearInterval(game.halftimeInterval);
          document.getElementById('halftimeScreen').style.display = "none";
          game.halftimeActive = false;
          game.currentHalf = 2;
          game.remainingTime = HALF_TIME;
          game.hasAnnounced30 = false;
          game.hasAnnounced10 = false;
          game.startTime = Date.now();
          startTimer();
          queueCommentary("SECOND HALF BEGINS!", true, true);
        }
      }, 1000);
    }

    function handleTimeExpired() {
      if (game.leftPaddle.score === game.rightPaddle.score) {
        game.remainingTime = OVERTIME_TIME;
        game.extraTime += OVERTIME_TIME;
        game.hasAnnounced30 = false;
        game.hasAnnounced10 = false;
        game.last10Seconds = false;
        game.countdownNumbers = [];
        if (!game.deuceActive) {
          game.bonusPoints++;
          document.getElementById('bonusPoints').textContent = `‚ö° BONUS POINT: +${game.bonusPoints}`;
        }
        playETSound();
        queueCommentary("WE'RE GOING TO OVERTIME! NEXT POINT WINS!", true, true);
        startTimer();
      } else {
        endGame();
      }
    }

    function queueCommentary(text, important = false, force = false) {
      if (force) {
        window.speechSynthesis.cancel();
        game.commentaryQueue = [];
        game.isSpeaking = false;
      }
      
      // Always add to queue, but skip unimportant ones if there are many
      if (important || game.commentaryQueue.length < 3) {
        game.commentaryQueue.push({text, important});
      }
      
      if (!game.isSpeaking || force) {
        speakNextCommentary();
      }
      
      // Update commentary display
      document.getElementById('commentary').textContent = text;
    }

    function speakNextCommentary() {
      if (game.commentaryQueue.length > 0 && !game.isSpeaking && !game.isMuted) {
        const {text, important} = game.commentaryQueue.shift();
        announceCommentary(text, important);
      }
    }

    function announceCommentary(text, important = false) {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.rate = 0.9;
      utterance.pitch = 1.2;
      utterance.volume = important ? 1.0 : 0.8;
      
      utterance.onend = () => {
        game.isSpeaking = false;
        speakNextCommentary();
      };
      
      if (game.currentUtterance) {
        window.speechSynthesis.cancel();
      }
      
      window.speechSynthesis.speak(utterance);
      game.currentUtterance = utterance;
      game.isSpeaking = true;
    }

    function createConfetti() {
      const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff', '#ffffff'];
      
      for (let i = 0; i < 100; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = Math.random() * 100 + 'vw';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.animation = `confetti-fall ${Math.random() * 3 + 2}s linear forwards`;
        confetti.style.animationDelay = Math.random() * 0.5 + 's';
        
        const size = Math.random() * 10 + 5;
        confetti.style.width = size + 'px';
        confetti.style.height = size + 'px';
        
        if (Math.random() > 0.5) {
          confetti.style.borderRadius = '50%';
        } else {
          confetti.style.borderRadius = '0';
        }
        
        document.body.appendChild(confetti);
        
        setTimeout(() => {
          confetti.remove();
        }, 5000);
      }
    }

    function endGame() {
      game.gameStarted = false;
      clearInterval(game.timerInterval);
      
      let winner, loser, winnerScore, loserScore;
      if (game.leftPaddle.score > game.rightPaddle.score) {
        winner = game.leftPlayer;
        loser = game.rightPlayer;
        winnerScore = game.leftPaddle.score;
        loserScore = game.rightPaddle.score;
      } else {
        winner = game.rightPlayer;
        loser = game.leftPlayer;
        winnerScore = game.rightPaddle.score;
        loserScore = game.leftPaddle.score;
      }
      
      // Check if player lost to bot
      if (!game.isLocalMultiplayer && winner === "BOT") {
        showGameOver();
        return;
      }
      
      document.getElementById('endMessage').textContent = `${winner} WINS ${winnerScore}-${loserScore}! üèÜ`;
      document.getElementById('endScreen').style.display = "flex";
      
      // Hide game elements
      document.getElementById('leftScore').style.display = "none";
      document.getElementById('rightScore').style.display = "none";
      document.getElementById('timer').style.display = "none";
      document.getElementById('bonusPoints').style.display = "none";
      document.getElementById('matchInfo').style.display = "none";
      
      createConfetti();
      
      // Stop music at the end of the match
      backgroundMusic.pause();
      
      // Save to leaderboards
      if (game.isLocalMultiplayer && !game.isFourPlayer) {
        // Save to Recent Plays
        saveToLeaderboard('recent', {
          player1: game.leftPlayer,
          player2: game.rightPlayer,
          score1: game.leftPaddle.score,
          score2: game.rightPaddle.score,
          stage: game.tournamentStage,
          timestamp: Date.now()
        });
        
        // Save to Best Wins if score difference is significant
        if (Math.abs(game.leftPaddle.score - game.rightPaddle.score) >= 3) {
          saveToLeaderboard('best', {
            player1: winner,
            player2: loser,
            score1: winnerScore,
            score2: loserScore,
            stage: game.tournamentStage,
            timestamp: Date.now()
          });
        }
      } else if (!game.isLocalMultiplayer) {
        // Save to Bot Champions
        saveToLeaderboard('bot', {
          player1: game.leftPlayer,
          score1: game.leftPaddle.score,
          score2: game.rightPaddle.score,
          timestamp: Date.now()
        });
      }
      
      queueCommentary(`${winner} defeats ${loser} ${winnerScore}-${loserScore}!`, true, true);
      queueCommentary(`WHAT A PERFORMANCE! ${winner} IS THE PONG CHAMPION!`, true);
      queueCommentary("What an incredible championship match we've witnessed today!", true);
    }

    function showGameOver() {
      game.gameStarted = false;
      clearInterval(game.timerInterval);
      
      document.getElementById('gameOverScreen').style.display = "flex";
      document.getElementById('leftScore').style.display = "none";
      document.getElementById('rightScore').style.display = "none";
      document.getElementById('timer').style.display = "none";
      document.getElementById('bonusPoints').style.display = "none";
      document.getElementById('matchInfo').style.display = "none";
      
      // Stop music and play game over sound
      backgroundMusic.pause();
      playGameOverSound();
      
      // Save to Bot Champions
      saveToLeaderboard('bot', {
        player1: game.leftPlayer,
        score1: game.leftPaddle.score,
        score2: game.rightPaddle.score,
        timestamp: Date.now()
      });
      
      queueCommentary("GAME OVER! YOU LOST TO THE BOT!", true, true);
      
      // Return to menu after delay
      setTimeout(() => {
        returnToMenu();
      }, 5000);
    }

    function toggleMute() {
      game.isMuted = !game.isMuted;
      document.getElementById('muteButton').textContent = game.isMuted ? "üîá" : "üîä";
      window.speechSynthesis.cancel();
      
      if (game.isMuted) {
        queueCommentary("Commentary muted", true, true);
      } else {
        queueCommentary("Commentary unmuted", true, true);
      }
    }

    function toggleMusicMute() {
      game.isMusicMuted = !game.isMusicMuted;
      document.getElementById('musicMuteButton').textContent = game.isMusicMuted ? "üîá" : "üéµ";
      
      if (game.isMusicMuted) {
        backgroundMusic.pause();
        queueCommentary("Music muted", true, true);
      } else {
        if (game.musicStarted && game.gameStarted) {
          backgroundMusic.play().catch(e => console.log("Audio play error:", e));
        }
        queueCommentary("Music unmuted", true, true);
      }
    }

    function togglePause() {
      game.isPaused = !game.isPaused;
      document.getElementById('pauseScreen').style.display = game.isPaused ? "flex" : "none";
      
      if (game.isPaused) {
        game.pausedTime = Date.now();
        backgroundMusic.pause();
        queueCommentary("GAME PAUSED", true, true);
      } else {
        const pauseDuration = Date.now() - game.pausedTime;
        game.startTime += pauseDuration;
        if (!game.isMusicMuted && game.musicStarted && game.gameStarted) {
          backgroundMusic.play().catch(e => console.log("Audio play error:", e));
        }
        queueCommentary("GAME RESUMED", true, true);
      }
    }

    function returnToMenu() {
      game.isPaused = false;
      game.halftimeActive = false;
      document.getElementById('pauseScreen').style.display = "none";
      document.getElementById('endScreen').style.display = "none";
      document.getElementById('halftimeScreen').style.display = "none";
      document.getElementById('gameOverScreen').style.display = "none";
      document.getElementById('titleScreen').style.display = "flex";
      clearInterval(game.timerInterval);
      clearInterval(game.halftimeInterval);
      clearInterval(game.leftChargeInterval);
      clearInterval(game.rightChargeInterval);
      game.gameStarted = false;
      game.isLocalMultiplayer = false;
      game.isFourPlayer = false;
      game.last10Seconds = false;
      game.countdownNumbers = [];
      
      // Hide game elements
      document.getElementById('leftScore').style.display = "none";
      document.getElementById('rightScore').style.display = "none";
      document.getElementById('timer').style.display = "none";
      document.getElementById('bonusPoints').style.display = "none";
      document.getElementById('matchInfo').style.display = "none";
      
      // Reset mobile controls
      game.mobileControls = {
        leftUp: false,
        leftDown: false,
        rightUp: false,
        rightDown: false
      };
      
      // Show mobile controls if on mobile
      if (/Mobi|Android/i.test(navigator.userAgent)) {
        document.getElementById('mobileControls').style.display = 'flex';
      }
      
      // Start music again if not muted
      if (!game.isMusicMuted && game.musicStarted) {
        playRandomMusic();
      }
      
      queueCommentary("RETURNING TO MENU", true, true);
    }

    // Initialize the game when the DOM is loaded
    document.addEventListener('DOMContentLoaded', initGame);
  </script>
</body>
</html>
