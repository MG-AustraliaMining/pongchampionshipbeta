<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>üèÜ PONG CHAMPIONSHIP üèÜ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root {
      --paddle-width: 15px;
      --ball-radius: 8px;
      --paddle-speed: 10;
      --initial-ball-speed: 6;
      --four-player-ball-speed: 8;
    }
    
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #000;
      font-family: 'Arial', sans-serif;
      touch-action: manipulation;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      height: 100vh;
      width: 100vw;
    }
    
    #gameContainer {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
    }
    
    canvas {
      background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
      display: block;
      touch-action: none;
      width: 100%;
      height: 100%;
      border-radius: 0;
    }
    
    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    .score {
      position: absolute;
      top: 20px;
      font-size: 2rem;
      color: white;
      text-shadow: 0 0 10px rgba(255,255,255,0.7);
      z-index: 30;
      font-weight: bold;
    }
    
    #leftScore { left: 25%; }
    #rightScore { right: 25%; }
    
    #timer {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 1.5rem;
      color: white;
      z-index: 30;
      font-weight: bold;
    }
    
    #bonusPoints {
      position: absolute;
      top: 60px;
      left: 50%;
      transform: translateX(-50%);
      color: gold;
      font-size: 1rem;
      text-shadow: 1px 1px 2px black;
      z-index: 30;
      font-weight: bold;
    }
    
    #commentary {
      position: absolute;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      max-width: 90%;
      text-align: center;
      font-size: 1rem;
      z-index: 30;
      font-weight: bold;
      border: 2px solid gold;
      box-shadow: 0 0 15px rgba(255,215,0,0.5);
      transition: all 0.3s;
    }
    
    .screen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 100;
    }
    
    .screen h1 {
      font-size: 2.5rem;
      color: gold;
      text-shadow: 0 0 10px rgba(255,215,0,0.7);
      margin-bottom: 1.5rem;
      text-align: center;
    }
    
    .btn-championship {
      background: linear-gradient(45deg, #ff8a00, #e52e71);
      border: none;
      font-size: 1.2rem;
      padding: 10px 25px;
      margin: 10px;
      border-radius: 50px;
      color: white;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      transition: all 0.3s;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .btn-championship:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 20px rgba(0,0,0,0.4);
    }
    
    .control-btn {
      position: absolute;
      z-index: 40;
      background: rgba(255,255,255,0.2);
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      color: white;
      font-size: 1rem;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: all 0.2s;
    }
    
    .control-btn:hover {
      background: rgba(255,255,255,0.3);
    }
    
    .control-btn:active {
      transform: scale(0.9);
    }
    
    #muteButton { top: 10px; left: 10px; }
    #pauseButton { top: 10px; left: 60px; }
    #fullscreenButton { top: 10px; left: 110px; }
    #dpadToggle { top: 10px; right: 10px; }
    #musicMuteButton { top: 10px; right: 60px; }
    
    #pauseScreen, #countdown {
      display: none;
    }
    
    #mobileControls {
      position: absolute;
      bottom: 20px;
      width: 100%;
      display: flex;
      justify-content: space-between;
      padding: 0 20px;
      z-index: 20;
    }
    
    .mobile-paddle-controls {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .mobile-btn {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: rgba(255,255,255,0.3);
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
      font-size: 1.5rem;
      user-select: none;
      touch-action: manipulation;
    }
    
    .mobile-btn:active {
      background: rgba(255,255,255,0.5);
    }
    
    .confetti {
      position: absolute;
      width: 8px;
      height: 8px;
      background-color: #f00;
      border-radius: 50%;
      pointer-events: none;
      z-index: 100;
    }
    
    @keyframes confetti-fall {
      0% { transform: translateY(-100px) rotate(0deg); }
      100% { transform: translateY(100vh) rotate(360deg); }
    }
    
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 300;
    }
    
    .modal-content {
      background: linear-gradient(135deg, #1a2a6c, #b21f1f);
      padding: 30px;
      border-radius: 20px;
      text-align: center;
      max-width: 90%;
      width: 400px;
      box-shadow: 0 0 30px rgba(0,0,0,0.5);
      border: 3px solid gold;
    }
    
    .modal-title {
      color: gold;
      font-size: 1.8rem;
      margin-bottom: 20px;
      text-shadow: 0 0 10px rgba(255,215,0,0.7);
    }
    
    .modal-input {
      width: 100%;
      padding: 12px;
      margin-bottom: 20px;
      border-radius: 10px;
      border: 2px solid gold;
      font-size: 1.2rem;
      text-align: center;
      background: rgba(0,0,0,0.7);
      color: white;
    }
    
    .modal-btn {
      padding: 10px 25px;
      margin: 0 10px;
      border-radius: 50px;
      border: none;
      background: gold;
      color: #000;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .modal-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 0 15px rgba(255,215,0,0.7);
    }
    
    /* Power-up styles */
    .power-up {
      position: absolute;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      z-index: 20;
      animation: float 2s ease-in-out infinite;
      display: none;
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    
    .power-up-effect {
      position: absolute;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 25;
    }
    
    #powerUpBar {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: 80%;
      height: 10px;
      background: rgba(255,255,255,0.2);
      border-radius: 5px;
      overflow: hidden;
      display: none;
    }
    
    #powerUpProgress {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #ff00ff, #00ffff);
      transition: width 0.1s linear;
    }
    
    #countdown {
      font-size: 8rem;
      font-weight: bold;
      color: gold;
      text-shadow: 0 0 20px rgba(255,215,0,0.8);
      animation: pulse 0.5s infinite alternate;
    }
    
    @keyframes pulse {
      from { transform: scale(1); opacity: 1; }
      to { transform: scale(1.2); opacity: 0.8; }
    }
    
    #goText {
      font-size: 8rem;
      font-weight: bold;
      color: gold;
      text-shadow: 0 0 20px rgba(255,215,0,0.8);
      animation: goPulse 0.3s infinite alternate, fadeOut 1s 1s forwards;
      display: none;
    }
    
    @keyframes goPulse {
      from { transform: scale(1); text-shadow: 0 0 20px rgba(255,215,0,0.8); }
      to { transform: scale(1.3); text-shadow: 0 0 40px rgba(255,215,0,1); }
    }
    
    @keyframes fadeOut {
      to { opacity: 0; }
    }
    
    @media (max-width: 768px) {
      .score { 
        font-size: 1.8rem; 
        top: 15px; 
      }
      #leftScore { left: 20%; }
      #rightScore { right: 20%; }
      #timer { font-size: 1.2rem; top: 15px; }
      #bonusPoints { font-size: 0.9rem; top: 50px; }
      #commentary { font-size: 0.9rem; padding: 5px 10px; bottom: 80px; }
      .btn-championship { font-size: 1rem; padding: 8px 20px; }
      .control-btn {
        width: 35px;
        height: 35px;
        font-size: 0.9rem;
      }
      #muteButton { left: 5px; }
      #pauseButton { left: 45px; }
      #fullscreenButton { left: 85px; }
      #dpadToggle { right: 5px; }
      #musicMuteButton { right: 45px; }
      .mobile-btn {
        width: 60px;
        height: 60px;
        font-size: 1.3rem;
      }
      .modal-content {
        width: 90%;
        padding: 20px;
      }
      .modal-title {
        font-size: 1.5rem;
      }
      #countdown, #goText {
        font-size: 5rem;
      }
    }
    
    @media (max-height: 500px) {
      .screen h1 { font-size: 1.5rem; }
      .btn-championship { font-size: 0.8rem; padding: 6px 15px; }
      #mobileControls { bottom: 10px; }
      .mobile-btn { width: 50px; height: 50px; font-size: 1.3rem; }
      #commentary { bottom: 60px; }
      #countdown, #goText {
        font-size: 3rem;
      }
    }
  </style>
</head>
<body>
  <div id="gameContainer">
    <canvas id="pongCanvas"></canvas>
    
    <div id="leftScore" class="score">0</div>
    <div id="rightScore" class="score">0</div>
    <div id="timer">2:00.000</div>
    <div id="bonusPoints"></div>
    <div id="commentary">WELCOME TO THE PONG CHAMPIONSHIP!</div>
    
    <button id="muteButton" class="control-btn">üîä</button>
    <button id="pauseButton" class="control-btn">‚è∏Ô∏è</button>
    <button id="fullscreenButton" class="control-btn">‚õ∂</button>
    <button id="dpadToggle" class="control-btn" title="Toggle Controls">üéÆ</button>
    <button id="musicMuteButton" class="control-btn">üéµ</button>
    
    <div id="mobileControls" style="display: none;">
      <div class="mobile-paddle-controls">
        <div class="mobile-btn" id="upBtnLeft">‚Üë</div>
        <div class="mobile-btn" id="downBtnLeft">‚Üì</div>
      </div>
      <div class="mobile-paddle-controls">
        <div class="mobile-btn" id="upBtnRight">‚Üë</div>
        <div class="mobile-btn" id="downBtnRight">‚Üì</div>
      </div>
    </div>

    <div id="countdown" class="screen"></div>
    <div id="goText" class="screen">GO!</div>

    <div id="pauseScreen" class="screen">
      <h1>GAME PAUSED</h1>
      <button class="btn-championship" onclick="togglePause()">RESUME</button>
      <button class="btn-championship" onclick="returnToMenu()">RETURN TO MENU</button>
    </div>

    <div id="titleScreen" class="screen">
      <h1>üèÜ PONG CHAMPIONSHIP üèÜ</h1>
      <button class="btn-championship" onclick="startLocalMultiplayer()">2 PLAYERS</button>
      <button class="btn-championship" onclick="showNamePrompt(false)">1 PLAYER VS BOT</button>
      <button class="btn-championship" onclick="showNamePrompt(true)">4 PLAYERS</button>
    </div>

    <div id="endScreen" class="screen" style="display: none;">
      <h1 id="endMessage" style="color: gold; font-size: 1.5rem;"></h1>
      <button class="btn-championship" id="endScreenBtn" onclick="returnToMenu()">RETURN TO MENU</button>
    </div>

    <!-- Power-up elements -->
    <div id="powerUp1" class="power-up"></div>
    <div id="powerUp2" class="power-up"></div>
    <div id="powerUp3" class="power-up"></div>
    
    <!-- Power-up effect elements -->
    <div id="powerUpEffect" class="power-up-effect"></div>
    
    <!-- Power-up duration bar -->
    <div id="powerUpBar">
      <div id="powerUpProgress"></div>
    </div>
  </div>

  <div id="namePrompt" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-title">ENTER TEAM NAMES</div>
      <input type="text" id="leftPlayerName" class="modal-input" placeholder="Left Team Name" maxlength="20">
      <input type="text" id="rightPlayerName" class="modal-input" placeholder="Right Team Name" maxlength="20">
      <button class="modal-btn" onclick="submitNames()">START GAME</button>
    </div>
  </div>

  <audio id="backgroundMusic" loop></audio>
  <audio id="paddleSound"></audio>
  <audio id="scoreSound"></audio>
  <audio id="powerUpSound"></audio>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Game Constants
    const PADDLE_HEIGHT_RATIO = 0.2;
    const FOUR_PLAYER_PADDLE_HEIGHT_RATIO = 0.15;
    const BALL_RADIUS_RATIO = 0.015;
    const INITIAL_BALL_SPEED = 8;
    const FOUR_PLAYER_BALL_SPEED = 6;
    const PADDLE_SPEED = 10;
    const WINNING_SCORE = 10;
    const GAME_TIME = 120;
    const OVERTIME_TIME = 15;
    
    // Power-up types
    const POWER_UP_TYPES = {
      WIDE_PADDLE: { 
        name: 'WIDE PADDLE', 
        color: '#00ff00', 
        duration: 10000,
        apply: function(paddle) {
          paddle.originalWidth = game.paddleWidth;
          game.paddleWidth = game.paddleWidth * 2;
        },
        remove: function(paddle) {
          game.paddleWidth = paddle.originalWidth;
        }
      },
      FAST_BALL: { 
        name: 'FAST BALL', 
        color: '#ff0000', 
        duration: 8000,
        apply: function() {
          game.ball.originalSpeed = game.ball.speed;
          game.ball.speed = game.ball.speed * 1.8;
          game.ball.dx = game.ball.dx > 0 ? game.ball.speed : -game.ball.speed;
          game.ball.dy = game.ball.dy > 0 ? game.ball.speed * (Math.abs(game.ball.dy)/game.ball.speed) : 
                                           -game.ball.speed * (Math.abs(game.ball.dy)/game.ball.speed);
        },
        remove: function() {
          game.ball.speed = game.ball.originalSpeed;
          game.ball.dx = game.ball.dx > 0 ? game.ball.speed : -game.ball.speed;
          game.ball.dy = game.ball.dy > 0 ? game.ball.speed * (Math.abs(game.ball.dy)/game.ball.speed) : 
                                           -game.ball.speed * (Math.abs(game.ball.dy)/game.ball.speed);
        }
      },
      MULTI_BALL: { 
        name: 'MULTI BALL', 
        color: '#ffff00', 
        duration: 12000,
        apply: function() {
          // Create extra balls
          for (let i = 0; i < 2; i++) {
            const extraBall = {
              x: canvas.width / 2,
              y: canvas.height / 2,
              dx: Math.random() > 0.5 ? game.ball.speed : -game.ball.speed,
              dy: (Math.random() * 2 - 1) * game.ball.speed,
              speed: game.ball.speed,
              radius: game.ballRadius
            };
            game.extraBalls.push(extraBall);
          }
        },
        remove: function() {
          game.extraBalls = [];
        }
      },
      SLOW_PADDLE: { 
        name: 'SLOW PADDLE', 
        color: '#0000ff', 
        duration: 10000,
        target: 'opponent',
        apply: function(paddle) {
          paddle.originalSpeed = PADDLE_SPEED;
          PADDLE_SPEED = PADDLE_SPEED * 0.5;
        },
        remove: function(paddle) {
          PADDLE_SPEED = paddle.originalSpeed;
        }
      }
    };
    
    // Game Elements
    const canvas = document.getElementById('pongCanvas');
    const ctx = canvas.getContext('2d');
    
    // Audio Elements
    const backgroundMusic = document.getElementById('backgroundMusic');
    const paddleSound = document.getElementById('paddleSound');
    const scoreSound = document.getElementById('scoreSound');
    const powerUpSound = document.getElementById('powerUpSound');
    
    // Music tracks
    const MUSIC_TRACKS = [
      'music2.mp3',
      'music3.mp3',
      'music4.mp3',
      'music5.mp3',
      'music6.mp3',
      'music7.mp3',
      'music8.mp3',
      'music9.mp3'
    ];
    
    // Game State
    const game = {
      ball: { x: 0, y: 0, dx: 0, dy: 0, speed: INITIAL_BALL_SPEED, originalSpeed: INITIAL_BALL_SPEED },
      leftPaddle: { y: 0, score: 0 },
      rightPaddle: { y: 0, score: 0 },
      leftTopPaddle: { y: 0 },
      leftBottomPaddle: { y: 0 },
      rightTopPaddle: { y: 0 },
      rightBottomPaddle: { y: 0 },
      isFourPlayer: false,
      isMuted: false,
      isMusicMuted: false,
      isPaused: false,
      gameStarted: false,
      remainingTime: GAME_TIME,
      lastScorer: null,
      matchPoint: false,
      leftPlayer: "TEAM ONE",
      rightPlayer: "TEAM TWO",
      timerInterval: null,
      countdownInterval: null,
      keysPressed: {},
      bonusPoints: 0,
      deuceActive: false,
      startTime: 0,
      pausedTime: 0,
      commentaryQueue: [],
      isSpeaking: false,
      hasAnnounced30: false,
      hasAnnounced10: false,
      currentUtterance: null,
      lastSpecialMoveTime: 0,
      betweenPointsTimeout: null,
      mobileControls: {
        leftUp: false,
        leftDown: false,
        rightUp: false,
        rightDown: false
      },
      dpadEnabled: false,
      isLocalMultiplayer: false,
      paddleWidth: 0,
      paddleHeight: 0,
      fourPlayerPaddleHeight: 0,
      ballRadius: 0,
      extraBalls: [],
      powerUps: [],
      activePowerUps: [],
      lastPowerUpTime: 0,
      powerUpSpawnInterval: 15000,
      currentMusicTrack: null
    };

    // Commentary phrases
    const commentaryPhrases = [
      "What a shot!",
      "Incredible reflexes!",
      "The crowd is going wild!",
      "This is championship-level play!",
      "Unbelievable!",
      "Did you see that?!",
      "The tension is palpable!",
      "What a rally!",
      "This match is heating up!",
      "A masterclass in pong!",
      "The players are giving it their all!",
      "This is pong at its finest!",
      "The stakes couldn't be higher!",
      "What a display of skill!",
      "The championship is on the line!",
      "This is what we came to see!"
    ];

    // Power-up commentary
    const powerUpCommentary = [
      "Power-up activated! Game changer!",
      "Special ability unlocked!",
      "Whoa! That's a game changer!",
      "The game just got more interesting!",
      "Power-up in play! Things are heating up!",
      "That's going to shake things up!",
      "Special move! This could turn the tide!"
    ];

    // Initialize Game
    function initGame() {
      resizeCanvas();
      window.addEventListener('resize', resizeCanvas);
      setupMobileControls();
      setupKeyboardControls();
      setupControlButtons();
      loadAudioFiles();
      
      // Start the game loop
      gameLoop();
    }

    // Setup functions
    function resizeCanvas() {
      // Set canvas to full window size
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      
      // Calculate dynamic sizes based on canvas dimensions
      game.paddleWidth = Math.max(10, canvas.width * 0.015);
      game.paddleHeight = canvas.height * PADDLE_HEIGHT_RATIO;
      game.fourPlayerPaddleHeight = canvas.height * FOUR_PLAYER_PADDLE_HEIGHT_RATIO;
      game.ballRadius = Math.max(6, canvas.width * BALL_RADIUS_RATIO);
      
      // Reset game elements if game is already started
      if (game.gameStarted) {
        resetBall();
        resetPaddles();
      }
    }

    function setupMobileControls() {
      const upBtnLeft = document.getElementById('upBtnLeft');
      const downBtnLeft = document.getElementById('downBtnLeft');
      const upBtnRight = document.getElementById('upBtnRight');
      const downBtnRight = document.getElementById('downBtnRight');
      
      // Touch events
      const handleTouch = (btn, direction, isLeft) => (e) => {
        e.preventDefault();
        if (isLeft) {
          game.mobileControls.leftUp = direction === 'up';
          game.mobileControls.leftDown = direction === 'down';
        } else {
          game.mobileControls.rightUp = direction === 'up';
          game.mobileControls.rightDown = direction === 'down';
        }
      };
      
      upBtnLeft.addEventListener('touchstart', handleTouch(upBtnLeft, 'up', true));
      upBtnLeft.addEventListener('touchend', handleTouch(upBtnLeft, 'none', true));
      downBtnLeft.addEventListener('touchstart', handleTouch(downBtnLeft, 'down', true));
      downBtnLeft.addEventListener('touchend', handleTouch(downBtnLeft, 'none', true));
      upBtnRight.addEventListener('touchstart', handleTouch(upBtnRight, 'up', false));
      upBtnRight.addEventListener('touchend', handleTouch(upBtnRight, 'none', false));
      downBtnRight.addEventListener('touchstart', handleTouch(downBtnRight, 'down', false));
      downBtnRight.addEventListener('touchend', handleTouch(downBtnRight, 'none', false));
      
      // Mouse events for desktop testing
      upBtnLeft.addEventListener('mousedown', () => game.mobileControls.leftUp = true);
      upBtnLeft.addEventListener('mouseup', () => game.mobileControls.leftUp = false);
      downBtnLeft.addEventListener('mousedown', () => game.mobileControls.leftDown = true);
      downBtnLeft.addEventListener('mouseup', () => game.mobileControls.leftDown = false);
      upBtnRight.addEventListener('mousedown', () => game.mobileControls.rightUp = true);
      upBtnRight.addEventListener('mouseup', () => game.mobileControls.rightUp = false);
      downBtnRight.addEventListener('mousedown', () => game.mobileControls.rightDown = true);
      downBtnRight.addEventListener('mouseup', () => game.mobileControls.rightDown = false);
      
      // Show mobile controls on mobile devices
      if (/Mobi|Android/i.test(navigator.userAgent)) {
        document.getElementById('mobileControls').style.display = 'flex';
      }
    }

    function setupKeyboardControls() {
      document.addEventListener('keydown', (e) => {
        switch(e.key) {
          case 'p':
          case 'P':
            togglePause();
            break;
          case 'm':
          case 'M':
            toggleMute();
            break;
          case 'f':
          case 'F':
            toggleFullscreen();
            break;
          case 'w':
          case 'W':
            game.keysPressed['w'] = true;
            break;
          case 's':
          case 'S':
            game.keysPressed['s'] = true;
            break;
          case 'ArrowUp':
            game.keysPressed['ArrowUp'] = true;
            break;
          case 'ArrowDown':
            game.keysPressed['ArrowDown'] = true;
            break;
          case 'q':
          case 'Q':
            game.keysPressed['q'] = true;
            break;
          case 'a':
          case 'A':
            game.keysPressed['a'] = true;
            break;
          case 'o':
          case 'O':
            game.keysPressed['o'] = true;
            break;
          case 'l':
          case 'L':
            game.keysPressed['l'] = true;
            break;
        }
      });

      document.addEventListener('keyup', (e) => {
        switch(e.key) {
          case 'w':
          case 'W':
            game.keysPressed['w'] = false;
            break;
          case 's':
          case 'S':
            game.keysPressed['s'] = false;
            break;
          case 'ArrowUp':
            game.keysPressed['ArrowUp'] = false;
            break;
          case 'ArrowDown':
            game.keysPressed['ArrowDown'] = false;
            break;
          case 'q':
          case 'Q':
            game.keysPressed['q'] = false;
            break;
          case 'a':
          case 'A':
            game.keysPressed['a'] = false;
            break;
          case 'o':
          case 'O':
            game.keysPressed['o'] = false;
            break;
          case 'l':
          case 'L':
            game.keysPressed['l'] = false;
            break;
        }
      });
    }

    function setupControlButtons() {
      document.getElementById('muteButton').addEventListener('click', toggleMute);
      document.getElementById('pauseButton').addEventListener('click', togglePause);
      document.getElementById('fullscreenButton').addEventListener('click', toggleFullscreen);
      document.getElementById('dpadToggle').addEventListener('click', toggleMobileControls);
      document.getElementById('musicMuteButton').addEventListener('click', toggleMusicMute);
    }

    function loadAudioFiles() {
      // Preload sound effects
      paddleSound.src = 'paddle.wav';
      scoreSound.src = 'score.wav';
      powerUpSound.src = 'powerup.wav';
      
      // Load random music track
      playRandomMusic();
    }

    function playRandomMusic() {
      if (game.isMusicMuted) return;
      
      const randomTrack = MUSIC_TRACKS[Math.floor(Math.random() * MUSIC_TRACKS.length)];
      backgroundMusic.src = randomTrack;
      backgroundMusic.volume = 0.3;
      backgroundMusic.play().catch(e => console.log("Audio play error:", e));
      
      // When music ends, play another random track
      backgroundMusic.onended = function() {
        playRandomMusic();
      };
    }

    // Game control functions
    function toggleMobileControls() {
      const mobileControls = document.getElementById('mobileControls');
      game.dpadEnabled = !game.dpadEnabled;
      mobileControls.style.display = game.dpadEnabled ? 'flex' : 'none';
      document.getElementById('dpadToggle').textContent = game.dpadEnabled ? 'üïπÔ∏è' : 'üéÆ';
    }

    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => {
          console.log(`Fullscreen error: ${err.message}`);
        });
      } else {
        if (document.exitFullscreen) {
          document.exitFullscreen();
        }
      }
    }

    // Game logic functions
    function resetBall() {
      game.ball.x = canvas.width / 2;
      game.ball.y = canvas.height / 2;
      game.ball.speed = game.isFourPlayer ? FOUR_PLAYER_BALL_SPEED : INITIAL_BALL_SPEED;
      game.ball.dx = Math.random() > 0.5 ? game.ball.speed * 0.5 : -game.ball.speed * 0.5; // Start slower after score
      game.ball.dy = (Math.random() * 2 - 1) * game.ball.speed * 0.5;
      
      // Reset speed to normal after first hit
      setTimeout(() => {
        game.ball.speed = game.isFourPlayer ? FOUR_PLAYER_BALL_SPEED : INITIAL_BALL_SPEED;
      }, 1000);
    }

    function resetPaddles() {
      const paddleHeight = game.isFourPlayer ? game.fourPlayerPaddleHeight : game.paddleHeight;
      const centerY = (canvas.height - paddleHeight) / 2;
      
      game.leftPaddle.y = centerY;
      game.rightPaddle.y = centerY;
      
      if (game.isFourPlayer) {
        game.leftTopPaddle.y = canvas.height * 0.25 - paddleHeight/2;
        game.leftBottomPaddle.y = canvas.height * 0.75 - paddleHeight/2;
        game.rightTopPaddle.y = canvas.height * 0.25 - paddleHeight/2;
        game.rightBottomPaddle.y = canvas.height * 0.75 - paddleHeight/2;
      }
    }

    function constrainPaddles() {
      const paddleHeight = game.isFourPlayer ? game.fourPlayerPaddleHeight : game.paddleHeight;
      
      if (!game.isFourPlayer) {
        game.leftPaddle.y = Math.max(0, Math.min(canvas.height - paddleHeight, game.leftPaddle.y));
        game.rightPaddle.y = Math.max(0, Math.min(canvas.height - paddleHeight, game.rightPaddle.y));
      } else {
        game.leftTopPaddle.y = Math.max(0, Math.min(canvas.height - paddleHeight, game.leftTopPaddle.y));
        game.leftBottomPaddle.y = Math.max(0, Math.min(canvas.height - paddleHeight, game.leftBottomPaddle.y));
        game.rightTopPaddle.y = Math.max(0, Math.min(canvas.height - paddleHeight, game.rightTopPaddle.y));
        game.rightBottomPaddle.y = Math.max(0, Math.min(canvas.height - paddleHeight, game.rightBottomPaddle.y));
      }
    }

    // Power-up functions
    function spawnPowerUp() {
      if (!game.gameStarted || game.isPaused || Date.now() - game.lastPowerUpTime < game.powerUpSpawnInterval) {
        return;
      }
      
      // Don't spawn if there are already 3 power-ups on screen
      if (game.powerUps.length >= 3) {
        return;
      }
      
      const powerUpTypes = Object.values(POWER_UP_TYPES);
      const randomType = powerUpTypes[Math.floor(Math.random() * powerUpTypes.length)];
      
      const powerUp = {
        x: Math.random() * (canvas.width - 100) + 50,
        y: Math.random() * (canvas.height - 100) + 50,
        type: randomType,
        element: document.getElementById(`powerUp${game.powerUps.length + 1}`),
        collected: false
      };
      
      // Style the power-up element
      powerUp.element.style.left = `${powerUp.x - 15}px`;
      powerUp.element.style.top = `${powerUp.y - 15}px`;
      powerUp.element.style.backgroundColor = randomType.color;
      powerUp.element.style.display = 'block';
      powerUp.element.style.boxShadow = `0 0 15px ${randomType.color}`;
      
      game.powerUps.push(powerUp);
      game.lastPowerUpTime = Date.now();
    }

    function checkPowerUpCollisions() {
      for (let i = 0; i < game.powerUps.length; i++) {
        const powerUp = game.powerUps[i];
        
        // Check if ball collides with power-up
        const dx = game.ball.x - powerUp.x;
        const dy = game.ball.y - powerUp.y;
        const distance = Math.sqrt(dx * dx + dy * dy);
        
        if (distance < game.ballRadius + 15 && !powerUp.collected) {
          collectPowerUp(powerUp, i);
        }
      }
    }

    function collectPowerUp(powerUp, index) {
      powerUp.collected = true;
      powerUp.element.style.display = 'none';
      
      // Play power-up sound
      if (!game.isMuted) {
        powerUpSound.play().catch(e => console.log("Audio play error:", e));
      }
      
      // Apply power-up effect
      const powerUpEffect = {
        type: powerUp.type,
        startTime: Date.now(),
        endTime: Date.now() + powerUp.type.duration,
        target: game.ball.x < canvas.width / 2 ? 'left' : 'right'
      };
      
      game.activePowerUps.push(powerUpEffect);
      
      // Show power-up bar
      document.getElementById('powerUpBar').style.display = 'block';
      
      // Apply the power-up effect
      applyPowerUpEffect(powerUpEffect);
      
      // Remove from power-ups array
      game.powerUps.splice(index, 1);
      
      // Queue commentary
      queueCommentary(`${powerUpEffect.target === 'left' ? game.leftPlayer : game.rightPlayer} GOT ${powerUp.type.name}! ${powerUpCommentary[Math.floor(Math.random() * powerUpCommentary.length)]}`, true);
    }

    function applyPowerUpEffect(powerUpEffect) {
      const paddle = powerUpEffect.target === 'left' ? game.leftPaddle : game.rightPaddle;
      powerUpEffect.type.apply(paddle);
    }

    function removePowerUpEffect(powerUpEffect) {
      const paddle = powerUpEffect.target === 'left' ? game.leftPaddle : game.rightPaddle;
      powerUpEffect.type.remove(paddle);
    }

    function updatePowerUps() {
      const now = Date.now();
      
      // Spawn new power-ups
      if (now - game.lastPowerUpTime > game.powerUpSpawnInterval) {
        spawnPowerUp();
      }
      
      // Update active power-ups
      for (let i = 0; i < game.activePowerUps.length; i++) {
        const powerUp = game.activePowerUps[i];
        
        // Update power-up bar
        if (i === 0) { // Only show the first power-up in the bar
          const remaining = powerUp.endTime - now;
          const progress = (remaining / powerUp.type.duration) * 100;
          document.getElementById('powerUpProgress').style.width = `${progress}%`;
          document.getElementById('powerUpProgress').style.background = powerUp.type.color;
        }
        
        // Remove expired power-ups
        if (now >= powerUp.endTime) {
          removePowerUpEffect(powerUp);
          game.activePowerUps.splice(i, 1);
          i--;
          
          // Hide power-up bar if no more active power-ups
          if (game.activePowerUps.length === 0) {
            document.getElementById('powerUpBar').style.display = 'none';
          }
        }
      }
    }

    // Drawing functions
    function drawPaddles() {
      ctx.fillStyle = 'white';
      const paddleHeight = game.isFourPlayer ? game.fourPlayerPaddleHeight : game.paddleHeight;
      
      if (!game.isFourPlayer) {
        ctx.fillRect(20, game.leftPaddle.y, game.paddleWidth, paddleHeight);
        ctx.fillRect(canvas.width - 20 - game.paddleWidth, game.rightPaddle.y, game.paddleWidth, paddleHeight);
      } else {
        ctx.fillRect(20, game.leftTopPaddle.y, game.paddleWidth, paddleHeight);
        ctx.fillRect(20, game.leftBottomPaddle.y, game.paddleWidth, paddleHeight);
        ctx.fillRect(canvas.width - 20 - game.paddleWidth, game.rightTopPaddle.y, game.paddleWidth, paddleHeight);
        ctx.fillRect(canvas.width - 20 - game.paddleWidth, game.rightBottomPaddle.y, game.paddleWidth, paddleHeight);
      }
    }

    function drawBall() {
      // Draw main ball
      ctx.beginPath();
      ctx.arc(game.ball.x, game.ball.y, game.ballRadius, 0, Math.PI * 2);
      ctx.fillStyle = 'white';
      ctx.fill();
      
      // Draw extra balls if multi-ball power-up is active
      for (const extraBall of game.extraBalls) {
        ctx.beginPath();
        ctx.arc(extraBall.x, extraBall.y, extraBall.radius, 0, Math.PI * 2);
        ctx.fillStyle = 'yellow';
        ctx.fill();
      }
    }

    function drawNet() {
      ctx.setLineDash([10, 15]);
      ctx.beginPath();
      ctx.moveTo(canvas.width / 2, 0);
      ctx.lineTo(canvas.width / 2, canvas.height);
      ctx.strokeStyle = 'rgba(255,255,255,0.5)';
      ctx.lineWidth = 2;
      ctx.stroke();
      ctx.setLineDash([]);
    }

    function drawPowerUps() {
      for (const powerUp of game.powerUps) {
        if (!powerUp.collected) {
          ctx.beginPath();
          ctx.arc(powerUp.x, powerUp.y, 15, 0, Math.PI * 2);
          ctx.fillStyle = powerUp.type.color;
          ctx.fill();
          ctx.strokeStyle = 'white';
          ctx.lineWidth = 2;
          ctx.stroke();
          
          // Draw power-up icon
          ctx.fillStyle = 'white';
          ctx.font = 'bold 16px Arial';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          
          let symbol = '?';
          if (powerUp.type.name === 'WIDE PADDLE') symbol = '‚áÜ';
          else if (powerUp.type.name === 'FAST BALL') symbol = '‚ö°';
          else if (powerUp.type.name === 'MULTI BALL') symbol = '‚úñ';
          else if (powerUp.type.name === 'SLOW PADDLE') symbol = 'üê¢';
          
          ctx.fillText(symbol, powerUp.x, powerUp.y);
        }
      }
    }

    // Game loop functions
    function gameLoop() {
      if (!game.gameStarted || game.isPaused) {
        requestAnimationFrame(gameLoop);
        return;
      }

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      drawPaddles();
      drawBall();
      drawNet();
      drawPowerUps();

      updateBall();
      updatePaddles();
      checkCollisions();
      updatePowerUps();
      checkPowerUpCollisions();

      requestAnimationFrame(gameLoop);
    }

    function updateBall() {
      if (game.isPaused) return;
      
      // Update main ball
      game.ball.x += game.ball.dx;
      game.ball.y += game.ball.dy;

      // Ball collision with top and bottom
      if (game.ball.y - game.ballRadius < 0 || game.ball.y + game.ballRadius > canvas.height) {
        game.ball.dy = -game.ball.dy;
      }
      
      // Update extra balls
      for (let i = 0; i < game.extraBalls.length; i++) {
        const ball = game.extraBalls[i];
        ball.x += ball.dx;
        ball.y += ball.dy;
        
        // Extra ball collision with top and bottom
        if (ball.y - ball.radius < 0 || ball.y + ball.radius > canvas.height) {
          ball.dy = -ball.dy;
        }
        
        // Extra ball out of bounds - remove it
        if (ball.x - ball.radius < 0 || ball.x + ball.radius > canvas.width) {
          game.extraBalls.splice(i, 1);
          i--;
        }
      }
    }

    function updatePaddles() {
      if (game.isPaused) return;

      // Mobile controls
      if (game.mobileControls.leftUp) game.leftPaddle.y -= PADDLE_SPEED;
      if (game.mobileControls.leftDown) game.leftPaddle.y += PADDLE_SPEED;
      if (game.mobileControls.rightUp) game.rightPaddle.y -= PADDLE_SPEED;
      if (game.mobileControls.rightDown) game.rightPaddle.y += PADDLE_SPEED;

      // Keyboard controls
      if (!game.isFourPlayer) {
        if (game.isLocalMultiplayer) {
          if (game.keysPressed['w'] || game.keysPressed['W']) game.leftPaddle.y -= PADDLE_SPEED;
          if (game.keysPressed['s'] || game.keysPressed['S']) game.leftPaddle.y += PADDLE_SPEED;
          if (game.keysPressed['ArrowUp']) game.rightPaddle.y -= PADDLE_SPEED;
          if (game.keysPressed['ArrowDown']) game.rightPaddle.y += PADDLE_SPEED;
        } else {
          // AI for right paddle in single player
          if (game.keysPressed['w'] || game.keysPressed['W']) game.leftPaddle.y -= PADDLE_SPEED;
          if (game.keysPressed['s'] || game.keysPressed['S']) game.leftPaddle.y += PADDLE_SPEED;
          
          // Simple AI for right paddle
          const paddleCenter = game.rightPaddle.y + game.paddleHeight / 2;
          if (paddleCenter < game.ball.y - 10) {
            game.rightPaddle.y += PADDLE_SPEED * 0.7;
          } else if (paddleCenter > game.ball.y + 10) {
            game.rightPaddle.y -= PADDLE_SPEED * 0.7;
          }
        }
      } else {
        // 4-player controls
        if (game.keysPressed['w'] || game.keysPressed['W']) game.leftTopPaddle.y -= PADDLE_SPEED;
        if (game.keysPressed['s'] || game.keysPressed['S']) game.leftTopPaddle.y += PADDLE_SPEED;
        if (game.keysPressed['q'] || game.keysPressed['Q']) game.leftBottomPaddle.y -= PADDLE_SPEED;
        if (game.keysPressed['a'] || game.keysPressed['A']) game.leftBottomPaddle.y += PADDLE_SPEED;
        if (game.keysPressed['o'] || game.keysPressed['O']) game.rightTopPaddle.y -= PADDLE_SPEED;
        if (game.keysPressed['l'] || game.keysPressed['L']) game.rightTopPaddle.y += PADDLE_SPEED;
        if (game.keysPressed['ArrowUp']) game.rightBottomPaddle.y -= PADDLE_SPEED;
        if (game.keysPressed['ArrowDown']) game.rightBottomPaddle.y += PADDLE_SPEED;
      }
      
      constrainPaddles();
    }

    function checkCollisions() {
      if (game.isPaused) return;
      
      const paddleHeight = game.isFourPlayer ? game.fourPlayerPaddleHeight : game.paddleHeight;

      // Ball collision with paddles
      if (!game.isFourPlayer) {
        // Left paddle collision
        if (game.ball.x - game.ballRadius < 20 + game.paddleWidth &&
            game.ball.y > game.leftPaddle.y &&
            game.ball.y < game.leftPaddle.y + paddleHeight) {
          const angle = getBallAngle(game.leftPaddle.y, game.ball.y, paddleHeight);
          game.ball.dx = Math.abs(Math.cos(angle)) * game.ball.speed;
          game.ball.dy = Math.sin(angle) * game.ball.speed;
          game.lastScorer = game.leftPlayer;
          playPaddleSound();
        }
        
        // Right paddle collision
        if (game.ball.x + game.ballRadius > canvas.width - 20 - game.paddleWidth &&
            game.ball.y > game.rightPaddle.y &&
            game.ball.y < game.rightPaddle.y + paddleHeight) {
          const angle = getBallAngle(game.rightPaddle.y, game.ball.y, paddleHeight);
          game.ball.dx = -Math.abs(Math.cos(angle)) * game.ball.speed;
          game.ball.dy = Math.sin(angle) * game.ball.speed;
          game.lastScorer = game.rightPlayer;
          playPaddleSound();
        }
      } else {
        // 4-player paddle collisions
        // Left side paddles
        if (game.ball.x - game.ballRadius < 20 + game.paddleWidth) {
          if ((game.ball.y > game.leftTopPaddle.y && game.ball.y < game.leftTopPaddle.y + paddleHeight) ||
              (game.ball.y > game.leftBottomPaddle.y && game.ball.y < game.leftBottomPaddle.y + paddleHeight)) {
            const paddle = game.ball.y < canvas.height/2 ? game.leftTopPaddle : game.leftBottomPaddle;
            const angle = getBallAngle(paddle.y, game.ball.y, paddleHeight);
            game.ball.dx = Math.abs(Math.cos(angle)) * game.ball.speed;
            game.ball.dy = Math.sin(angle) * game.ball.speed;
            game.lastScorer = game.leftPlayer;
            playPaddleSound();
          }
        }
        
        // Right side paddles
        if (game.ball.x + game.ballRadius > canvas.width - 20 - game.paddleWidth) {
          if ((game.ball.y > game.rightTopPaddle.y && game.ball.y < game.rightTopPaddle.y + paddleHeight) ||
              (game.ball.y > game.rightBottomPaddle.y && game.ball.y < game.rightBottomPaddle.y + paddleHeight)) {
            const paddle = game.ball.y < canvas.height/2 ? game.rightTopPaddle : game.rightBottomPaddle;
            const angle = getBallAngle(paddle.y, game.ball.y, paddleHeight);
            game.ball.dx = -Math.abs(Math.cos(angle)) * game.ball.speed;
            game.ball.dy = Math.sin(angle) * game.ball.speed;
            game.lastScorer = game.rightPlayer;
            playPaddleSound();
          }
        }
      }
      
      // Check collisions for extra balls
      for (const extraBall of game.extraBalls) {
        // Left paddle collision
        if (extraBall.x - extraBall.radius < 20 + game.paddleWidth &&
            extraBall.y > game.leftPaddle.y &&
            extraBall.y < game.leftPaddle.y + paddleHeight) {
          const angle = getBallAngle(game.leftPaddle.y, extraBall.y, paddleHeight);
          extraBall.dx = Math.abs(Math.cos(angle)) * extraBall.speed;
          extraBall.dy = Math.sin(angle) * extraBall.speed;
          playPaddleSound();
        }
        
        // Right paddle collision
        if (extraBall.x + extraBall.radius > canvas.width - 20 - game.paddleWidth &&
            extraBall.y > game.rightPaddle.y &&
            extraBall.y < game.rightPaddle.y + paddleHeight) {
          const angle = getBallAngle(game.rightPaddle.y, extraBall.y, paddleHeight);
          extraBall.dx = -Math.abs(Math.cos(angle)) * extraBall.speed;
          extraBall.dy = Math.sin(angle) * extraBall.speed;
          playPaddleSound();
        }
      }
      
      // Ball out of bounds - scoring
      if (game.ball.x - game.ballRadius < 0) {
        game.rightPaddle.score++;
        document.getElementById('rightScore').textContent = game.rightPaddle.score;
        game.lastScorer = game.rightPlayer;
        handleScore();
      }

      if (game.ball.x + game.ballRadius > canvas.width) {
        game.leftPaddle.score++;
        document.getElementById('leftScore').textContent = game.leftPaddle.score;
        game.lastScorer = game.leftPlayer;
        handleScore();
      }

      // Deuce (tie) situation
      if (game.leftPaddle.score >= 5 && game.rightPaddle.score >= 5 && 
          game.leftPaddle.score === game.rightPaddle.score && !game.deuceActive) {
        game.deuceActive = true;
        game.bonusPoints++;
        document.getElementById('bonusPoints').textContent = `‚ö° BONUS POINT: +${game.bonusPoints}`;
        queueCommentary("WE'RE AT DEUCE! BONUS POINT ACTIVATED! NEXT POINT WINS!", true, true);
      } else if (game.leftPaddle.score !== game.rightPaddle.score) {
        game.deuceActive = false;
      }
    }

    function getBallAngle(paddleY, hitY, paddleHeight) {
      const relativeY = (hitY - paddleY) / paddleHeight;
      const normalizedY = (relativeY * 2) - 1;
      return normalizedY * Math.PI / 3;
    }

    function handleScore() {
      const winningThreshold = WINNING_SCORE + game.bonusPoints;

      if (game.betweenPointsTimeout) {
        clearTimeout(game.betweenPointsTimeout);
        game.betweenPointsTimeout = null;
      }

      // Play score sound
      if (!game.isMuted) {
        scoreSound.play().catch(e => console.log("Audio play error:", e));
      }

      if (checkForSpecialMove()) {
        queueCommentary("OH MY GOODNESS! WHAT AN INCREDIBLE SHOT!", true, true);
      }
      else if ((game.leftPaddle.score === winningThreshold - 1 || 
               game.rightPaddle.score === winningThreshold - 1) && !game.matchPoint) {
        game.matchPoint = true;
        const leader = game.leftPaddle.score > game.rightPaddle.score ? game.leftPlayer : game.rightPlayer;
        queueCommentary(`THIS IS IT! CHAMPIONSHIP POINT FOR ${leader}!`, true, true);
      }
      else {
        queueCommentary(`${game.lastScorer} SCORES! ${getRandomCommentary()}`, true);
      }

      if (game.leftPaddle.score >= winningThreshold || game.rightPaddle.score >= winningThreshold) {
        endGame();
        return;
      }

      if (Math.random() < 0.3) {
        game.betweenPointsTimeout = setTimeout(() => {
          queueCommentary(getRandomCommentary());
        }, 1500);
      }

      resetBall();
    }

    function getRandomCommentary() {
      return commentaryPhrases[Math.floor(Math.random() * commentaryPhrases.length)];
    }

    function checkForSpecialMove() {
      const speedThreshold = game.isFourPlayer ? FOUR_PLAYER_BALL_SPEED * 1.8 : INITIAL_BALL_SPEED * 1.8;
      const now = Date.now();
      
      if (game.ball.speed >= speedThreshold && now - game.lastSpecialMoveTime > 5000) {
        game.lastSpecialMoveTime = now;
        return true;
      }
      return false;
    }

    function playPaddleSound() {
      if (game.isMuted) return;
      
      paddleSound.play().catch(e => console.log("Audio play error:", e));
    }

    // Game management functions
    function showNamePrompt(fourPlayerMode) {
      game.isFourPlayer = fourPlayerMode;
      document.getElementById('namePrompt').style.display = 'flex';
      document.getElementById('leftPlayerName').focus();
    }

    function submitNames() {
      const leftName = document.getElementById('leftPlayerName').value.trim() || "TEAM ONE";
      const rightName = document.getElementById('rightPlayerName').value.trim() || "TEAM TWO";
      
      game.leftPlayer = leftName.toUpperCase();
      game.rightPlayer = rightName.toUpperCase();
      
      document.getElementById('namePrompt').style.display = 'none';
      startGame();
    }

    function startLocalMultiplayer() {
      game.isLocalMultiplayer = true;
      game.isFourPlayer = false;
      game.leftPlayer = "PLAYER 1";
      game.rightPlayer = "PLAYER 2";
      startGame();
    }

    function startGame() {
      game.isPaused = false;
      game.leftPaddle.score = 0;
      game.rightPaddle.score = 0;
      game.remainingTime = GAME_TIME;
      game.matchPoint = false;
      game.bonusPoints = 0;
      game.deuceActive = false;
      game.commentaryQueue = [];
      game.hasAnnounced30 = false;
      game.hasAnnounced10 = false;
      game.powerUps = [];
      game.activePowerUps = [];
      game.extraBalls = [];
      document.getElementById('bonusPoints').textContent = "";
      document.getElementById('powerUpBar').style.display = "none";
      
      document.getElementById('titleScreen').style.display = "none";
      document.getElementById('endScreen').style.display = "none";
      document.getElementById('pauseScreen').style.display = "none";
      
      document.getElementById('leftScore').textContent = "0";
      document.getElementById('rightScore').textContent = "0";
      document.getElementById('timer').textContent = "2:00.000";
      
      resetBall();
      resetPaddles();
      
      queueCommentary(`THE CHAMPIONSHIP MATCH BEGINS! ${game.leftPlayer} VS ${game.rightPlayer}!`, true, true);
      
      startCountdown();
    }

    function startCountdown() {
      let count = 3;
      document.getElementById('countdown').style.display = "flex";
      document.getElementById('goText').style.display = "none";
      
      function updateCountdown() {
        if (count > 0) {
          document.getElementById('countdown').textContent = count;
          if (!game.isMuted) {
            const utterance = new SpeechSynthesisUtterance(count.toString());
            utterance.rate = 0.8;
            utterance.pitch = 1.3;
            window.speechSynthesis.speak(utterance);
          }
          count--;
        } else if (count === 0) {
          document.getElementById('countdown').style.display = "none";
          document.getElementById('goText').style.display = "flex";
          if (!game.isMuted) {
            const utterance = new SpeechSynthesisUtterance("GO!");
            utterance.rate = 0.7;
            utterance.pitch = 1.5;
            window.speechSynthesis.speak(utterance);
          }
          count--;
        } else {
          clearInterval(game.countdownInterval);
          document.getElementById('goText').style.display = "none";
          game.gameStarted = true;
          game.startTime = Date.now();
          
          startTimer();
        }
      }
      
      updateCountdown();
      game.countdownInterval = setInterval(updateCountdown, 1000);
    }

    function startTimer() {
      if (game.timerInterval) clearInterval(game.timerInterval);
      
      game.hasAnnounced30 = false;
      game.hasAnnounced10 = false;
      game.startTime = Date.now();
      
      game.timerInterval = setInterval(() => {
        if (game.isPaused) return;
        
        const elapsed = Date.now() - game.startTime;
        const remaining = Math.max(0, game.remainingTime * 1000 - elapsed);
        
        const minutes = Math.floor(remaining / 60000);
        const seconds = Math.floor((remaining % 60000) / 1000);
        const milliseconds = remaining % 1000;
        
        document.getElementById('timer').textContent = 
          `${minutes}:${seconds < 10 ? '0' : ''}${seconds}.${milliseconds < 100 ? (milliseconds < 10 ? '00' : '0') : ''}${milliseconds}`;
        
        if (remaining <= 30000 && !game.hasAnnounced30) {
          game.hasAnnounced30 = true;
          queueCommentary("ONLY 30 SECONDS REMAINING IN THE CHAMPIONSHIP MATCH! THE CLOCK IS TICKING!", true, true);
        }
        
        if (remaining <= 10000 && !game.hasAnnounced10) {
          game.hasAnnounced10 = true;
          queueCommentary("THE FINAL COUNTDOWN! 10 SECONDS TO DECIDE THE CHAMPION!", true, true);
        }
        
        if (remaining <= 0) {
          clearInterval(game.timerInterval);
          handleTimeExpired();
        }
      }, 10);
    }

    function handleTimeExpired() {
      if (game.leftPaddle.score === game.rightPaddle.score) {
        game.remainingTime = OVERTIME_TIME;
        game.hasAnnounced30 = false;
        game.hasAnnounced10 = false;
        if (!game.deuceActive) {
          game.bonusPoints++;
          document.getElementById('bonusPoints').textContent = `‚ö° BONUS POINT: +${game.bonusPoints}`;
        }
        queueCommentary("WE'RE GOING TO OVERTIME IN THE CHAMPIONSHIP! NEXT POINT WINS THE TITLE!", true, true);
        startTimer();
      } else {
        endGame();
      }
    }

    function queueCommentary(text, important = false, force = false) {
      if (force) {
        window.speechSynthesis.cancel();
        game.commentaryQueue = [];
        game.isSpeaking = false;
      }
      
      if (important) {
        game.commentaryQueue.unshift({text, important});
      } else {
        game.commentaryQueue.push({text, important});
      }
      
      if (!game.isSpeaking || force) {
        speakNextCommentary();
      }
      
      // Update commentary display
      document.getElementById('commentary').textContent = text;
    }

    function speakNextCommentary() {
      if (game.commentaryQueue.length > 0 && !game.isSpeaking && !game.isMuted) {
        const {text, important} = game.commentaryQueue.shift();
        announceCommentary(text, important);
      }
    }

    function announceCommentary(text, important = false) {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.rate = 0.9;
      utterance.pitch = 1.2;
      utterance.volume = important ? 1.0 : 0.8;
      
      utterance.onend = () => {
        game.isSpeaking = false;
        speakNextCommentary();
      };
      
      if (game.currentUtterance) {
        window.speechSynthesis.cancel();
      }
      
      window.speechSynthesis.speak(utterance);
      game.currentUtterance = utterance;
      game.isSpeaking = true;
    }

    function createConfetti() {
      const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff', '#ffffff'];
      
      for (let i = 0; i < 100; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = Math.random() * 100 + 'vw';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.animation = `confetti-fall ${Math.random() * 3 + 2}s linear forwards`;
        confetti.style.animationDelay = Math.random() * 0.5 + 's';
        
        const size = Math.random() * 8 + 5;
        confetti.style.width = size + 'px';
        confetti.style.height = size + 'px';
        
        if (Math.random() > 0.5) {
          confetti.style.borderRadius = '50%';
        } else {
          confetti.style.borderRadius = '0';
        }
        
        document.body.appendChild(confetti);
        
        setTimeout(() => {
          confetti.remove();
        }, 5000);
      }
    }

    function endGame() {
      game.gameStarted = false;
      clearInterval(game.timerInterval);
      
      let winner, loser, winnerScore, loserScore;
      if (game.leftPaddle.score > game.rightPaddle.score) {
        winner = game.leftPlayer;
        loser = game.rightPlayer;
        winnerScore = game.leftPaddle.score;
        loserScore = game.rightPaddle.score;
      } else {
        winner = game.rightPlayer;
        loser = game.leftPlayer;
        winnerScore = game.rightPaddle.score;
        loserScore = game.leftPaddle.score;
      }
      
      document.getElementById('endMessage').textContent = `${winner} WINS ${winnerScore}-${loserScore}! üèÜ`;
      document.getElementById('endScreen').style.display = "flex";
      
      createConfetti();
      
      queueCommentary(`${winner} defeats ${loser} ${winnerScore}-${loserScore}!`, true, true);
      queueCommentary(`WHAT A PERFORMANCE! ${winner} IS THE PONG CHAMPION!`, true);
      queueCommentary("What an incredible championship match we've witnessed today!", true);
    }

    function toggleMute() {
      game.isMuted = !game.isMuted;
      document.getElementById('muteButton').textContent = game.isMuted ? "üîá" : "üîä";
      window.speechSynthesis.cancel();
      
      if (game.isMuted) {
        queueCommentary("Commentary muted", true, true);
      } else {
        queueCommentary("Commentary unmuted", true, true);
      }
    }

    function toggleMusicMute() {
      game.isMusicMuted = !game.isMusicMuted;
      document.getElementById('musicMuteButton').textContent = game.isMusicMuted ? "üîá" : "üéµ";
      
      if (game.isMusicMuted) {
        backgroundMusic.pause();
        queueCommentary("Music muted", true, true);
      } else {
        backgroundMusic.play().catch(e => console.log("Audio play error:", e));
        queueCommentary("Music unmuted", true, true);
      }
    }

    function togglePause() {
      game.isPaused = !game.isPaused;
      document.getElementById('pauseScreen').style.display = game.isPaused ? "flex" : "none";
      
      if (game.isPaused) {
        game.pausedTime = Date.now();
        backgroundMusic.pause();
        queueCommentary("GAME PAUSED", true, true);
      } else {
        const pauseDuration = Date.now() - game.pausedTime;
        game.startTime += pauseDuration;
        if (!game.isMusicMuted) {
          backgroundMusic.play().catch(e => console.log("Audio play error:", e));
        }
        queueCommentary("GAME RESUMED", true, true);
      }
    }

    function returnToMenu() {
      game.isPaused = false;
      document.getElementById('pauseScreen').style.display = "none";
      document.getElementById('endScreen').style.display = "none";
      document.getElementById('titleScreen').style.display = "flex";
      clearInterval(game.timerInterval);
      game.gameStarted = false;
      game.isLocalMultiplayer = false;
      
      // Reset mobile controls
      game.mobileControls = {
        leftUp: false,
        leftDown: false,
        rightUp: false,
        rightDown: false
      };
      
      // Reset power-ups
      game.powerUps = [];
      game.activePowerUps = [];
      document.getElementById('powerUpBar').style.display = "none";
      document.getElementById('powerUp1').style.display = "none";
      document.getElementById('powerUp2').style.display = "none";
      document.getElementById('powerUp3').style.display = "none";
      
      queueCommentary("RETURNING TO MENU", true, true);
    }

    // Initialize the game when the DOM is loaded
    document.addEventListener('DOMContentLoaded', initGame);
  </script>
</body>
</html>
