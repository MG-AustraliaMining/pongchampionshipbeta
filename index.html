<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>üèÜ PONG CHAMPIONSHIP 2.2 üèÜ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root {
      --paddle-width: 15px;
      --ball-radius: 6px;
      --paddle-speed: 10;
      --initial-ball-speed: 7;
      --max-ball-speed: 11;
      --four-player-ball-speed: 8;
    }
    
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: linear-gradient(135deg, #1a26c3, #b21b41, #fdbb1d);
      font-family: 'Arial', sans-serif;
      touch-action: manipulation;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      height: 100vh;
      width: 100vw;
    }
    
    #gameContainer {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
    }
    
    canvas {
      background: linear-gradient(135deg, #1a26c3, #b21b41, #fdbb1d);
      display: block;
      touch-action: none;
      width: 100%;
      height: 100%;
      border-radius: 0;
    }
    
    .score {
      position: absolute;
      top: 20px;
      font-size: 3rem;
      color: white;
      text-shadow: 0 0 10px rgba(255,255,255,0.7);
      z-index: 30;
      font-weight: bold;
      font-family: 'Impact', sans-serif;
      display: none;
    }
    
    #leftScore { left: 25%; }
    #rightScore { right: 25%; }
    
    #timer {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 1.8rem;
      color: gold;
      z-index: 30;
      font-weight: bold;
      text-shadow: 0 0 5px rgba(255,215,0,0.7);
      display: none;
    }
    
    #bonusPoints {
      position: absolute;
      top: 60px;
      left: 50%;
      transform: translateX(-50%);
      color: gold;
      font-size: 1.2rem;
      text-shadow: 1px 1px 2px black;
      z-index: 30;
      font-weight: bold;
      display: none;
    }
    
    #matchInfo {
      position: absolute;
      top: 90px;
      left: 50%;
      transform: translateX(-50%);
      color: white;
      font-size: 1rem;
      text-shadow: 1px 1px 2px black;
      z-index: 30;
      display: none;
    }
    
    #commentary {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px 20px;
      border-radius: 20px;
      max-width: 90%;
      text-align: center;
      font-size: 1.1rem;
      z-index: 30;
      font-weight: bold;
      border: 2px solid gold;
      box-shadow: 0 0 10px rgba(255,215,0,0.5);
      transition: all 0.3s;
      font-family: 'Arial Black', sans-serif;
    }
    
    .screen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 100;
      padding: 20px;
      box-sizing: border-box;
    }
    
    .screen h1 {
      font-size: 3rem;
      color: gold;
      text-shadow: 0 0 10px rgba(255,215,0,0.7);
      margin-bottom: 1rem;
      text-align: center;
      font-family: 'Impact', sans-serif;
      letter-spacing: 2px;
    }
    
    .btn-championship {
      background: linear-gradient(45deg, #ff8a00, #e52e71);
      border: none;
      font-size: 1.5rem;
      padding: 12px 30px;
      margin: 10px;
      border-radius: 50px;
      color: white;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      transition: all 0.2s;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-family: 'Arial Black', sans-serif;
    }
    
    .btn-championship:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 20px rgba(0,0,0,0.4);
    }
    
    .control-btn {
      position: absolute;
      z-index: 40;
      background: rgba(255,255,255,0.3);
      border: 2px solid white;
      border-radius: 50%;
      width: 45px;
      height: 45px;
      color: white;
      font-size: 1.1rem;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: all 0.2s;
      box-shadow: 0 0 8px rgba(255,255,255,0.4);
    }
    
    .control-btn:hover {
      background: rgba(255,255,255,0.4);
    }
    
    #muteButton { top: 15px; left: 15px; }
    #pauseButton { top: 15px; left: 70px; }
    #fullscreenButton { top: 15px; left: 125px; }
    #musicMuteButton { top: 15px; right: 15px; }
    #backButton { top: 15px; right: 70px; }
    
    #pauseScreen, #countdown, #halftimeScreen, #gameOverScreen {
      display: none;
    }
    
    #mobileControls {
      position: absolute;
      bottom: 20px;
      width: 100%;
      display: flex;
      justify-content: space-between;
      padding: 0 20px;
      z-index: 20;
    }
    
    .mobile-paddle-controls {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .mobile-btn {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: rgba(255,255,255,0.3);
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
      font-size: 1.8rem;
      user-select: none;
      touch-action: manipulation;
      border: 2px solid white;
      box-shadow: 0 0 10px rgba(255,255,255,0.4);
    }
    
    .mobile-btn:active {
      background: rgba(255,255,255,0.5);
    }
    
    .mobile-power-btn {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: rgba(255,215,0,0.3);
      display: flex;
      justify-content: center;
      align-items: center;
      color: gold;
      font-size: 1.5rem;
      user-select: none;
      touch-action: manipulation;
      border: 2px solid gold;
      box-shadow: 0 0 10px rgba(255,215,0,0.5);
      position: absolute;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
    }
    
    .mobile-power-btn:active {
      background: rgba(255,215,0,0.5);
    }
    
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 300;
    }
    
    .modal-content {
      background: linear-gradient(135deg, #1a2a6c, #b21f1f);
      padding: 30px;
      border-radius: 20px;
      text-align: center;
      max-width: 90%;
      width: 500px;
      box-shadow: 0 0 30px rgba(0,0,0,0.6);
      border: 3px solid gold;
    }
    
    .modal-title {
      color: gold;
      font-size: 2rem;
      margin-bottom: 20px;
      text-shadow: 0 0 10px rgba(255,215,0,0.7);
      font-family: 'Impact', sans-serif;
    }
    
    .modal-input {
      width: 100%;
      padding: 12px;
      margin-bottom: 20px;
      border-radius: 15px;
      border: 2px solid gold;
      font-size: 1.3rem;
      text-align: center;
      background: rgba(0,0,0,0.7);
      color: white;
      font-family: 'Arial', sans-serif;
    }
    
    .modal-btn {
      padding: 12px 30px;
      margin: 0 10px;
      border-radius: 50px;
      border: none;
      background: gold;
      color: #000;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 1.1rem;
      font-family: 'Arial Black', sans-serif;
    }
    
    .modal-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 0 15px rgba(255,215,0,0.7);
    }
    
    #countdown {
      font-size: 8rem;
      font-weight: bold;
      color: gold;
      text-shadow: 0 0 20px rgba(255,215,0,0.7);
      animation: pulse 0.5s infinite alternate;
    }
    
    #halftimeScreen {
      font-size: 4rem;
      font-weight: bold;
      color: gold;
      text-shadow: 0 0 20px rgba(255,215,0,0.7);
    }
    
    #gameOverScreen {
      font-size: 4rem;
      font-weight: bold;
      color: red;
      text-shadow: 0 0 20px rgba(255,0,0,0.7);
    }
    
    @keyframes pulse {
      from { transform: scale(1); opacity: 1; }
      to { transform: scale(1.2); opacity: 0.8; }
    }
    
    #goText {
      font-size: 8rem;
      font-weight: bold;
      color: gold;
      text-shadow: 0 0 20px rgba(255,215,0,0.7);
      animation: goPulse 0.3s infinite alternate, fadeOut 1s 1s forwards;
      display: none;
    }
    
    @keyframes goPulse {
      from { transform: scale(1); text-shadow: 0 0 20px rgba(255,215,0,0.7); }
      to { transform: scale(1.3); text-shadow: 0 0 40px rgba(255,215,0,0.9); }
    }
    
    @keyframes fadeOut {
      to { opacity: 0; }
    }
    
    /* Power shot effects - Updated with separate bars */
    .paddle-charge-container {
      position: absolute;
      bottom: 10px;
      width: 100px;
      height: 15px;
      background: rgba(255,255,255,0.2);
      border-radius: 8px;
      overflow: hidden;
      z-index: 20;
    }
    
    .paddle-charge {
      position: absolute;
      height: 100%;
      background: linear-gradient(to right, #00ff00, #ffff00, #ff0000);
      border-radius: 8px;
      transition: width 0.1s;
    }
    
    #leftChargeContainer {
      left: 20px;
    }
    
    #rightChargeContainer {
      right: 20px;
    }
    
    #leftCharge {
      left: 0;
      width: 0;
    }
    
    #rightCharge {
      right: 0;
      width: 0;
    }
    
    .paddle-charge-label {
      position: absolute;
      bottom: 30px;
      font-size: 0.8rem;
      color: white;
      text-shadow: 0 0 3px black;
      z-index: 20;
    }
    
    #leftChargeLabel {
      left: 20px;
    }
    
    #rightChargeLabel {
      right: 20px;
    }
    
    .paddle-charge.active {
      animation: chargePulse 0.5s infinite alternate;
    }
    
    @keyframes chargePulse {
      from { box-shadow: 0 0 3px gold; }
      to { box-shadow: 0 0 10px gold; }
    }
    
    /* Leaderboard Styles */
    #leaderboardScreen {
      display: none;
    }
    
    .leaderboard-tabs {
      display: flex;
      margin-bottom: 10px;
      width: 100%;
      justify-content: center;
    }
    
    .leaderboard-tab {
      padding: 8px 16px;
      background: rgba(255,215,0,0.2);
      border: 1px solid gold;
      color: white;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.9rem;
    }
    
    .leaderboard-tab:first-child {
      border-radius: 20px 0 0 20px;
    }
    
    .leaderboard-tab:last-child {
      border-radius: 0 20px 20px 0;
    }
    
    .leaderboard-tab.active {
      background: gold;
      color: black;
      font-weight: bold;
    }
    
    .leaderboard {
      background: rgba(0, 0, 0, 0.7);
      border: 2px solid gold;
      border-radius: 10px;
      padding: 12px;
      color: white;
      width: 100%;
      height: 60vh;
      overflow-y: auto;
      box-shadow: 0 0 10px rgba(255, 215, 0, 0.4);
      font-family: 'Arial', sans-serif;
      display: none;
    }
    
    .leaderboard.active {
      display: block;
    }
    
    .leaderboard h3 {
      color: gold;
      margin-top: 0;
      margin-bottom: 8px;
      text-align: center;
      font-size: 1.1rem;
      border-bottom: 1px solid gold;
      padding-bottom: 5px;
    }
    
    .leaderboard-item {
      padding: 5px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      font-size: 0.9rem;
    }
    
    .leaderboard-item:last-child {
      border-bottom: none;
    }
    
    .leaderboard-rank {
      color: gold;
      font-weight: bold;
      margin-right: 5px;
    }
    
    .leaderboard-time {
      color: #aaa;
      font-size: 0.8rem;
      margin-top: 3px;
    }
    
    /* Difficulty selector */
    .difficulty-selector {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .difficulty-btn {
      padding: 8px 16px;
      border-radius: 20px;
      border: 2px solid gold;
      background: rgba(255,215,0,0.1);
      color: white;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .difficulty-btn:hover {
      background: rgba(255,215,0,0.2);
    }
    
    .difficulty-btn.active {
      background: gold;
      color: black;
      font-weight: bold;
    }
    
    /* Tournament stage selector */
    .stage-selector {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 15px;
      gap: 8px;
    }
    
    .stage-btn {
      background: rgba(255, 215, 0, 0.2);
      border: 1px solid gold;
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.9rem;
    }
    
    .stage-btn:hover {
      background: rgba(255, 215, 0, 0.3);
    }
    
    .stage-btn.active {
      background: gold;
      color: black;
      font-weight: bold;
    }
    
    /* Intro animation */
    #introAnimation {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    #introText {
      font-size: 4rem;
      color: gold;
      text-shadow: 0 0 15px rgba(255,215,0,0.7);
      font-family: 'Impact', sans-serif;
      animation: textGlow 2s infinite alternate;
      margin-bottom: 1.5rem;
      text-align: center;
      transform: scale(0);
      opacity: 0;
    }
    
    @keyframes textGlow {
      from { text-shadow: 0 0 8px gold; }
      to { text-shadow: 0 0 20px gold, 0 0 30px gold; }
    }
    
    @keyframes textEntry {
      0% { transform: scale(0); opacity: 0; }
      50% { transform: scale(1.2); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }
    
    #startButton {
      padding: 12px 25px;
      font-size: 1.3rem;
      border-radius: 50px;
      border: none;
      background: linear-gradient(45deg, #ff8a00, #e52e71);
      color: white;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: bold;
      transform: scale(0);
      opacity: 0;
    }
    
    #startButton:hover {
      transform: scale(1.05);
      box-shadow: 0 0 15px rgba(255,255,255,0.4);
    }
    
    /* Back button */
    .back-btn {
      position: absolute;
      top: 15px;
      left: 15px;
      background: rgba(255,255,255,0.2);
      border: 2px solid white;
      border-radius: 50%;
      width: 45px;
      height: 45px;
      color: white;
      font-size: 1.2rem;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      z-index: 110;
      transition: all 0.2s;
    }
    
    .back-btn:hover {
      background: rgba(255,255,255,0.3);
    }
    
    /* Fire trail effect */
    .particle {
      position: absolute;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      pointer-events: none;
      z-index: 10;
    }
    
    /* Practice mode instructions */
    #practiceInstructions {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      z-index: 50;
      max-width: 80%;
      border: 2px solid gold;
      display: none;
    }
    
    /* Glow effect for UI elements */
    .glow {
      animation: glow 2s ease-in-out infinite alternate;
    }
    
    @keyframes glow {
      from {
        box-shadow: 0 0 5px rgba(255,215,0,0.5);
      }
      to {
        box-shadow: 0 0 20px rgba(255,215,0,0.8);
      }
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .score { 
        font-size: 2.5rem; 
        top: 15px; 
      }
      #leftScore { left: 20%; }
      #rightScore { right: 20%; }
      #timer { font-size: 1.5rem; top: 15px; }
      #bonusPoints { font-size: 1rem; top: 50px; }
      #matchInfo { font-size: 0.9rem; top: 80px; }
      #commentary { 
        font-size: 1rem; 
        padding: 8px 15px; 
        bottom: 15px; 
        max-width: 95%;
      }
      .btn-championship { 
        font-size: 1.2rem; 
        padding: 10px 20px; 
        margin: 8px;
      }
      .control-btn {
        width: 40px;
        height: 40px;
        font-size: 1rem;
      }
      #muteButton { left: 10px; top: 10px; }
      #pauseButton { left: 60px; top: 10px; }
      #fullscreenButton { left: 110px; top: 10px; }
      #musicMuteButton { right: 10px; top: 10px; }
      #backButton { right: 60px; top: 10px; }
      .mobile-btn {
        width: 60px;
        height: 60px;
        font-size: 1.5rem;
      }
      .mobile-power-btn {
        width: 60px;
        height: 60px;
        font-size: 1.3rem;
        bottom: 90px;
      }
      .modal-content {
        width: 90%;
        padding: 20px;
      }
      .modal-title {
        font-size: 1.6rem;
      }
      .modal-input {
        font-size: 1.1rem;
        padding: 10px;
      }
      #countdown, #goText {
        font-size: 5rem;
      }
      #halftimeScreen, #gameOverScreen {
        font-size: 3rem;
      }
      #introText {
        font-size: 2.5rem;
      }
      
      /* Adjust leaderboards for mobile */
      .leaderboard {
        width: 90%;
        max-width: none;
        font-size: 0.8rem;
      }
      
      /* Adjust power bars for mobile */
      .paddle-charge-container {
        width: 80px;
        height: 12px;
      }
      
      .paddle-charge-label {
        font-size: 0.7rem;
        bottom: 25px;
      }
    }
    
    @media (max-height: 500px) {
      .screen h1 { font-size: 2rem; }
      .btn-championship { 
        font-size: 1rem; 
        padding: 8px 15px;
        margin: 6px;
      }
      #mobileControls { bottom: 10px; }
      .mobile-btn { 
        width: 50px; 
        height: 50px; 
        font-size: 1.3rem;
      }
      .mobile-power-btn {
        width: 50px;
        height: 50px;
        font-size: 1.1rem;
        bottom: 70px;
      }
      #commentary { 
        bottom: 8px;
        font-size: 0.8rem;
      }
      #countdown, #goText {
        font-size: 3rem;
      }
      #halftimeScreen, #gameOverScreen {
        font-size: 2rem;
      }
      #introText {
        font-size: 1.8rem;
      }
    }
  </style>
</head>
<body>
  <!-- Intro Animation Screen -->
  <div id="introAnimation">
    <div id="introText">PONG CHAMPIONSHIP 2.2</div>
    <button id="startButton">START</button>
  </div>

  <div id="gameContainer">
    <canvas id="pongCanvas"></canvas>
    <canvas id="particleCanvas" style="position: absolute; top: 0; left: 0; z-index: 5;"></canvas>
    
    <!-- Game elements (hidden during menu) -->
    <div id="leftScore" class="score">0</div>
    <div id="rightScore" class="score">0</div>
    <div id="timer">1:30.000</div>
    <div id="bonusPoints"></div>
    <div id="matchInfo"></div>
    <div id="commentary">WELCOME TO THE PONG CHAMPIONSHIP 2.2!</div>
    
    <!-- Power charge bars - now properly separated -->
    <div id="leftChargeContainer" class="paddle-charge-container">
      <div id="leftCharge" class="paddle-charge"></div>
    </div>
    <div id="leftChargeLabel" class="paddle-charge-label">P1 POWER</div>
    
    <div id="rightChargeContainer" class="paddle-charge-container">
      <div id="rightCharge" class="paddle-charge"></div>
    </div>
    <div id="rightChargeLabel" class="paddle-charge-label">P2 POWER</div>
    
    <button id="muteButton" class="control-btn">üîä</button>
    <button id="pauseButton" class="control-btn">‚è∏Ô∏è</button>
    <button id="fullscreenButton" class="control-btn">‚õ∂</button>
    <button id="musicMuteButton" class="control-btn">üéµ</button>
    <button id="backButton" class="control-btn" style="display: none;">‚Ü©Ô∏è</button>
    
    <div id="mobileControls" style="display: none;">
      <div class="mobile-paddle-controls">
        <div class="mobile-btn" id="upBtnLeft">‚Üë</div>
        <div class="mobile-btn" id="downBtnLeft">‚Üì</div>
      </div>
      <div class="mobile-power-btn" id="powerBtnLeft">üí•</div>
      <div class="mobile-paddle-controls">
        <div class="mobile-btn" id="upBtnRight">‚Üë</div>
        <div class="mobile-btn" id="downBtnRight">‚Üì</div>
      </div>
    </div>

    <div id="countdown" class="screen"></div>
    <div id="goText" class="screen">GO!</div>
    <div id="halftimeScreen" class="screen"></div>
    <div id="gameOverScreen" class="screen">GAME OVER</div>

    <div id="pauseScreen" class="screen">
      <h1>GAME CURRENTLY PAUSED</h1>
      <button class="btn-championship" id="resumeButton">RESUME</button>
      <button class="btn-championship" id="returnToMenuButton">RETURN TO MENU</button>
    </div>

    <div id="titleScreen" class="screen">
      <h1>üèÜ PONG CHAMPIONSHIP 2.2 üèÜ</h1>
      <button class="btn-championship" id="twoPlayerButton">2 PLAYERS</button>
      <button class="btn-championship" id="singlePlayerButton">1 PLAYER VS BOT</button>
      <button class="btn-championship" id="fourPlayerButton">4 PLAYERS</button>
      <button class="btn-championship" id="leaderboardButton" style="margin-top: 20px;">LEADERBOARDS</button>
      <button class="btn-championship" id="practiceButton">PRACTICE</button>
      <button class="btn-championship" id="endlessButton">ENDLESS MODE</button>
      <button class="btn-championship" id="learnPongButton">LEARN ABOUT PONG</button>
    </div>

    <div id="leaderboardScreen" class="screen">
      <h1>üèÜ LEADERBOARDS üèÜ</h1>
      <div class="leaderboard-tabs">
        <div class="leaderboard-tab active" data-tab="recent">RECENT PLAYS</div>
        <div class="leaderboard-tab" data-tab="best">BEST WINS</div>
        <div class="leaderboard-tab" data-tab="bot">BOT CHAMPIONS</div>
      </div>
      
      <div id="recentPlays" class="leaderboard active">
        <h3>RECENT PLAYS</h3>
        <div id="recentPlaysList"></div>
      </div>
      
      <div id="bestWins" class="leaderboard">
        <h3>BEST WINS</h3>
        <div id="bestWinsList"></div>
      </div>
      
      <div id="botChampion" class="leaderboard">
        <h3>BOT CHAMPIONS</h3>
        <div id="botChampionList"></div>
      </div>
      
      <button class="btn-championship" id="backToMenuButton" style="margin-top: 20px;">BACK TO MENU</button>
    </div>

    <div id="endScreen" class="screen" style="display: none;">
      <h1 id="endMessage" style="color: gold; font-size: 2rem;"></h1>
      <button class="btn-championship" id="endScreenBtn">RETURN TO MENU</button>
    </div>
  </div>

  <!-- Practice mode instructions -->
  <div id="practiceInstructions">
    <h3 id="practiceTitle"></h3>
    <p id="practiceText"></p>
    <button class="modal-btn" id="practiceContinue">CONTINUE</button>
  </div>

  <div id="twoPlayerPrompt" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-title">ENTER PLAYER NAMES</div>
      <input type="text" id="leftPlayerName" class="modal-input" placeholder="Left Player Name" maxlength="20">
      <input type="text" id="rightPlayerName" class="modal-input" placeholder="Right Player Name" maxlength="20">
      
      <div class="stage-selector">
        <div class="stage-btn" data-stage="Round of 16">Round of 16</div>
        <div class="stage-btn" data-stage="Quarter Finals">Quarter Finals</div>
        <div class="stage-btn" data-stage="Semi Finals">Semi Finals</div>
        <div class="stage-btn" data-stage="Finals">Finals</div>
      </div>
      
      <input type="hidden" id="selectedStage" value="Round of 16">
      
      <div style="display: flex; justify-content: center; gap: 10px; margin-top: 15px;">
        <button class="modal-btn" id="submitTwoPlayerNames">START GAME</button>
        <button class="modal-btn" id="cancelTwoPlayer">BACK</button>
      </div>
    </div>
  </div>

  <div id="fourPlayerPrompt" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-title">ENTER TEAM NAMES</div>
      <input type="text" id="leftTeamName" class="modal-input" placeholder="Left Team Name" maxlength="20">
      <input type="text" id="rightTeamName" class="modal-input" placeholder="Right Team Name" maxlength="20">
      <div style="display: flex; justify-content: center; gap: 10px; margin-top: 15px;">
        <button class="modal-btn" id="submitFourPlayerNames">START GAME</button>
        <button class="modal-btn" id="cancelFourPlayer">BACK</button>
      </div>
    </div>
  </div>

  <div id="singlePlayerPrompt" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-title">WHAT IS YOUR NAME?</div>
      <input type="text" id="playerName" class="modal-input" placeholder="Your Name" maxlength="20">
      
      <div class="difficulty-selector">
        <div class="difficulty-btn active" data-difficulty="easy">EASY</div>
        <div class="difficulty-btn" data-difficulty="medium">MEDIUM</div>
        <div class="difficulty-btn" data-difficulty="hard">HARD</div>
      </div>
      <input type="hidden" id="selectedDifficulty" value="easy">
      
      <div style="display: flex; justify-content: center; gap: 10px; margin-top: 15px;">
        <button class="modal-btn" id="submitSinglePlayerName">START GAME</button>
        <button class="modal-btn" id="cancelSinglePlayer">BACK</button>
      </div>
    </div>
  </div>

  <div id="endlessPrompt" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-title">ENDLESS MODE</div>
      <input type="text" id="endlessPlayerName" class="modal-input" placeholder="Your Name" maxlength="20">
      
      <div class="difficulty-selector">
        <div class="difficulty-btn active" data-difficulty="easy">EASY</div>
        <div class="difficulty-btn" data-difficulty="medium">MEDIUM</div>
        <div class="difficulty-btn" data-difficulty="hard">HARD</div>
      </div>
      <input type="hidden" id="endlessDifficulty" value="easy">
      
      <div style="display: flex; justify-content: center; gap: 10px; margin-top: 15px;">
        <button class="modal-btn" id="submitEndlessName">START</button>
        <button class="modal-btn" id="cancelEndless">BACK</button>
      </div>
    </div>
  </div>

  <div id="practiceModePrompt" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-title">PRACTICE MODE</div>
      <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px;">
        <button class="modal-btn" id="learnPowerShotBtn">LEARN POWER SHOT</button>
        <button class="modal-btn" id="learnRespondingBtn">LEARN RESPONDING</button>
      </div>
      <div style="display: flex; justify-content: center; gap: 10px; margin-top: 15px;">
        <button class="modal-btn" id="cancelPractice">BACK</button>
      </div>
    </div>
  </div>

  <!-- Audio elements -->
  <audio id="backgroundMusic" loop></audio>
  <audio id="paddleSound"></audio>
  <audio id="scoreSound"></audio>
  <audio id="scoreSound1"></audio>
  <audio id="scoreSound2"></audio>
  <audio id="hitSound"></audio>
  <audio id="hitSound1"></audio>
  <audio id="hitSound2"></audio>
  <audio id="hitSound3"></audio>
  <audio id="hitSound4"></audio>
  <audio id="etSound"></audio>
  <audio id="gameOverSound"></audio>
  <audio id="gameOverSound1"></audio>
  <audio id="selectSound"></audio>
  <audio id="startSound"></audio>
  <audio id="startSound1"></audio>
  <audio id="startSound2"></audio>
  <audio id="startSound3"></audio>
  <audio id="introSound"></audio>
  <audio id="introSound1"></audio>
  <audio id="introSound2"></audio>
  <audio id="introSound3"></audio>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Game Constants
    const PADDLE_HEIGHT_RATIO = 0.2;
    const FOUR_PLAYER_PADDLE_HEIGHT_RATIO = 0.15;
    const BALL_RADIUS_RATIO = 0.012;
    const INITIAL_BALL_SPEED = 7; // Reduced for better performance
    const MAX_BALL_SPEED = 14;
    const FOUR_PLAYER_BALL_SPEED = 8;
    const PADDLE_SPEED = 8; // Reduced for better control
    const WINNING_SCORE = 10;
    const HALF_TIME = 90; // 1 minute 30 seconds per half
    const HALF_TIME_BREAK = 10; // 10 second break
    const OVERTIME_TIME = 30; // 30 seconds for overtime
    const BALL_SPEED_INCREMENT = 0.5;
    const SMASH_SPEED_MULTIPLIER = 1.8; // Reduced for better control
    const SMASH_DURATION = 800; // ms
    const CHARGE_TIME = 5000; // 5 seconds to charge
    const POWER_SHOT_DURATION = 4000; // 4 seconds to use power shot
    
    // Game Elements
    const canvas = document.getElementById('pongCanvas');
    const ctx = canvas.getContext('2d');
    const particleCanvas = document.getElementById('particleCanvas');
    const particleCtx = particleCanvas.getContext('2d');
    
    // Audio Elements
    const backgroundMusic = document.getElementById('backgroundMusic');
    const paddleSound = document.getElementById('paddleSound');
    const scoreSound = document.getElementById('scoreSound');
    const scoreSound1 = document.getElementById('scoreSound1');
    const scoreSound2 = document.getElementById('scoreSound2');
    const hitSound = document.getElementById('hitSound');
    const hitSound1 = document.getElementById('hitSound1');
    const hitSound2 = document.getElementById('hitSound2');
    const hitSound3 = document.getElementById('hitSound3');
    const hitSound4 = document.getElementById('hitSound4');
    const etSound = document.getElementById('etSound');
    const gameOverSound = document.getElementById('gameOverSound');
    const gameOverSound1 = document.getElementById('gameOverSound1');
    const selectSound = document.getElementById('selectSound');
    const startSound = document.getElementById('startSound');
    const startSound1 = document.getElementById('startSound1');
    const startSound2 = document.getElementById('startSound2');
    const startSound3 = document.getElementById('startSound3');
    const introSound = document.getElementById('introSound');
    const introSound1 = document.getElementById('introSound1');
    const introSound2 = document.getElementById('introSound2');
    const introSound3 = document.getElementById('introSound3');
    
    // Game State
    const game = {
      ball: { x: 0, y: 0, dx: 0, dy: 0, speed: INITIAL_BALL_SPEED, originalSpeed: INITIAL_BALL_SPEED },
      leftPaddle: { y: 0, score: 0 },
      rightPaddle: { y: 0, score: 0 },
      leftTopPaddle: { y: 0 },
      leftBottomPaddle: { y: 0 },
      rightTopPaddle: { y: 0 },
      rightBottomPaddle: { y: 0 },
      isFourPlayer: false,
      isMuted: false,
      isMusicMuted: false,
      isPaused: false,
      gameStarted: false,
      remainingTime: HALF_TIME,
      currentHalf: 1,
      extraTime: 0,
      halftimeActive: false,
      lastScorer: null,
      matchPoint: false,
      leftPlayer: "PLAYER 1",
      rightPlayer: "PLAYER 2",
      tournamentStage: "Round of 16",
      aiDifficulty: "easy",
      timerInterval: null,
      countdownInterval: null,
      halftimeInterval: null,
      keysPressed: {},
      bonusPoints: 0,
      deuceActive: false,
      startTime: 0,
      pausedTime: 0,
      commentaryQueue: [],
      isSpeaking: false,
      hasAnnounced30: false,
      hasAnnounced10: false,
      currentUtterance: null,
      lastSpecialMoveTime: 0,
      betweenPointsTimeout: null,
      mobileControls: {
        leftUp: false,
        leftDown: false,
        rightUp: false,
        rightDown: false,
        leftPower: false,
        rightPower: false
      },
      dpadEnabled: false,
      isLocalMultiplayer: false,
      paddleWidth: 0,
      paddleHeight: 0,
      fourPlayerPaddleHeight: 0,
      ballRadius: 0,
      musicStarted: false,
      smashCounter: 0,
      smashTarget: 0,
      isSmashActive: false,
      smashEndTime: 0,
      recentPlays: [],
      bestWins: [],
      botChampions: [],
      leftCharge: 0,
      rightCharge: 0,
      leftCharged: false,
      rightCharged: false,
      leftChargeInterval: null,
      rightChargeInterval: null,
      leftChargeEndTime: 0,
      rightChargeEndTime: 0,
      countdownActive: false,
      last10Seconds: false,
      countdownNumbers: [],
      soundEnabled: false,
      teamLeftCharged: false,
      teamRightCharged: false,
      particles: [],
      lastFrameTime: 0,
      isPracticeMode: false,
      practiceType: null,
      isEndlessMode: false,
      ballResetTimeout: null,
      leftPaddleColor: 'white',
      rightPaddleColor: 'white',
      ballColor: 'white'
    };

    // Commentary phrases
    const commentaryPhrases = [
      "What a shot!",
      "Incredible reflexes!",
      "The crowd is going wild!",
      "This is championship-level play!",
      "Unbelievable!",
      "Did you see that?!",
      "The tension is palpable!",
      "What a rally!",
      "This match is heating up!",
      "A masterclass in pong!",
      "The players are giving it their all!",
      "This is pong at its finest!",
      "The stakes couldn't be higher!",
      "What a display of skill!",
      "The championship is on the line!",
      "This is what we came to see!",
      "The intensity is through the roof!",
      "Absolutely breathtaking play!",
      "The crowd can't believe their eyes!",
      "This is edge-of-your-seat action!",
      "The players are in the zone!",
      "What a back-and-forth battle!",
      "The energy in the arena is electric!",
      "This is pong perfection!",
      "The skill level is off the charts!",
      "Neither player is backing down!",
      "The determination is incredible!",
      "This is a clash of titans!",
      "The focus is laser-sharp!",
      "Every point is a masterpiece!",
      "The competition is fierce!",
      "This is next-level pong!",
      "The players are pushing their limits!",
      "The crowd is on their feet!",
      "This is a legendary match!",
      "The speed is mind-blowing!",
      "The precision is surgical!",
      "This is pong at warp speed!",
      "The reflexes are superhuman!",
      "The crowd is losing their minds!",
      "This is the match of the century!",
      "The players are unstoppable!",
      "The excitement is unbearable!",
      "This is pong poetry in motion!",
      "The anticipation is killing me!",
      "The players are putting on a clinic!",
      "This is a masterclass in competition!",
      "The drama is intense!",
      "The crowd is roaring with excitement!",
      "This is pong at its absolute best!"
    ];

    // Initialize Game
    function initGame() {
      resizeCanvas();
      window.addEventListener('resize', resizeCanvas);
      setupMobileControls();
      setupKeyboardControls();
      setupControlButtons();
      loadAudioFiles();
      loadLeaderboards();
      setupEventListeners();
      
      // Set up intro screen
      setupIntroScreen();
      
      // Enable sound by default
      game.soundEnabled = true;
    }

    function setupIntroScreen() {
      // Animate the intro text
      const introText = document.getElementById('introText');
      const startButton = document.getElementById('startButton');
      
      // Animate text entry
      setTimeout(() => {
        introText.style.animation = 'textEntry 1s forwards';
        setTimeout(() => {
          startButton.style.animation = 'textEntry 0.5s forwards';
          startButton.style.animationDelay = '0.3s';
        }, 500);
      }, 300);
      
      startButton.addEventListener('click', () => {
        document.getElementById('introAnimation').style.display = 'none';
        document.getElementById('titleScreen').style.display = 'flex';
        
        // Play random intro sound only when button is clicked
        const introSounds = [introSound, introSound1, introSound2, introSound3];
        const randomIntroSound = introSounds[Math.floor(Math.random() * introSounds.length)];
        randomIntroSound.volume = 0.5;
        randomIntroSound.play().catch(e => console.log("Audio play error:", e));
      });
    }

    function setupButtonSounds() {
      const buttons = document.querySelectorAll('button, .btn-championship, .control-btn, .modal-btn, .stage-btn, .difficulty-btn');
      buttons.forEach(button => {
        button.addEventListener('click', () => {
          if (game.soundEnabled && !game.isMuted) {
            selectSound.currentTime = 0;
            selectSound.play().catch(e => console.log("Audio play error:", e));
          }
        });
      });
    }

    function setupEventListeners() {
      // Menu buttons
      document.getElementById('twoPlayerButton').addEventListener('click', showTwoPlayerPrompt);
      document.getElementById('singlePlayerButton').addEventListener('click', showSinglePlayerPrompt);
      document.getElementById('fourPlayerButton').addEventListener('click', showFourPlayerPrompt);
      document.getElementById('practiceButton').addEventListener('click', showPracticePrompt);
      document.getElementById('endlessButton').addEventListener('click', showEndlessPrompt);
      document.getElementById('leaderboardButton').addEventListener('click', showLeaderboards);
      document.getElementById('backToMenuButton').addEventListener('click', hideLeaderboards);
      document.getElementById('learnPongButton').addEventListener('click', () => {
        window.open('https://en.wikipedia.org/wiki/Pong', '_blank');
      });
      
      // Modal submit buttons
      document.getElementById('submitTwoPlayerNames').addEventListener('click', submitTwoPlayerNames);
      document.getElementById('submitSinglePlayerName').addEventListener('click', submitSinglePlayerName);
      document.getElementById('submitFourPlayerNames').addEventListener('click', submitFourPlayerNames);
      document.getElementById('submitEndlessName').addEventListener('click', submitEndlessName);
      document.getElementById('learnPowerShotBtn').addEventListener('click', startPowerShotPractice);
      document.getElementById('learnRespondingBtn').addEventListener('click', startRespondingPractice);
      document.getElementById('practiceContinue').addEventListener('click', hidePracticeInstructions);
      
      // Modal cancel buttons
      document.getElementById('cancelTwoPlayer').addEventListener('click', cancelTwoPlayerPrompt);
      document.getElementById('cancelSinglePlayer').addEventListener('click', cancelSinglePlayerPrompt);
      document.getElementById('cancelFourPlayer').addEventListener('click', cancelFourPlayerPrompt);
      document.getElementById('cancelEndless').addEventListener('click', cancelEndlessPrompt);
      document.getElementById('cancelPractice').addEventListener('click', cancelPracticePrompt);
      
      // Game control buttons
      document.getElementById('resumeButton').addEventListener('click', togglePause);
      document.getElementById('returnToMenuButton').addEventListener('click', returnToMenu);
      document.getElementById('endScreenBtn').addEventListener('click', returnToMenu);
      document.getElementById('backButton').addEventListener('click', handleBackButton);
      
      // Leaderboard tabs
      const leaderboardTabs = document.querySelectorAll('.leaderboard-tab');
      leaderboardTabs.forEach(tab => {
        tab.addEventListener('click', function() {
          leaderboardTabs.forEach(t => t.classList.remove('active'));
          this.classList.add('active');
          
          document.querySelectorAll('.leaderboard').forEach(lb => {
            lb.classList.remove('active');
          });
          
          const targetId = this.dataset.tab + (this.dataset.tab === 'best' ? 'Wins' : this.dataset.tab === 'bot' ? 'Champion' : 'Plays');
          document.getElementById(targetId).classList.add('active');
          playSelectSound();
        });
      });
      
      // Stage selection
      const stageBtns = document.querySelectorAll('.stage-btn');
      stageBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          stageBtns.forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          document.getElementById('selectedStage').value = this.dataset.stage;
          playSelectSound();
        });
      });
      // Activate first stage by default
      if (stageBtns[0]) stageBtns[0].classList.add('active');
      
      // Difficulty selection
      const difficultyBtns = document.querySelectorAll('.difficulty-btn');
      difficultyBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          difficultyBtns.forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          const difficultyInput = document.getElementById(this.parentElement.nextElementSibling.id);
          if (difficultyInput) {
            difficultyInput.value = this.dataset.difficulty;
          }
          playSelectSound();
        });
      });
      
      // Setup button sounds
      setupButtonSounds();
    }

    function showLeaderboards() {
      document.getElementById('titleScreen').style.display = 'none';
      document.getElementById('leaderboardScreen').style.display = 'flex';
      document.getElementById('backButton').style.display = 'flex';
      playSelectSound();
    }

    function hideLeaderboards() {
      document.getElementById('leaderboardScreen').style.display = 'none';
      document.getElementById('titleScreen').style.display = 'flex';
      document.getElementById('backButton').style.display = 'none';
      playSelectSound();
    }

    function handleBackButton() {
      if (document.getElementById('twoPlayerPrompt').style.display === 'flex') {
        cancelTwoPlayerPrompt();
      } else if (document.getElementById('singlePlayerPrompt').style.display === 'flex') {
        cancelSinglePlayerPrompt();
      } else if (document.getElementById('fourPlayerPrompt').style.display === 'flex') {
        cancelFourPlayerPrompt();
      } else if (document.getElementById('endlessPrompt').style.display === 'flex') {
        cancelEndlessPrompt();
      } else if (document.getElementById('practiceModePrompt').style.display === 'flex') {
        cancelPracticePrompt();
      } else if (document.getElementById('leaderboardScreen').style.display === 'flex') {
        hideLeaderboards();
      } else {
        returnToMenu();
      }
    }

    function playSelectSound() {
      if (game.soundEnabled && !game.isMuted) {
        selectSound.currentTime = 0;
        selectSound.play().catch(e => console.log("Audio play error:", e));
      }
    }

    function loadLeaderboards() {
      // Load from localStorage if available
      if (localStorage.getItem('pongRecentPlays')) {
        game.recentPlays = JSON.parse(localStorage.getItem('pongRecentPlays'));
      }
      
      if (localStorage.getItem('pongBestWins')) {
        game.bestWins = JSON.parse(localStorage.getItem('pongBestWins'));
      }
      
      if (localStorage.getItem('pongBotChampions')) {
        game.botChampions = JSON.parse(localStorage.getItem('pongBotChampions'));
      }
      
      updateLeaderboards();
    }

    function updateLeaderboards() {
      // Recent Plays - now includes bot matches
      const recentPlaysList = document.getElementById('recentPlaysList');
      if (recentPlaysList) {
        recentPlaysList.innerHTML = '';
        
        game.recentPlays.slice(0, 10).forEach((play, index) => {
          const item = document.createElement('div');
          item.className = 'leaderboard-item';
          const opponent = play.player2 === "BOT" ? "BOT" : play.player2;
          const timeAgo = getTimeAgo(play.timestamp);
          const difficulty = play.difficulty ? ` (${play.difficulty.toUpperCase()})` : '';
          item.innerHTML = `<strong>${play.player1}</strong> vs <strong>${opponent}${difficulty}</strong><br>
                           ${play.stage || "Match"} - ${play.score1}-${play.score2}
                           <div class="leaderboard-time">${timeAgo}</div>`;
          recentPlaysList.appendChild(item);
        });
      }
      
      // Best Wins
      const bestWinsList = document.getElementById('bestWinsList');
      if (bestWinsList) {
        bestWinsList.innerHTML = '';
        
        game.bestWins.sort((a, b) => (b.score1 - b.score2) - (a.score1 - a.score2)).slice(0, 10).forEach((win, index) => {
          const item = document.createElement('div');
          item.className = 'leaderboard-item';
          const timeAgo = getTimeAgo(win.timestamp);
          const difficulty = win.difficulty ? ` (${win.difficulty.toUpperCase()})` : '';
          item.innerHTML = `<span class="leaderboard-rank">${index + 1}.</span> 
                           <strong>${win.player1}</strong> ${win.score1}-${win.score2} <strong>${win.player2}${difficulty}</strong>
                           <div class="leaderboard-time">${timeAgo}</div>`;
          bestWinsList.appendChild(item);
        });
      }
      
      // Bot Champions
      const botChampionList = document.getElementById('botChampionList');
      if (botChampionList) {
        botChampionList.innerHTML = '';
        
        game.botChampions.sort((a, b) => (b.score1 - b.score2) - (a.score1 - a.score2)).slice(0, 20).forEach((champ, index) => {
          const item = document.createElement('div');
          item.className = 'leaderboard-item';
          const timeAgo = getTimeAgo(champ.timestamp);
          const difficulty = champ.difficulty ? ` (${champ.difficulty.toUpperCase()})` : '';
          item.innerHTML = `<span class="leaderboard-rank">${index + 1}.</span> 
                           <strong>${champ.player1}</strong> ${champ.score1}-${champ.score2} BOT${difficulty}
                           <div class="leaderboard-time">${timeAgo}</div>`;
          botChampionList.appendChild(item);
        });
      }
    }

    function getTimeAgo(timestamp) {
      const seconds = Math.floor((Date.now() - timestamp) / 1000);
      
      if (seconds < 60) return `${seconds} sec ago`;
      if (seconds < 3600) return `${Math.floor(seconds / 60)} min ago`;
      if (seconds < 86400) return `${Math.floor(seconds / 3600)} hr ago`;
      if (seconds < 604800) return `${Math.floor(seconds / 86400)}D ago`;
      if (seconds < 2592000) return `${Math.floor(seconds / 604800)}W ago`;
      if (seconds < 31536000) return `${Math.floor(seconds / 2592000)}M ago`;
      return `${Math.floor(seconds / 31536000)} yr ago`;
    }

    function saveToLeaderboard(type, data) {
      if (type === 'recent') {
        game.recentPlays.unshift(data);
        if (game.recentPlays.length > 50) game.recentPlays.pop();
        localStorage.setItem('pongRecentPlays', JSON.stringify(game.recentPlays));
      } 
      else if (type === 'best') {
        game.bestWins.push(data);
        if (game.bestWins.length > 50) game.bestWins.pop();
        localStorage.setItem('pongBestWins', JSON.stringify(game.bestWins));
      }
      else if (type === 'bot') {
        game.botChampions.push(data);
        if (game.botChampions.length > 50) game.botChampions.pop();
        localStorage.setItem('pongBotChampions', JSON.stringify(game.botChampions));
      }
      
      updateLeaderboards();
    }

    // Setup functions
    function resizeCanvas() {
      // Set canvas to full window size
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      particleCanvas.width = window.innerWidth;
      particleCanvas.height = window.innerHeight;
      
      // Calculate dynamic sizes based on canvas dimensions
      game.paddleWidth = Math.max(15, canvas.width * 0.015);
      game.paddleHeight = canvas.height * PADDLE_HEIGHT_RATIO;
      game.fourPlayerPaddleHeight = canvas.height * FOUR_PLAYER_PADDLE_HEIGHT_RATIO;
      game.ballRadius = Math.max(8, canvas.width * BALL_RADIUS_RATIO);
      
      // Reset game elements if game is already started
      if (game.gameStarted) {
        resetBall();
        resetPaddles();
      }
    }

    function setupMobileControls() {
      const upBtnLeft = document.getElementById('upBtnLeft');
      const downBtnLeft = document.getElementById('downBtnLeft');
      const upBtnRight = document.getElementById('upBtnRight');
      const downBtnRight = document.getElementById('downBtnRight');
      const powerBtnLeft = document.getElementById('powerBtnLeft');
      
      // Touch events
      const handleTouch = (btn, direction, isLeft) => (e) => {
        e.preventDefault();
        if (isLeft) {
          game.mobileControls.leftUp = direction === 'up';
          game.mobileControls.leftDown = direction === 'down';
        } else {
          game.mobileControls.rightUp = direction === 'up';
          game.mobileControls.rightDown = direction === 'down';
        }
      };
      
      if (upBtnLeft) upBtnLeft.addEventListener('touchstart', handleTouch(upBtnLeft, 'up', true));
      if (upBtnLeft) upBtnLeft.addEventListener('touchend', handleTouch(upBtnLeft, 'none', true));
      if (downBtnLeft) downBtnLeft.addEventListener('touchstart', handleTouch(downBtnLeft, 'down', true));
      if (downBtnLeft) downBtnLeft.addEventListener('touchend', handleTouch(downBtnLeft, 'none', true));
      if (upBtnRight) upBtnRight.addEventListener('touchstart', handleTouch(upBtnRight, 'up', false));
      if (upBtnRight) upBtnRight.addEventListener('touchend', handleTouch(upBtnRight, 'none', false));
      if (downBtnRight) downBtnRight.addEventListener('touchstart', handleTouch(downBtnRight, 'down', false));
      if (downBtnRight) downBtnRight.addEventListener('touchend', handleTouch(downBtnRight, 'none', false));
      
      // Power button
      if (powerBtnLeft) powerBtnLeft.addEventListener('touchstart', (e) => {
        e.preventDefault();
        game.mobileControls.leftPower = true;
      });
      if (powerBtnLeft) powerBtnLeft.addEventListener('touchend', (e) => {
        e.preventDefault();
        game.mobileControls.leftPower = false;
      });
      
      // Mouse events for desktop testing
      if (upBtnLeft) upBtnLeft.addEventListener('mousedown', () => game.mobileControls.leftUp = true);
      if (upBtnLeft) upBtnLeft.addEventListener('mouseup', () => game.mobileControls.leftUp = false);
      if (downBtnLeft) downBtnLeft.addEventListener('mousedown', () => game.mobileControls.leftDown = true);
      if (downBtnLeft) downBtnLeft.addEventListener('mouseup', () => game.mobileControls.leftDown = false);
      if (upBtnRight) upBtnRight.addEventListener('mousedown', () => game.mobileControls.rightUp = true);
      if (upBtnRight) upBtnRight.addEventListener('mouseup', () => game.mobileControls.rightUp = false);
      if (downBtnRight) downBtnRight.addEventListener('mousedown', () => game.mobileControls.rightDown = true);
      if (downBtnRight) downBtnRight.addEventListener('mouseup', () => game.mobileControls.rightDown = false);
      if (powerBtnLeft) powerBtnLeft.addEventListener('mousedown', () => game.mobileControls.leftPower = true);
      if (powerBtnLeft) powerBtnLeft.addEventListener('mouseup', () => game.mobileControls.leftPower = false);
      
      // Show mobile controls on mobile devices for 1P and 2P modes
      if (/Mobi|Android/i.test(navigator.userAgent)) {
        const mobileControls = document.getElementById('mobileControls');
        if (mobileControls) mobileControls.style.display = 'flex';
      }
    }

    function setupKeyboardControls() {
      // Handle both keydown and keypress events for better iPad compatibility
      document.addEventListener('keydown', handleKeyEvent);
      document.addEventListener('keypress', handleKeyEvent);
    }

    function handleKeyEvent(e) {
      switch(e.key) {
        case 'p':
        case 'P':
          togglePause();
          break;
        case 'm':
        case 'M':
          toggleMute();
          break;
        case 'f':
        case 'F':
          toggleFullscreen();
          break;
        case 'Escape':
          handleBackButton();
          break;
        case 'w':
        case 'W':
          game.keysPressed['w'] = true;
          break;
        case 's':
        case 'S':
          game.keysPressed['s'] = true;
          break;
        case 'ArrowUp':
          game.keysPressed['ArrowUp'] = true;
          break;
        case 'ArrowDown':
          game.keysPressed['ArrowDown'] = true;
          break;
        case 'q':
        case 'Q':
          game.keysPressed['q'] = true;
          break;
        case 'a':
        case 'A':
          game.keysPressed['a'] = true;
          break;
        case 'o':
        case 'O':
          game.keysPressed['o'] = true;
          break;
        case 'l':
        case 'L':
          game.keysPressed['l'] = true;
          break;
        case 'e':
        case 'E':
          if (!game.leftCharged && game.leftCharge >= 100 && !game.isFourPlayer) {
            activateLeftPowerShot();
          }
          break;
        case 'ArrowLeft':
          if (!game.rightCharged && game.rightCharge >= 100 && !game.isFourPlayer) {
            activateRightPowerShot();
          }
          break;
        case 'z':
        case 'Z':
          if (game.isFourPlayer && !game.teamLeftCharged && game.leftCharge >= 100) {
            activateTeamLeftPowerShot();
          }
          break;
        case 'k':
        case 'K':
          if (game.isFourPlayer && !game.teamRightCharged && game.rightCharge >= 100) {
            activateTeamRightPowerShot();
          }
          break;
      }
    }

    document.addEventListener('keyup', (e) => {
      switch(e.key) {
        case 'w':
        case 'W':
          game.keysPressed['w'] = false;
          break;
        case 's':
        case 'S':
          game.keysPressed['s'] = false;
          break;
        case 'ArrowUp':
          game.keysPressed['ArrowUp'] = false;
          break;
        case 'ArrowDown':
          game.keysPressed['ArrowDown'] = false;
          break;
        case 'q':
        case 'Q':
          game.keysPressed['q'] = false;
          break;
        case 'a':
        case 'A':
          game.keysPressed['a'] = false;
          break;
        case 'o':
        case 'O':
          game.keysPressed['o'] = false;
          break;
        case 'l':
        case 'L':
          game.keysPressed['l'] = false;
          break;
      }
    });

    function setupControlButtons() {
      const muteButton = document.getElementById('muteButton');
      const pauseButton = document.getElementById('pauseButton');
      const fullscreenButton = document.getElementById('fullscreenButton');
      const musicMuteButton = document.getElementById('musicMuteButton');
      
      if (muteButton) muteButton.addEventListener('click', toggleMute);
      if (pauseButton) pauseButton.addEventListener('click', togglePause);
      if (fullscreenButton) fullscreenButton.addEventListener('click', toggleFullscreen);
      if (musicMuteButton) musicMuteButton.addEventListener('click', toggleMusicMute);
    }

    function loadAudioFiles() {
      // Preload sound effects
      paddleSound.src = 'paddle.wav';
      scoreSound.src = 'score.mp3';
      scoreSound1.src = 'score1.mp3';
      scoreSound2.src = 'score2.mp3';
      hitSound.src = 'hit.mp3';
      hitSound1.src = 'hit1.mp3';
      hitSound2.src = 'hit2.mp3';
      hitSound3.src = 'hit3.mp3';
      hitSound4.src = 'hit4.mp3';
      etSound.src = 'et.mp3';
      gameOverSound.src = 'gameover.mp3';
      gameOverSound1.src = 'gameover1.mp3';
      selectSound.src = 'select.mp3';
      startSound.src = 'start.mp3';
      startSound1.src = 'start1.mp3';
      startSound2.src = 'start2.mp3';
      startSound3.src = 'start3.mp3';
      introSound.src = 'intro.mp3';
      introSound1.src = 'intro1.mp3';
      introSound2.src = 'intro2.mp3';
      introSound3.src = 'intro3.mp3';
    }

    function playRandomStartMusic() {
      if (!game.soundEnabled || game.isMusicMuted) return;
      
      const startTracks = [startSound, startSound1, startSound2, startSound3];
      const randomTrack = startTracks[Math.floor(Math.random() * startTracks.length)];
      
      randomTrack.currentTime = 0;
      randomTrack.volume = 0.5;
      randomTrack.play().catch(e => console.log("Audio play error:", e));
      
      randomTrack.onended = function() {
        playRandomGameMusic();
      };
    }

    function playRandomGameMusic() {
      if (!game.soundEnabled || game.isMusicMuted || !game.musicStarted) return;
      
      const musicTracks = ['music1.mp3', 'music2.mp3', 'music3.mp3', 'music4.mp3', 'music5.mp3', 'music6.mp3'];
      const randomTrack = musicTracks[Math.floor(Math.random() * musicTracks.length)];
      backgroundMusic.src = randomTrack;
      backgroundMusic.volume = 0.3;
      backgroundMusic.play().catch(e => console.log("Audio play error:", e));
      
      backgroundMusic.onended = function() {
        playRandomGameMusic();
      };
    }

    function playRandomScoreSound() {
      if (!game.soundEnabled || game.isMuted) return;
      
      const sounds = [scoreSound, scoreSound1, scoreSound2];
      const randomSound = sounds[Math.floor(Math.random() * sounds.length)];
      randomSound.currentTime = 0;
      randomSound.play().catch(e => console.log("Audio play error:", e));
    }

    function playRandomHitSound() {
      if (!game.soundEnabled || game.isMuted) return;
      
      const sounds = [hitSound, hitSound1, hitSound2, hitSound3, hitSound4];
      const randomSound = sounds[Math.floor(Math.random() * sounds.length)];
      randomSound.currentTime = 0;
      randomSound.play().catch(e => console.log("Audio play error:", e));
    }

    function playGameOverSound() {
      if (!game.soundEnabled || game.isMuted) return;
      
      const sounds = [gameOverSound, gameOverSound1];
      const randomSound = sounds[Math.floor(Math.random() * sounds.length)];
      randomSound.currentTime = 0;
      randomSound.volume = 0.5;
      randomSound.play().catch(e => console.log("Audio play error:", e));
    }

    function playETSound() {
      if (!game.soundEnabled || game.isMuted) return;
      
      etSound.currentTime = 0;
      etSound.volume = 0.5;
      etSound.play().catch(e => console.log("Audio play error:", e));
    }

    // Game control functions
    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => {
          console.log(`Fullscreen error: ${err.message}`);
        });
      } else {
        if (document.exitFullscreen) {
          document.exitFullscreen();
        }
      }
    }

    // Game logic functions
    function resetBall() {
      game.ball.x = canvas.width / 2;
      game.ball.y = canvas.height / 2;
      game.ball.speed = game.isFourPlayer ? FOUR_PLAYER_BALL_SPEED : INITIAL_BALL_SPEED;
      game.ball.originalSpeed = game.ball.speed;
      game.ball.dx = Math.random() > 0.5 ? game.ball.speed * 0.6 : -game.ball.speed * 0.6;
      game.ball.dy = (Math.random() * 2 - 1) * game.ball.speed * 0.6;
      
      // Reset smash counter
      game.smashCounter = 0;
      game.smashTarget = Math.floor(Math.random() * 5) + 3; // 3-7 hits
      
      // Randomly select ball color (white or black)
      game.ballColor = Math.random() > 0.5 ? 'white' : 'black';
    }

    function resetPaddles() {
      const paddleHeight = game.isFourPlayer ? game.fourPlayerPaddleHeight : game.paddleHeight;
      const centerY = (canvas.height - paddleHeight) / 2;
      
      game.leftPaddle.y = centerY;
      game.rightPaddle.y = centerY;
      
      // Randomly select paddle colors (white or black)
      game.leftPaddleColor = Math.random() > 0.5 ? 'white' : 'black';
      game.rightPaddleColor = Math.random() > 0.5 ? 'white' : 'black';
      
      if (game.isFourPlayer) {
        game.leftTopPaddle.y = canvas.height * 0.25 - paddleHeight/2;
        game.leftBottomPaddle.y = canvas.height * 0.75 - paddleHeight/2;
        game.rightTopPaddle.y = canvas.height * 0.25 - paddleHeight/2;
        game.rightBottomPaddle.y = canvas.height * 0.75 - paddleHeight/2;
      }
    }

    function constrainPaddles() {
      const paddleHeight = game.isFourPlayer ? game.fourPlayerPaddleHeight : game.paddleHeight;
      
      if (!game.isFourPlayer) {
        game.leftPaddle.y = Math.max(0, Math.min(canvas.height - paddleHeight, game.leftPaddle.y));
        game.rightPaddle.y = Math.max(0, Math.min(canvas.height - paddleHeight, game.rightPaddle.y));
      } else {
        game.leftTopPaddle.y = Math.max(0, Math.min(canvas.height - paddleHeight, game.leftTopPaddle.y));
        game.leftBottomPaddle.y = Math.max(0, Math.min(canvas.height - paddleHeight, game.leftBottomPaddle.y));
        game.rightTopPaddle.y = Math.max(0, Math.min(canvas.height - paddleHeight, game.rightTopPaddle.y));
        game.rightBottomPaddle.y = Math.max(0, Math.min(canvas.height - paddleHeight, game.rightBottomPaddle.y));
      }
    }

    function startLeftCharge() {
      if (game.leftChargeInterval) clearInterval(game.leftChargeInterval);
      
      game.leftCharge = 0;
      const leftChargeElement = document.getElementById('leftCharge');
      const leftChargeLabel = document.getElementById('leftChargeLabel');
      
      if (leftChargeElement) leftChargeElement.style.width = '0';
      if (leftChargeElement) leftChargeElement.classList.remove('active');
      if (leftChargeLabel) leftChargeLabel.textContent = 'P1 POWER';
      
      game.leftChargeInterval = setInterval(() => {
        game.leftCharge += 100 / (CHARGE_TIME / 100);
        if (leftChargeElement) leftChargeElement.style.width = `${game.leftCharge}%`;
        
        if (game.leftCharge >= 100) {
          clearInterval(game.leftChargeInterval);
          if (leftChargeElement) leftChargeElement.classList.add('active');
          if (leftChargeLabel) leftChargeLabel.textContent = 'P1 READY!';
        }
      }, 100);
    }

    function startRightCharge() {
      if (game.rightChargeInterval) clearInterval(game.rightChargeInterval);
      
      game.rightCharge = 0;
      const rightChargeElement = document.getElementById('rightCharge');
      const rightChargeLabel = document.getElementById('rightChargeLabel');
      
      if (rightChargeElement) rightChargeElement.style.width = '0';
      if (rightChargeElement) rightChargeElement.classList.remove('active');
      if (rightChargeLabel) rightChargeLabel.textContent = game.isLocalMultiplayer ? 'P2 POWER' : 'BOT POWER';
      
      game.rightChargeInterval = setInterval(() => {
        game.rightCharge += 100 / (CHARGE_TIME / 100);
        if (rightChargeElement) rightChargeElement.style.width = `${game.rightCharge}%`;
        
        if (game.rightCharge >= 100) {
          clearInterval(game.rightChargeInterval);
          if (rightChargeElement) rightChargeElement.classList.add('active');
          if (rightChargeLabel) rightChargeLabel.textContent = game.isLocalMultiplayer ? 'P2 READY!' : 'BOT READY!';
        }
      }, 100);
    }

    function activateLeftPowerShot() {
      game.leftCharged = true;
      game.leftChargeEndTime = Date.now() + POWER_SHOT_DURATION;
      const leftChargeElement = document.getElementById('leftCharge');
      const leftChargeLabel = document.getElementById('leftChargeLabel');
      
      if (leftChargeElement) leftChargeElement.classList.add('active');
      if (leftChargeLabel) leftChargeLabel.textContent = 'P1 FIRING!';
      
      setTimeout(() => {
        if (Date.now() > game.leftChargeEndTime) {
          game.leftCharged = false;
          if (leftChargeElement) leftChargeElement.classList.remove('active');
          if (leftChargeLabel) leftChargeLabel.textContent = 'P1 POWER';
          startLeftCharge();
        }
      }, POWER_SHOT_DURATION);
    }

    function activateRightPowerShot() {
      game.rightCharged = true;
      game.rightChargeEndTime = Date.now() + POWER_SHOT_DURATION;
      const rightChargeElement = document.getElementById('rightCharge');
      const rightChargeLabel = document.getElementById('rightChargeLabel');
      
      if (rightChargeElement) rightChargeElement.classList.add('active');
      if (rightChargeLabel) rightChargeLabel.textContent = game.isLocalMultiplayer ? 'P2 FIRING!' : 'BOT FIRING!';
      
      setTimeout(() => {
        if (Date.now() > game.rightChargeEndTime) {
          game.rightCharged = false;
          if (rightChargeElement) rightChargeElement.classList.remove('active');
          if (rightChargeLabel) rightChargeLabel.textContent = game.isLocalMultiplayer ? 'P2 POWER' : 'BOT POWER';
          startRightCharge();
        }
      }, POWER_SHOT_DURATION);
    }

    function activateTeamLeftPowerShot() {
      game.teamLeftCharged = true;
      game.leftChargeEndTime = Date.now() + POWER_SHOT_DURATION;
      const leftChargeElement = document.getElementById('leftCharge');
      const leftChargeLabel = document.getElementById('leftChargeLabel');
      
      if (leftChargeElement) leftChargeElement.classList.add('active');
      if (leftChargeLabel) leftChargeLabel.textContent = 'TEAM FIRING!';
      
      setTimeout(() => {
        if (Date.now() > game.leftChargeEndTime) {
          game.teamLeftCharged = false;
          if (leftChargeElement) leftChargeElement.classList.remove('active');
          if (leftChargeLabel) leftChargeLabel.textContent = 'TEAM POWER';
          startLeftCharge();
        }
      }, POWER_SHOT_DURATION);
    }

    function activateTeamRightPowerShot() {
      game.teamRightCharged = true;
      game.rightChargeEndTime = Date.now() + POWER_SHOT_DURATION;
      const rightChargeElement = document.getElementById('rightCharge');
      const rightChargeLabel = document.getElementById('rightChargeLabel');
      
      if (rightChargeElement) rightChargeElement.classList.add('active');
      if (rightChargeLabel) rightChargeLabel.textContent = 'TEAM FIRING!';
      
      setTimeout(() => {
        if (Date.now() > game.rightChargeEndTime) {
          game.teamRightCharged = false;
          if (rightChargeElement) rightChargeElement.classList.remove('active');
          if (rightChargeLabel) rightChargeLabel.textContent = 'TEAM POWER';
          startRightCharge();
        }
      }, POWER_SHOT_DURATION);
    }

    // Drawing functions
    function drawPaddles() {
      const paddleHeight = game.isFourPlayer ? game.fourPlayerPaddleHeight : game.paddleHeight;
      
      if (!game.isFourPlayer) {
        // Left paddle
        ctx.fillStyle = game.leftPaddleColor;
        ctx.shadowBlur = 0;
        
        if (game.leftCharged || (game.last10Seconds && game.lastScorer === game.leftPlayer)) {
          // Draw fire effect for powered paddle
          ctx.fillStyle = 'gold';
          ctx.shadowBlur = 15;
          ctx.shadowColor = 'orange';
          
          // Draw fire particles
          if (game.leftCharged) {
            for (let i = 0; i < 3; i++) {
              const particle = {
                x: 20 + game.paddleWidth,
                y: game.leftPaddle.y + Math.random() * paddleHeight,
                size: Math.random() * 5 + 3,
                color: `hsl(${20 + Math.random() * 20}, 100%, 50%)`,
                life: 30 + Math.random() * 20,
                vx: -1 - Math.random() * 2,
                vy: -1 + Math.random() * 2
              };
              game.particles.push(particle);
            }
          }
        }
        ctx.fillRect(20, game.leftPaddle.y, game.paddleWidth, paddleHeight);
        
        // Right paddle
        ctx.fillStyle = game.rightPaddleColor;
        ctx.shadowBlur = 0;
        
        if (game.rightCharged || (game.last10Seconds && game.lastScorer === game.rightPlayer)) {
          // Draw fire effect for powered paddle
          ctx.fillStyle = 'gold';
          ctx.shadowBlur = 15;
          ctx.shadowColor = 'orange';
          
          // Draw fire particles
          if (game.rightCharged) {
            for (let i = 0; i < 3; i++) {
              const particle = {
                x: canvas.width - 20,
                y: game.rightPaddle.y + Math.random() * paddleHeight,
                size: Math.random() * 5 + 3,
                color: `hsl(${20 + Math.random() * 20}, 100%, 50%)`,
                life: 30 + Math.random() * 20,
                vx: 1 + Math.random() * 2,
                vy: -1 + Math.random() * 2
              };
              game.particles.push(particle);
            }
          }
        }
        ctx.fillRect(canvas.width - 20 - game.paddleWidth, game.rightPaddle.y, game.paddleWidth, paddleHeight);
      } else {
        // 4-player paddles
        ctx.fillStyle = game.leftPaddleColor;
        ctx.shadowBlur = 0;
        
        // Left team (top and bottom)
        if (game.teamLeftCharged || (game.last10Seconds && game.lastScorer === game.leftPlayer)) {
          ctx.fillStyle = 'gold';
          ctx.shadowBlur = 15;
          ctx.shadowColor = 'orange';
          
          // Draw fire particles
          if (game.teamLeftCharged) {
            for (let i = 0; i < 3; i++) {
              const particle = {
                x: 20 + game.paddleWidth,
                y: (Math.random() > 0.5 ? game.leftTopPaddle.y : game.leftBottomPaddle.y) + Math.random() * paddleHeight,
                size: Math.random() * 5 + 3,
                color: `hsl(${20 + Math.random() * 20}, 100%, 50%)`,
                life: 30 + Math.random() * 20,
                vx: -1 - Math.random() * 2,
                vy: -1 + Math.random() * 2
              };
              game.particles.push(particle);
            }
          }
        }
        ctx.fillRect(20, game.leftTopPaddle.y, game.paddleWidth, paddleHeight);
        ctx.fillRect(20, game.leftBottomPaddle.y, game.paddleWidth, paddleHeight);
        
        // Right team (top and bottom)
        ctx.fillStyle = game.rightPaddleColor;
        ctx.shadowBlur = 0;
        
        if (game.teamRightCharged || (game.last10Seconds && game.lastScorer === game.rightPlayer)) {
          // Draw fire effect for powered paddle
          ctx.fillStyle = 'gold';
          ctx.shadowBlur = 15;
          ctx.shadowColor = 'orange';
          
          // Draw fire particles
          if (game.teamRightCharged) {
            for (let i = 0; i < 3; i++) {
              const particle = {
                x: canvas.width - 20,
                y: (Math.random() > 0.5 ? game.rightTopPaddle.y : game.rightBottomPaddle.y) + Math.random() * paddleHeight,
                size: Math.random() * 5 + 3,
                color: `hsl(${20 + Math.random() * 20}, 100%, 50%)`,
                life: 30 + Math.random() * 20,
                vx: 1 + Math.random() * 2,
                vy: -1 + Math.random() * 2
              };
              game.particles.push(particle);
            }
          }
        }
        ctx.fillRect(canvas.width - 20 - game.paddleWidth, game.rightTopPaddle.y, game.paddleWidth, paddleHeight);
        ctx.fillRect(canvas.width - 20 - game.paddleWidth, game.rightBottomPaddle.y, game.paddleWidth, paddleHeight);
      }
      ctx.shadowBlur = 0; // Reset shadow
    }

    function drawBall() {
      ctx.beginPath();
      ctx.arc(game.ball.x, game.ball.y, game.ballRadius, 0, Math.PI * 2);
      
      // Change ball color during smash or last 10 seconds
      if (game.isSmashActive || game.last10Seconds) {
        const gradient = ctx.createRadialGradient(
          game.ball.x, game.ball.y, 0,
          game.ball.x, game.ball.y, game.ballRadius
        );
        gradient.addColorStop(0, 'yellow');
        gradient.addColorStop(0.5, 'orange');
        gradient.addColorStop(1, 'red');
        ctx.fillStyle = gradient;
        ctx.shadowBlur = 10;
        ctx.shadowColor = 'orange';
        
        // Add fire trail particles
        if (game.isSmashActive) {
          for (let i = 0; i < 3; i++) {
            const particle = {
              x: game.ball.x,
              y: game.ball.y,
              size: Math.random() * 4 + 2,
              color: `hsl(${20 + Math.random() * 20}, 100%, 50%)`,
              life: 20 + Math.random() * 10,
              vx: -game.ball.dx * 0.1 * Math.random(),
              vy: -game.ball.dy * 0.1 * Math.random()
            };
            game.particles.push(particle);
          }
        }
      } else {
        ctx.fillStyle = game.ballColor;
        ctx.shadowBlur = 0;
      }
      
      ctx.fill();
      ctx.closePath();
      ctx.shadowBlur = 0; // Reset shadow
    }

    function drawNet() {
      ctx.setLineDash([8, 12]);
      ctx.beginPath();
      ctx.moveTo(canvas.width / 2, 0);
      ctx.lineTo(canvas.width / 2, canvas.height);
      ctx.strokeStyle = 'rgba(255,255,255,0.5)';
      ctx.lineWidth = 2;
      ctx.stroke();
      ctx.setLineDash([]);
    }

    function updateParticles() {
      particleCtx.clearRect(0, 0, particleCanvas.width, particleCanvas.height);
      
      for (let i = game.particles.length - 1; i >= 0; i--) {
        const p = game.particles[i];
        
        // Update particle
        p.x += p.vx;
        p.y += p.vy;
        p.life--;
        
        // Draw particle
        if (p.life > 0) {
          particleCtx.globalAlpha = p.life / 50;
          particleCtx.fillStyle = p.color;
          particleCtx.beginPath();
          particleCtx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
          particleCtx.fill();
        } else {
          game.particles.splice(i, 1);
        }
      }
    }

    // Game loop functions
    function gameLoop(timestamp) {
      if (!game.gameStarted || game.isPaused || game.halftimeActive) {
        requestAnimationFrame(gameLoop);
        return;
      }

      // Clear canvas
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // Calculate delta time for smooth animation
      const deltaTime = timestamp - game.lastFrameTime;
      game.lastFrameTime = timestamp;
      
      drawPaddles();
      drawBall();
      drawNet();
      updateParticles();

      updateBall(deltaTime);
      updatePaddles(deltaTime);
      checkCollisions();
      checkSmash();

      requestAnimationFrame(gameLoop);
    }

    function updateBall(deltaTime) {
      if (game.isPaused || game.halftimeActive) return;
      
      // Normalize speed based on frame rate
      const speedFactor = deltaTime / 16; // 16ms is ~60fps
      
      // Prevent ball from getting stuck at edges
      if (game.ball.y - game.ballRadius <= 0) {
        game.ball.y = game.ballRadius + 1;
        game.ball.dy = Math.abs(game.ball.dy);
      }
      
      if (game.ball.y + game.ballRadius >= canvas.height) {
        game.ball.y = canvas.height - game.ballRadius - 1;
        game.ball.dy = -Math.abs(game.ball.dy);
      }
      
      game.ball.x += game.ball.dx * speedFactor;
      game.ball.y += game.ball.dy * speedFactor;

      // Ball collision with top and bottom
      if (game.ball.y - game.ballRadius < 0 || game.ball.y + game.ballRadius > canvas.height) {
        game.ball.dy = -game.ball.dy;
      }
    }

    function updatePaddles(deltaTime) {
      if (game.isPaused || game.halftimeActive) return;

      // Normalize speed based on frame rate
      const speedFactor = deltaTime / 16; // 16ms is ~60fps
      const paddleSpeed = PADDLE_SPEED * speedFactor;

      // Mobile controls
      if (game.mobileControls.leftUp) game.leftPaddle.y -= paddleSpeed;
      if (game.mobileControls.leftDown) game.leftPaddle.y += paddleSpeed;
      if (game.mobileControls.rightUp) game.rightPaddle.y -= paddleSpeed;
      if (game.mobileControls.rightDown) game.rightPaddle.y += paddleSpeed;
      
      // Mobile power button
      if (game.mobileControls.leftPower && !game.leftCharged && game.leftCharge >= 100) {
        activateLeftPowerShot();
      }

      // Keyboard controls
      if (!game.isFourPlayer) {
        if (game.isLocalMultiplayer || game.isPracticeMode || game.isEndlessMode) {
          if (game.keysPressed['w'] || game.keysPressed['W']) game.leftPaddle.y -= paddleSpeed;
          if (game.keysPressed['s'] || game.keysPressed['S']) game.leftPaddle.y += paddleSpeed;
          if (game.keysPressed['ArrowUp']) game.rightPaddle.y -= paddleSpeed;
          if (game.keysPressed['ArrowDown']) game.rightPaddle.y += paddleSpeed;
        } else {
          // Player controls
          if (game.keysPressed['w'] || game.keysPressed['W']) game.leftPaddle.y -= paddleSpeed;
          if (game.keysPressed['s'] || game.keysPressed['S']) game.leftPaddle.y += paddleSpeed;
          
          // AI for right paddle in single player
          const paddleCenter = game.rightPaddle.y + game.paddleHeight / 2;
          const predictedBallY = game.ball.y + (game.ball.dy * (canvas.width - game.ball.x) / Math.abs(game.ball.dx));
          
          // Adjust AI difficulty
          let reactionSpeed;
          switch(game.aiDifficulty) {
            case 'easy':
              reactionSpeed = 0.5 * (1 + Math.random() * 0.3 - 0.15); // Slower and more random
              break;
            case 'hard':
              reactionSpeed = 0.9 * (1 + Math.random() * 0.1 - 0.05); // Faster and more precise
              break;
            default: // medium
              reactionSpeed = 0.7 * (1 + Math.random() * 0.2 - 0.1);
          }
          
          if (paddleCenter < predictedBallY - 15) {
            game.rightPaddle.y += paddleSpeed * reactionSpeed;
          } else if (paddleCenter > predictedBallY + 15) {
            game.rightPaddle.y -= paddleSpeed * reactionSpeed;
          }
          
          // AI power shot
          if (!game.rightCharged && game.rightCharge >= 100 && Math.random() < 0.01) {
            activateRightPowerShot();
          }
        }
      } else {
        // 4-player controls
        if (game.keysPressed['w'] || game.keysPressed['W']) game.leftTopPaddle.y -= paddleSpeed;
        if (game.keysPressed['s'] || game.keysPressed['S']) game.leftTopPaddle.y += paddleSpeed;
        if (game.keysPressed['q'] || game.keysPressed['Q']) game.leftBottomPaddle.y -= paddleSpeed;
        if (game.keysPressed['a'] || game.keysPressed['A']) game.leftBottomPaddle.y += paddleSpeed;
        if (game.keysPressed['o'] || game.keysPressed['O']) game.rightTopPaddle.y -= paddleSpeed;
        if (game.keysPressed['l'] || game.keysPressed['L']) game.rightTopPaddle.y += paddleSpeed;
        if (game.keysPressed['ArrowUp']) game.rightBottomPaddle.y -= paddleSpeed;
        if (game.keysPressed['ArrowDown']) game.rightBottomPaddle.y += paddleSpeed;
      }
      
      constrainPaddles();
    }

    function checkCollisions() {
      if (game.isPaused || game.halftimeActive) return;
      
      const paddleHeight = game.isFourPlayer ? game.fourPlayerPaddleHeight : game.paddleHeight;

      // Ball collision with paddles
      if (!game.isFourPlayer) {
        // Left paddle collision
        if (game.ball.x - game.ballRadius < 20 + game.paddleWidth &&
            game.ball.y > game.leftPaddle.y &&
            game.ball.y < game.leftPaddle.y + paddleHeight) {
          const angle = getBallAngle(game.leftPaddle.y, game.ball.y, paddleHeight);
          
          // Check for power shot
          if (game.leftCharged || game.last10Seconds) {
            game.ball.dx = Math.abs(Math.cos(angle)) * game.ball.speed * SMASH_SPEED_MULTIPLIER;
            game.ball.dy = Math.sin(angle) * game.ball.speed * SMASH_SPEED_MULTIPLIER;
            game.isSmashActive = true;
            game.smashEndTime = Date.now() + SMASH_DURATION;
            game.leftCharged = false;
            const leftChargeElement = document.getElementById('leftCharge');
            const leftChargeLabel = document.getElementById('leftChargeLabel');
            if (leftChargeElement) leftChargeElement.classList.remove('active');
            if (leftChargeLabel) leftChargeLabel.textContent = 'P1 POWER';
            startLeftCharge();
            if (!game.isPracticeMode && !game.isEndlessMode) {
              queueCommentary("POWER SHOT FROM " + game.leftPlayer + "!", true, true);
            }
          } else {
            game.ball.dx = Math.abs(Math.cos(angle)) * game.ball.speed;
            game.ball.dy = Math.sin(angle) * game.ball.speed;
          }
          
          // Increase ball speed but cap at MAX_BALL_SPEED
          if (game.ball.speed < MAX_BALL_SPEED) {
            game.ball.speed += BALL_SPEED_INCREMENT;
            game.ball.originalSpeed = game.ball.speed;
          }
          
          game.lastScorer = game.leftPlayer;
          playRandomHitSound();
        }
        
        // Right paddle collision
        if (game.ball.x + game.ballRadius > canvas.width - 20 - game.paddleWidth &&
            game.ball.y > game.rightPaddle.y &&
            game.ball.y < game.rightPaddle.y + paddleHeight) {
          const angle = getBallAngle(game.rightPaddle.y, game.ball.y, paddleHeight);
          
          // Check for power shot
          if (game.rightCharged || game.last10Seconds) {
            game.ball.dx = -Math.abs(Math.cos(angle)) * game.ball.speed * SMASH_SPEED_MULTIPLIER;
            game.ball.dy = Math.sin(angle) * game.ball.speed * SMASH_SPEED_MULTIPLIER;
            game.isSmashActive = true;
            game.smashEndTime = Date.now() + SMASH_DURATION;
            game.rightCharged = false;
            const rightChargeElement = document.getElementById('rightCharge');
            const rightChargeLabel = document.getElementById('rightChargeLabel');
            if (rightChargeElement) rightChargeElement.classList.remove('active');
            if (rightChargeLabel) rightChargeLabel.textContent = game.isLocalMultiplayer ? 'P2 POWER' : 'BOT POWER';
            startRightCharge();
            if (!game.isPracticeMode && !game.isEndlessMode) {
              queueCommentary("POWER SHOT FROM " + game.rightPlayer + "!", true, true);
            }
          } else {
            game.ball.dx = -Math.abs(Math.cos(angle)) * game.ball.speed;
            game.ball.dy = Math.sin(angle) * game.ball.speed;
          }
          
          // Increase ball speed but cap at MAX_BALL_SPEED
          if (game.ball.speed < MAX_BALL_SPEED) {
            game.ball.speed += BALL_SPEED_INCREMENT;
            game.ball.originalSpeed = game.ball.speed;
          }
          
          game.lastScorer = game.rightPlayer;
          playRandomHitSound();
        }
      } else {
        // 4-player paddle collisions
        // Left side paddles
        if (game.ball.x - game.ballRadius < 20 + game.paddleWidth) {
          if ((game.ball.y > game.leftTopPaddle.y && game.ball.y < game.leftTopPaddle.y + paddleHeight) ||
              (game.ball.y > game.leftBottomPaddle.y && game.ball.y < game.leftBottomPaddle.y + paddleHeight)) {
            const paddle = game.ball.y < canvas.height/2 ? game.leftTopPaddle : game.leftBottomPaddle;
            const angle = getBallAngle(paddle.y, game.ball.y, paddleHeight);
            
            // Check for team power shot
            if (game.teamLeftCharged || game.last10Seconds) {
              game.ball.dx = Math.abs(Math.cos(angle)) * game.ball.speed * SMASH_SPEED_MULTIPLIER;
              game.ball.dy = Math.sin(angle) * game.ball.speed * SMASH_SPEED_MULTIPLIER;
              game.isSmashActive = true;
              game.smashEndTime = Date.now() + SMASH_DURATION;
              game.teamLeftCharged = false;
              const leftChargeElement = document.getElementById('leftCharge');
              const leftChargeLabel = document.getElementById('leftChargeLabel');
              if (leftChargeElement) leftChargeElement.classList.remove('active');
              if (leftChargeLabel) leftChargeLabel.textContent = 'TEAM POWER';
              startLeftCharge();
              queueCommentary("TEAM POWER SHOT FROM " + game.leftPlayer + "!", true, true);
            } else {
              game.ball.dx = Math.abs(Math.cos(angle)) * game.ball.speed;
              game.ball.dy = Math.sin(angle) * game.ball.speed;
            }
            
            // Increase ball speed but cap at MAX_BALL_SPEED
            if (game.ball.speed < MAX_BALL_SPEED) {
              game.ball.speed += BALL_SPEED_INCREMENT;
              game.ball.originalSpeed = game.ball.speed;
            }
            
            game.lastScorer = game.leftPlayer;
            playRandomHitSound();
          }
        }
        
        // Right side paddles
        if (game.ball.x + game.ballRadius > canvas.width - 20 - game.paddleWidth) {
          if ((game.ball.y > game.rightTopPaddle.y && game.ball.y < game.rightTopPaddle.y + paddleHeight) ||
              (game.ball.y > game.rightBottomPaddle.y && game.ball.y < game.rightBottomPaddle.y + paddleHeight)) {
            const paddle = game.ball.y < canvas.height/2 ? game.rightTopPaddle : game.rightBottomPaddle;
            const angle = getBallAngle(paddle.y, game.ball.y, paddleHeight);
            
            // Check for team power shot
            if (game.teamRightCharged || game.last10Seconds) {
              game.ball.dx = -Math.abs(Math.cos(angle)) * game.ball.speed * SMASH_SPEED_MULTIPLIER;
              game.ball.dy = Math.sin(angle) * game.ball.speed * SMASH_SPEED_MULTIPLIER;
              game.isSmashActive = true;
              game.smashEndTime = Date.now() + SMASH_DURATION;
              game.teamRightCharged = false;
              const rightChargeElement = document.getElementById('rightCharge');
              const rightChargeLabel = document.getElementById('rightChargeLabel');
              if (rightChargeElement) rightChargeElement.classList.remove('active');
              if (rightChargeLabel) rightChargeLabel.textContent = 'TEAM POWER';
              startRightCharge();
              queueCommentary("TEAM POWER SHOT FROM " + game.rightPlayer + "!", true, true);
            } else {
              game.ball.dx = -Math.abs(Math.cos(angle)) * game.ball.speed;
              game.ball.dy = Math.sin(angle) * game.ball.speed;
            }
            
            // Increase ball speed but cap at MAX_BALL_SPEED
            if (game.ball.speed < MAX_BALL_SPEED) {
              game.ball.speed += BALL_SPEED_INCREMENT;
              game.ball.originalSpeed = game.ball.speed;
            }
            
            game.lastScorer = game.rightPlayer;
            playRandomHitSound();
          }
        }
      }
      
      // Ball out of bounds - scoring
      if (game.ball.x - game.ballRadius < 0) {
        if (!game.isPracticeMode && !game.isEndlessMode) {
          game.rightPaddle.score++;
          document.getElementById('rightScore').textContent = game.rightPaddle.score;
          game.lastScorer = game.rightPlayer;
          handleScore();
        } else if (game.isPracticeMode && game.practiceType === 'responding') {
          // In practice mode, just reset the ball
          resetBall();
          game.ball.dx = -Math.abs(game.ball.dx);
          queueCommentary("Try again! Press E for a power shot!", true);
        } else if (game.isEndlessMode) {
          resetBall();
          game.ball.dx = -Math.abs(game.ball.dx);
        }
      }

      if (game.ball.x + game.ballRadius > canvas.width) {
        if (!game.isPracticeMode && !game.isEndlessMode) {
          game.leftPaddle.score++;
          document.getElementById('leftScore').textContent = game.leftPaddle.score;
          game.lastScorer = game.leftPlayer;
          handleScore();
        } else if (game.isPracticeMode || game.isEndlessMode) {
          // In practice/endless mode, just reset the ball
          resetBall();
          game.ball.dx = Math.abs(game.ball.dx);
          if (game.isPracticeMode && game.practiceType === 'powershot') {
            queueCommentary("Great! Now try again!", true);
          }
        }
      }

      // Deuce (tie) situation
      if (!game.isPracticeMode && !game.isEndlessMode) {
        if (game.leftPaddle.score >= 5 && game.rightPaddle.score >= 5 && 
            game.leftPaddle.score === game.rightPaddle.score && !game.deuceActive) {
          game.deuceActive = true;
          game.bonusPoints++;
          const bonusPointsElement = document.getElementById('bonusPoints');
          if (bonusPointsElement) bonusPointsElement.textContent = `‚ö° BONUS POINT: +${game.bonusPoints}`;
          queueCommentary("WE'RE AT DEUCE! BONUS POINT ACTIVATED! NEXT POINT WINS!", true, true);
        } else if (game.leftPaddle.score !== game.rightPaddle.score) {
          game.deuceActive = false;
        }
      }
    }

    function checkSmash() {
      if (game.isSmashActive && Date.now() > game.smashEndTime) {
        game.isSmashActive = false;
        
        // Return to original speed but maintain direction
        const angle = Math.atan2(game.ball.dy, game.ball.dx);
        game.ball.speed = game.ball.originalSpeed;
        game.ball.dx = Math.cos(angle) * game.ball.speed;
        game.ball.dy = Math.sin(angle) * game.ball.speed;
      }
    }

    function getBallAngle(paddleY, hitY, paddleHeight) {
      const relativeY = (hitY - paddleY) / paddleHeight;
      const normalizedY = (relativeY * 2) - 1;
      return normalizedY * Math.PI / 3;
    }

    function handleScore() {
      const winningThreshold = WINNING_SCORE + game.bonusPoints;

      if (game.betweenPointsTimeout) {
        clearTimeout(game.betweenPointsTimeout);
        game.betweenPointsTimeout = null;
      }

      // Play random score sound
      playRandomScoreSound();

      if (checkForSpecialMove()) {
        queueCommentary("OH MY GOODNESS! WHAT AN INCREDIBLE SHOT!", true, true);
      }
      else if ((game.leftPaddle.score === winningThreshold - 1 || 
               game.rightPaddle.score === winningThreshold - 1) && !game.matchPoint) {
        game.matchPoint = true;
        const leader = game.leftPaddle.score > game.rightPaddle.score ? game.leftPlayer : game.rightPlayer;
        queueCommentary(`THIS IS IT! CHAMPIONSHIP POINT FOR ${leader}!`, true, true);
      }
      else {
        queueCommentary(`${game.lastScorer} SCORES! ${getRandomCommentary()}`, true);
      }

      if (game.leftPaddle.score >= winningThreshold || game.rightPaddle.score >= winningThreshold) {
        endGame();
        return;
      }

      if (Math.random() < 0.3) {
        game.betweenPointsTimeout = setTimeout(() => {
          queueCommentary(getRandomCommentary());
        }, 1500);
      }

      resetBall();
    }

    function getRandomCommentary() {
      return commentaryPhrases[Math.floor(Math.random() * commentaryPhrases.length)];
    }

    function checkForSpecialMove() {
      const speedThreshold = game.isFourPlayer ? FOUR_PLAYER_BALL_SPEED * 1.5 : MAX_BALL_SPEED * 0.8;
      const now = Date.now();
      
      if (game.ball.speed >= speedThreshold && now - game.lastSpecialMoveTime > 5000) {
        game.lastSpecialMoveTime = now;
        return true;
      }
      return false;
    }

    // Game management functions
    function showTwoPlayerPrompt() {
      document.getElementById('twoPlayerPrompt').style.display = 'flex';
      document.getElementById('backButton').style.display = 'flex';
      document.getElementById('leftPlayerName').focus();
      playSelectSound();
    }

    function cancelTwoPlayerPrompt() {
      document.getElementById('twoPlayerPrompt').style.display = 'none';
      document.getElementById('backButton').style.display = 'none';
      playSelectSound();
    }

    function submitTwoPlayerNames() {
      const leftName = document.getElementById('leftPlayerName').value.trim() || "PLAYER 1";
      const rightName = document.getElementById('rightPlayerName').value.trim() || "PLAYER 2";
      const stage = document.getElementById('selectedStage').value;
      
      game.leftPlayer = leftName.toUpperCase();
      game.rightPlayer = rightName.toUpperCase();
      game.tournamentStage = stage;
      game.isLocalMultiplayer = true;
      game.isFourPlayer = false;
      game.isPracticeMode = false;
      game.isEndlessMode = false;
      
      document.getElementById('twoPlayerPrompt').style.display = 'none';
      document.getElementById('backButton').style.display = 'none';
      startGame();
      playSelectSound();
    }

    function showSinglePlayerPrompt() {
      document.getElementById('singlePlayerPrompt').style.display = 'flex';
      document.getElementById('backButton').style.display = 'flex';
      document.getElementById('playerName').focus();
      playSelectSound();
    }

    function cancelSinglePlayerPrompt() {
      document.getElementById('singlePlayerPrompt').style.display = 'none';
      document.getElementById('backButton').style.display = 'none';
      playSelectSound();
    }

    function submitSinglePlayerName() {
      const playerName = document.getElementById('playerName').value.trim() || "PLAYER";
      const difficulty = document.getElementById('selectedDifficulty').value;
      
      game.leftPlayer = playerName.toUpperCase();
      game.rightPlayer = "BOT";
      game.aiDifficulty = difficulty;
      game.isLocalMultiplayer = false;
      game.isFourPlayer = false;
      game.isPracticeMode = false;
      game.isEndlessMode = false;
      
      document.getElementById('singlePlayerPrompt').style.display = 'none';
      document.getElementById('backButton').style.display = 'none';
      startGame();
      playSelectSound();
    }

    function showFourPlayerPrompt() {
      document.getElementById('fourPlayerPrompt').style.display = 'flex';
      document.getElementById('backButton').style.display = 'flex';
      document.getElementById('leftTeamName').focus();
      playSelectSound();
    }

    function cancelFourPlayerPrompt() {
      document.getElementById('fourPlayerPrompt').style.display = 'none';
      document.getElementById('backButton').style.display = 'none';
      playSelectSound();
    }

    function submitFourPlayerNames() {
      const leftName = document.getElementById('leftTeamName').value.trim() || "TEAM ONE";
      const rightName = document.getElementById('rightTeamName').value.trim() || "TEAM TWO";
      
      game.leftPlayer = leftName.toUpperCase();
      game.rightPlayer = rightName.toUpperCase();
      game.isLocalMultiplayer = true;
      game.isFourPlayer = true;
      game.isPracticeMode = false;
      game.isEndlessMode = false;
      
      document.getElementById('fourPlayerPrompt').style.display = 'none';
      document.getElementById('backButton').style.display = 'none';
      const mobileControls = document.getElementById('mobileControls');
      if (mobileControls) mobileControls.style.display = 'none';
      startGame();
      playSelectSound();
    }

    function showEndlessPrompt() {
      document.getElementById('endlessPrompt').style.display = 'flex';
      document.getElementById('backButton').style.display = 'flex';
      document.getElementById('endlessPlayerName').focus();
      playSelectSound();
    }

    function cancelEndlessPrompt() {
      document.getElementById('endlessPrompt').style.display = 'none';
      document.getElementById('backButton').style.display = 'none';
      playSelectSound();
    }

    function submitEndlessName() {
      const playerName = document.getElementById('endlessPlayerName').value.trim() || "PLAYER";
      const difficulty = document.getElementById('endlessDifficulty').value;
      
      game.leftPlayer = playerName.toUpperCase();
      game.rightPlayer = "BOT";
      game.aiDifficulty = difficulty;
      game.isLocalMultiplayer = false;
      game.isFourPlayer = false;
      game.isPracticeMode = false;
      game.isEndlessMode = true;
      
      document.getElementById('endlessPrompt').style.display = 'none';
      document.getElementById('backButton').style.display = 'none';
      startGame();
      playSelectSound();
    }

    function showPracticePrompt() {
      document.getElementById('practiceModePrompt').style.display = 'flex';
      document.getElementById('backButton').style.display = 'flex';
      playSelectSound();
    }

    function cancelPracticePrompt() {
      document.getElementById('practiceModePrompt').style.display = 'none';
      document.getElementById('backButton').style.display = 'none';
      playSelectSound();
    }

    function startPowerShotPractice() {
      game.leftPlayer = "PLAYER";
      game.rightPlayer = "BOT";
      game.aiDifficulty = "easy";
      game.isLocalMultiplayer = false;
      game.isFourPlayer = false;
      game.isPracticeMode = true;
      game.practiceType = "powershot";
      game.isEndlessMode = false;
      
      document.getElementById('practiceModePrompt').style.display = 'none';
      document.getElementById('backButton').style.display = 'none';
      
      showPracticeInstructions(
        "LEARN POWER SHOT",
        "Press E when your power bar is full to unleash a powerful shot! The power bar fills automatically over time. Try hitting the ball with a power shot!"
      );
      playSelectSound();
    }

    function startRespondingPractice() {
      game.leftPlayer = "PLAYER";
      game.rightPlayer = "BOT";
      game.aiDifficulty = "medium";
      game.isLocalMultiplayer = false;
      game.isFourPlayer = false;
      game.isPracticeMode = true;
      game.practiceType = "responding";
      game.isEndlessMode = false;
      
      document.getElementById('practiceModePrompt').style.display = 'none';
      document.getElementById('backButton').style.display = 'none';
      
      showPracticeInstructions(
        "LEARN RESPONDING",
        "The bot will hit shots at you. Try to return them! The bot will occasionally use power shots. Watch the ball carefully and position your paddle to hit it back."
      );
      playSelectSound();
    }

    function showPracticeInstructions(title, text) {
      const practiceTitle = document.getElementById('practiceTitle');
      const practiceText = document.getElementById('practiceText');
      if (practiceTitle) practiceTitle.textContent = title;
      if (practiceText) practiceText.textContent = text;
      document.getElementById('practiceInstructions').style.display = 'block';
    }

    function hidePracticeInstructions() {
      document.getElementById('practiceInstructions').style.display = 'none';
      startGame();
      playSelectSound();
    }

    function startGame() {
      game.isPaused = false;
      game.leftPaddle.score = 0;
      game.rightPaddle.score = 0;
      game.remainingTime = HALF_TIME;
      game.currentHalf = 1;
      game.extraTime = 0;
      game.matchPoint = false;
      game.bonusPoints = 0;
      game.deuceActive = false;
      game.commentaryQueue = [];
      game.hasAnnounced30 = false;
      game.hasAnnounced10 = false;
      game.last10Seconds = false;
      game.countdownNumbers = [];
      game.teamLeftCharged = false;
      game.teamRightCharged = false;
      game.particles = [];
      game.lastFrameTime = 0;
      
      // Reset charge bars
      game.leftCharge = 0;
      game.rightCharge = 0;
      game.leftCharged = false;
      game.rightCharged = false;
      const leftChargeElement = document.getElementById('leftCharge');
      const rightChargeElement = document.getElementById('rightCharge');
      const leftChargeLabel = document.getElementById('leftChargeLabel');
      const rightChargeLabel = document.getElementById('rightChargeLabel');
      
      if (leftChargeElement) leftChargeElement.style.width = '0';
      if (rightChargeElement) rightChargeElement.style.width = '0';
      if (leftChargeElement) leftChargeElement.classList.remove('active');
      if (rightChargeElement) rightChargeElement.classList.remove('active');
      if (leftChargeLabel) leftChargeLabel.textContent = 'P1 POWER';
      if (rightChargeLabel) rightChargeLabel.textContent = game.isLocalMultiplayer ? 'P2 POWER' : 'BOT POWER';
      
      // Start charging
      startLeftCharge();
      startRightCharge();
      
      // Show game elements
      document.getElementById('leftScore').style.display = "block";
      document.getElementById('rightScore').style.display = "block";
      document.getElementById('timer').style.display = "block";
      document.getElementById('bonusPoints').style.display = "block";
      document.getElementById('matchInfo').style.display = "block";
      
      // Hide menu screens
      document.getElementById('titleScreen').style.display = "none";
      document.getElementById('endScreen').style.display = "none";
      document.getElementById('pauseScreen').style.display = "none";
      document.getElementById('gameOverScreen').style.display = "none";
      document.getElementById('leaderboardScreen').style.display = "none";
      
      document.getElementById('leftScore').textContent = "0";
      document.getElementById('rightScore').textContent = "0";
      
      if (!game.isPracticeMode && !game.isEndlessMode) {
        document.getElementById('timer').textContent = "1:30.000";
        document.getElementById('bonusPoints').textContent = "";
        document.getElementById('matchInfo').textContent = "1st Half | Extra Time: +0s";
      } else {
        document.getElementById('timer').style.display = "none";
        document.getElementById('bonusPoints').style.display = "none";
        document.getElementById('matchInfo').style.display = "none";
      }
      
      resetBall();
      resetPaddles();
      
      if (!game.isPracticeMode && !game.isEndlessMode) {
        queueCommentary(`THE CHAMPIONSHIP MATCH BEGINS! ${game.leftPlayer} VS ${game.rightPlayer}!`, true, true);
      } else if (game.practiceType === 'powershot') {
        queueCommentary("Practice mode: Power shots. Press E when your power bar is full!", true, true);
      } else if (game.practiceType === 'responding') {
        queueCommentary("Practice mode: Responding. Return the bot's shots!", true, true);
      } else if (game.isEndlessMode) {
        queueCommentary("Endless mode! Play as long as you want!", true, true);
      }
      
      startCountdown();
    }

    function startCountdown() {
      let count = 3;
      document.getElementById('countdown').style.display = "flex";
      document.getElementById('goText').style.display = "none";
      game.countdownActive = true;
      
      // Play start sound
      playRandomStartMusic();
      
      function updateCountdown() {
        if (count > 0) {
          document.getElementById('countdown').textContent = count;
          if (game.soundEnabled && !game.isMuted) {
            const utterance = new SpeechSynthesisUtterance(count.toString());
            utterance.rate = 0.8;
            utterance.pitch = 1.3;
            window.speechSynthesis.speak(utterance);
          }
          count--;
        } else if (count === 0) {
          document.getElementById('countdown').style.display = "none";
          document.getElementById('goText').style.display = "flex";
          if (game.soundEnabled && !game.isMuted) {
            const utterance = new SpeechSynthesisUtterance("GO!");
            utterance.rate = 0.7;
            utterance.pitch = 1.5;
            window.speechSynthesis.speak(utterance);
          }
          count--;
        } else {
          clearInterval(game.countdownInterval);
          document.getElementById('goText').style.display = "none";
          game.gameStarted = true;
          game.musicStarted = true;
          game.startTime = Date.now();
          game.countdownActive = false;
          
          if (!game.isPracticeMode && !game.isEndlessMode) {
            startTimer();
          }
          gameLoop(); // Start the game loop
        }
      }
      
      updateCountdown();
      game.countdownInterval = setInterval(updateCountdown, 1000);
    }

    function startTimer() {
      if (game.timerInterval) clearInterval(game.timerInterval);
      
      game.hasAnnounced30 = false;
      game.hasAnnounced10 = false;
      game.last10Seconds = false;
      game.startTime = Date.now();
      
      game.timerInterval = setInterval(() => {
        if (game.isPaused || game.halftimeActive) return;
        
        const elapsed = Date.now() - game.startTime;
        const remaining = Math.max(0, game.remainingTime * 1000 - elapsed + (game.extraTime * 1000));
        
        const minutes = Math.floor(remaining / 60000);
        const seconds = Math.floor((remaining % 60000) / 1000);
        const milliseconds = remaining % 1000;
        
        const timerElement = document.getElementById('timer');
        if (timerElement) {
          timerElement.textContent = 
            `${minutes}:${seconds < 10 ? '0' : ''}${seconds}.${milliseconds < 100 ? (milliseconds < 10 ? '00' : '0') : ''}${milliseconds}`;
        }
        
        // Update match info
        const halfText = game.currentHalf === 1 ? '1st Half' : (game.extraTime > 0 ? 'ET' : '2nd Half');
        const matchInfoElement = document.getElementById('matchInfo');
        if (matchInfoElement) {
          matchInfoElement.innerHTML = `
            ${halfText} | Extra Time: +${game.extraTime}s
          `;
        }
        
        if (remaining <= 30000 && !game.hasAnnounced30) {
          game.hasAnnounced30 = true;
          queueCommentary(`ONLY 30 SECONDS REMAINING IN THE ${game.currentHalf === 1 ? '1ST' : '2ND'} HALF!`, true, true);
        }
        
        if (remaining <= 10000 && !game.hasAnnounced10) {
          game.hasAnnounced10 = true;
          queueCommentary(`FINAL COUNTDOWN! 10 SECONDS IN THE ${game.currentHalf === 1 ? '1ST' : '2ND'} HALF!`, true, true);
        }
        
        // Last 10 seconds countdown
        if (remaining <= 10000 && !game.last10Seconds) {
          game.last10Seconds = true;
          startFinalCountdown();
        }
        
        if (remaining <= 0) {
          if (game.currentHalf === 1) {
            startHalftime();
          } else {
            handleTimeExpired();
          }
        }
      }, 10);
    }

    function startFinalCountdown() {
      if (game.countdownNumbers.length > 0) return;
      
      // Clear any existing countdown
      game.countdownNumbers = [10, 9, 8, 7, 6, 5, 4, 3, 2, 1, "FINISH!"];
      
      // Make all shots power shots in last 10 seconds
      if (!game.isFourPlayer) {
        game.leftCharged = true;
        game.rightCharged = true;
      } else {
        game.teamLeftCharged = true;
        game.teamRightCharged = true;
      }
      const leftChargeElement = document.getElementById('leftCharge');
      const rightChargeElement = document.getElementById('rightCharge');
      if (leftChargeElement) leftChargeElement.classList.add('active');
      if (rightChargeElement) rightChargeElement.classList.add('active');
      
      // Start announcing numbers
      announceCountdownNumber();
    }

    function announceCountdownNumber() {
      if (game.countdownNumbers.length === 0 || !game.last10Seconds) return;
      
      const number = game.countdownNumbers.shift();
      queueCommentary(number.toString(), true, true);
      
      if (game.countdownNumbers.length > 0) {
        setTimeout(announceCountdownNumber, 1000);
      }
    }

    function startHalftime() {
      clearInterval(game.timerInterval);
      game.halftimeActive = true;
      game.last10Seconds = false;
      document.getElementById('halftimeScreen').style.display = "flex";
      document.getElementById('halftimeScreen').textContent = "HALFTIME";
      
      // Reset ball position
      resetBall();
      
      // Show halftime stats
      queueCommentary(`HALFTIME! SCORE IS ${game.leftPaddle.score}-${game.rightPaddle.score}`, true, true);
      
      // Start halftime countdown
      let halftimeCount = HALF_TIME_BREAK;
      game.halftimeInterval = setInterval(() => {
        const halftimeScreen = document.getElementById('halftimeScreen');
        if (halftimeScreen) halftimeScreen.textContent = `HALFTIME\n${halftimeCount}`;
        halftimeCount--;
        
        if (halftimeCount < 0) {
          clearInterval(game.halftimeInterval);
          if (halftimeScreen) halftimeScreen.style.display = "none";
          game.halftimeActive = false;
          game.currentHalf = 2;
          game.remainingTime = HALF_TIME;
          game.hasAnnounced30 = false;
          game.hasAnnounced10 = false;
          game.startTime = Date.now();
          startTimer();
          queueCommentary("SECOND HALF BEGINS!", true, true);
        }
      }, 1000);
    }

    function handleTimeExpired() {
      if (game.leftPaddle.score === game.rightPaddle.score) {
        game.remainingTime = OVERTIME_TIME;
        game.extraTime += OVERTIME_TIME;
        game.hasAnnounced30 = false;
        game.hasAnnounced10 = false;
        game.last10Seconds = false;
        game.countdownNumbers = [];
        if (!game.deuceActive) {
          game.bonusPoints++;
          const bonusPointsElement = document.getElementById('bonusPoints');
          if (bonusPointsElement) bonusPointsElement.textContent = `‚ö° BONUS POINT: +${game.bonusPoints}`;
        }
        playETSound();
        queueCommentary("WE'RE GOING TO OVERTIME! NEXT POINT WINS!", true, true);
        startTimer();
      } else {
        endGame();
      }
    }

    function queueCommentary(text, important = false, force = false) {
      if (force) {
        window.speechSynthesis.cancel();
        game.commentaryQueue = [];
        game.isSpeaking = false;
      }
      
      // Always add to queue, but skip unimportant ones if there are many
      if (important || game.commentaryQueue.length < 3) {
        game.commentaryQueue.push({text, important});
      }
      
      if (!game.isSpeaking || force) {
        speakNextCommentary();
      }
      
      // Update commentary display
      const commentaryElement = document.getElementById('commentary');
      if (commentaryElement) commentaryElement.textContent = text;
    }

    function speakNextCommentary() {
      if (game.commentaryQueue.length > 0 && !game.isSpeaking && game.soundEnabled && !game.isMuted) {
        const {text, important} = game.commentaryQueue.shift();
        announceCommentary(text, important);
      }
    }

    function announceCommentary(text, important = false) {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.rate = 0.9;
      utterance.pitch = 1.2;
      utterance.volume = important ? 1.0 : 0.8;
      
      utterance.onend = () => {
        game.isSpeaking = false;
        speakNextCommentary();
      };
      
      if (game.currentUtterance) {
        window.speechSynthesis.cancel();
      }
      
      window.speechSynthesis.speak(utterance);
      game.currentUtterance = utterance;
      game.isSpeaking = true;
    }

    function createConfetti() {
      const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff', '#ffffff'];
      
      for (let i = 0; i < 50; i++) {
        const particle = {
          x: Math.random() * canvas.width,
          y: -10,
          size: Math.random() * 8 + 4,
          color: colors[Math.floor(Math.random() * colors.length)],
          life: 100 + Math.random() * 50,
          vx: -5 + Math.random() * 10,
          vy: 2 + Math.random() * 5
        };
        game.particles.push(particle);
      }
    }

    function endGame() {
      game.gameStarted = false;
      clearInterval(game.timerInterval);
      
      let winner, loser, winnerScore, loserScore;
      if (game.leftPaddle.score > game.rightPaddle.score) {
        winner = game.leftPlayer;
        loser = game.rightPlayer;
        winnerScore = game.leftPaddle.score;
        loserScore = game.rightPaddle.score;
      } else {
        winner = game.rightPlayer;
        loser = game.leftPlayer;
        winnerScore = game.rightPaddle.score;
        loserScore = game.leftPaddle.score;
      }
      
      // Check if player lost to bot
      if (!game.isLocalMultiplayer && winner === "BOT") {
        showGameOver();
        return;
      }
      
      const endMessageElement = document.getElementById('endMessage');
      if (endMessageElement) endMessageElement.textContent = `${winner} WINS ${winnerScore}-${loserScore}! üèÜ`;
      document.getElementById('endScreen').style.display = "flex";
      
      // Hide game elements
      document.getElementById('leftScore').style.display = "none";
      document.getElementById('rightScore').style.display = "none";
      document.getElementById('timer').style.display = "none";
      document.getElementById('bonusPoints').style.display = "none";
      document.getElementById('matchInfo').style.display = "none";
      
      createConfetti();
      
      // Stop music at the end of the match
      backgroundMusic.pause();
      
      // Save to leaderboards
      if (game.isLocalMultiplayer && !game.isFourPlayer) {
        // Save to Recent Plays
        saveToLeaderboard('recent', {
          player1: game.leftPlayer,
          player2: game.rightPlayer,
          score1: game.leftPaddle.score,
          score2: game.rightPaddle.score,
          stage: game.tournamentStage,
          timestamp: Date.now()
        });
        
        // Save to Best Wins if score difference is significant
        if (Math.abs(game.leftPaddle.score - game.rightPaddle.score) >= 3) {
          saveToLeaderboard('best', {
            player1: winner,
            player2: loser,
            score1: winnerScore,
            score2: loserScore,
            stage: game.tournamentStage,
            timestamp: Date.now()
          });
        }
      } else if (!game.isLocalMultiplayer) {
        // Save to Bot Champions
        saveToLeaderboard('bot', {
          player1: game.leftPlayer,
          score1: game.leftPaddle.score,
          score2: game.rightPaddle.score,
          difficulty: game.aiDifficulty,
          timestamp: Date.now()
        });
      }
      
      queueCommentary(`${winner} defeats ${loser} ${winnerScore}-${loserScore}!`, true, true);
      queueCommentary(`WHAT A PERFORMANCE! ${winner} IS THE PONG CHAMPION!`, true);
      queueCommentary("What an incredible championship match we've witnessed today!", true);
    }

    function showGameOver() {
      game.gameStarted = false;
      clearInterval(game.timerInterval);
      
      document.getElementById('gameOverScreen').style.display = "flex";
      document.getElementById('leftScore').style.display = "none";
      document.getElementById('rightScore').style.display = "none";
      document.getElementById('timer').style.display = "none";
      document.getElementById('bonusPoints').style.display = "none";
      document.getElementById('matchInfo').style.display = "none";
      
      // Stop music and play game over sound
      backgroundMusic.pause();
      playGameOverSound();
      
      // Save to Bot Champions
      saveToLeaderboard('bot', {
        player1: game.leftPlayer,
        score1: game.leftPaddle.score,
        score2: game.rightPaddle.score,
        difficulty: game.aiDifficulty,
        timestamp: Date.now()
      });
      
      queueCommentary("GAME OVER! YOU LOST TO THE BOT!", true, true);
      
      // Return to menu after delay
      setTimeout(() => {
        returnToMenu();
      }, 5000);
    }

    function toggleMute() {
      if (!game.soundEnabled) return;
      
      game.isMuted = !game.isMuted;
      const muteButton = document.getElementById('muteButton');
      if (muteButton) muteButton.textContent = game.isMuted ? "üîá" : "üîä";
      window.speechSynthesis.cancel();
      
      if (game.isMuted) {
        queueCommentary("Commentary muted", true, true);
      } else {
        queueCommentary("Commentary unmuted", true, true);
      }
    }

    function toggleMusicMute() {
      if (!game.soundEnabled) return;
      
      game.isMusicMuted = !game.isMusicMuted;
      const musicMuteButton = document.getElementById('musicMuteButton');
      if (musicMuteButton) musicMuteButton.textContent = game.isMusicMuted ? "üîá" : "üéµ";
      
      if (game.isMusicMuted) {
        backgroundMusic.pause();
        queueCommentary("Music muted", true, true);
      } else {
        if (game.musicStarted && game.gameStarted) {
          backgroundMusic.play().catch(e => console.log("Audio play error:", e));
        }
        queueCommentary("Music unmuted", true, true);
      }
    }

    function togglePause() {
      game.isPaused = !game.isPaused;
      document.getElementById('pauseScreen').style.display = game.isPaused ? "flex" : "none";
      
      if (game.isPaused) {
        game.pausedTime = Date.now();
        backgroundMusic.pause();
        queueCommentary("GAME PAUSED", true, true);
      } else {
        const pauseDuration = Date.now() - game.pausedTime;
        game.startTime += pauseDuration;
        if (game.soundEnabled && !game.isMusicMuted && game.musicStarted && game.gameStarted) {
          backgroundMusic.play().catch(e => console.log("Audio play error:", e));
        }
        queueCommentary("GAME RESUMED", true, true);
      }
    }

    function returnToMenu() {
      game.isPaused = false;
      game.halftimeActive = false;
      document.getElementById('pauseScreen').style.display = "none";
      document.getElementById('endScreen').style.display = "none";
      document.getElementById('halftimeScreen').style.display = "none";
      document.getElementById('gameOverScreen').style.display = "none";
      document.getElementById('titleScreen').style.display = "flex";
      document.getElementById('backButton').style.display = "none";
      document.getElementById('leaderboardScreen').style.display = "none";
      clearInterval(game.timerInterval);
      clearInterval(game.halftimeInterval);
      clearInterval(game.leftChargeInterval);
      clearInterval(game.rightChargeInterval);
      game.gameStarted = false;
      game.isLocalMultiplayer = false;
      game.isFourPlayer = false;
      game.isPracticeMode = false;
      game.isEndlessMode = false;
      game.last10Seconds = false;
      game.countdownNumbers = [];
      game.particles = [];
      
      // Hide game elements
      document.getElementById('leftScore').style.display = "none";
      document.getElementById('rightScore').style.display = "none";
      document.getElementById('timer').style.display = "none";
      document.getElementById('bonusPoints').style.display = "none";
      document.getElementById('matchInfo').style.display = "none";
      
      // Reset mobile controls
      game.mobileControls = {
        leftUp: false,
        leftDown: false,
        rightUp: false,
        rightDown: false,
        leftPower: false,
        rightPower: false
      };
      
      // Show mobile controls if on mobile for 1P and 2P modes
      if (/Mobi|Android/i.test(navigator.userAgent)) {
        const mobileControls = document.getElementById('mobileControls');
        if (mobileControls) mobileControls.style.display = 'flex';
      }
      
      // Start music again if not muted
      if (game.soundEnabled && !game.isMusicMuted && game.musicStarted) {
        playRandomGameMusic();
      }
      
      queueCommentary("RETURNING TO MENU", true, true);
    }

    // Initialize the game when the DOM is loaded
    document.addEventListener('DOMContentLoaded', initGame);
  </script>
</body>
</html>
