<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>üèÜ PONG CHAMPIONSHIP üèÜ</title>
  <!-- Favicon -->
  <link rel="icon" href="image1.png" type="image/png">
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #000;
      font-family: 'Arial', sans-serif;
      touch-action: manipulation;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      height: 100vh;
      width: 100vw;
      position: fixed;
    }
    #gameContainer {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
    }
    canvas {
      background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d, purple, lightgreen);
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
      display: block;
      touch-action: none;
      width: 100%;
      height: 100%;
    }
    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    #leftScore, #rightScore {
      position: absolute;
      top: 20px;
      font-size: 2rem;
      color: white;
      text-shadow: 0 0 10px rgba(255,255,255,0.7);
      z-index: 30;
      font-weight: bold;
    }
    #leftScore { left: 25%; }
    #rightScore { right: 25%; }
    #timer {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 1.5rem;
      color: white;
      z-index: 30;
      font-weight: bold;
    }
    #bonusPoints {
      position: absolute;
      top: 60px;
      left: 50%;
      transform: translateX(-50%);
      color: gold;
      font-size: 1rem;
      text-shadow: 1px 1px 2px black;
      z-index: 30;
      font-weight: bold;
    }
    #commentary {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      max-width: 90%;
      text-align: center;
      font-size: 1rem;
      z-index: 30;
      font-weight: bold;
      border: 2px solid gold;
      box-shadow: 0 0 15px rgba(255,215,0,0.5);
    }
    #titleScreen, #endScreen, #lobbyScreen, #createGameScreen, #findGameScreen, #waitingScreen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 100;
    }
    #titleScreen h1, #endScreen h1, #lobbyScreen h1, #createGameScreen h1, #findGameScreen h1 {
      font-size: 2.5rem;
      color: gold;
      text-shadow: 0 0 10px rgba(255,215,0,0.7);
      margin-bottom: 1.5rem;
      text-align: center;
    }
    #titleScreen h2, #lobbyScreen h2 {
      font-size: 1.8rem;
      color: white;
      margin-bottom: 1.5rem;
      text-shadow: 0 0 5px rgba(255,255,255,0.5);
    }
    .btn-championship {
      background: linear-gradient(45deg, #ff8a00, #e52e71);
      border: none;
      font-size: 1.2rem;
      padding: 10px 25px;
      margin: 10px;
      border-radius: 50px;
      color: white;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      transition: all 0.3s;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .btn-championship:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 20px rgba(0,0,0,0.4);
    }
    #muteButton, #pauseButton, #fullscreenButton, #dpadToggle, #musicMuteButton {
      position: absolute;
      top: 10px;
      z-index: 40;
      background: rgba(255,255,255,0.2);
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      color: white;
      font-size: 1rem;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #muteButton { left: 10px; }
    #pauseButton { left: 60px; }
    #fullscreenButton { left: 110px; }
    #dpadToggle { right: 10px; }
    #musicMuteButton { right: 60px; }
    #pauseScreen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 150;
      color: white;
      font-size: 1.5rem;
    }
    #countdown {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 200;
      color: white;
      font-size: 4rem;
      font-weight: bold;
      text-shadow: 0 0 20px rgba(255,255,255,0.8);
    }
    #playerNameInput {
      padding: 10px;
      font-size: 1.2rem;
      margin-bottom: 20px;
      width: 80%;
      max-width: 300px;
      text-align: center;
      border-radius: 20px;
      border: 2px solid gold;
      background: rgba(0,0,0,0.7);
      color: white;
    }
    #gameList {
      width: 90%;
      max-height: 50vh;
      overflow-y: auto;
      margin: 20px 0;
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
      padding: 10px;
    }
    .game-item {
      background: rgba(255,255,255,0.1);
      padding: 12px;
      margin: 8px 0;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 1rem;
      color: white;
      border: 1px solid rgba(255,255,255,0.2);
    }
    .game-item:hover {
      background: rgba(255,255,255,0.2);
      transform: scale(1.02);
    }
    #waitingMessage {
      font-size: 1.2rem;
      color: white;
      margin-bottom: 20px;
      text-align: center;
      padding: 0 20px;
    }
    /* Mobile Controls - Hidden by default */
    #leftControls, #rightControls {
      display: none;
      position: absolute;
      bottom: 20px;
      flex-direction: column;
      align-items: center;
      z-index: 20;
    }
    #leftControls { left: 15px; }
    #rightControls { right: 15px; }
    .control-btn {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: rgba(255,255,255,0.3);
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 8px;
      font-size: 1.8rem;
      color: white;
      user-select: none;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    .control-btn:active {
      background: rgba(255,255,255,0.5);
      transform: scale(0.95);
    }
    /* D-pad controls */
    .dpad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(3, 1fr);
      gap: 8px;
    }
    .dpad-btn {
      width: 60px;
      height: 60px;
      background: rgba(255,255,255,0.3);
      display: flex;
      justify-content: center;
      align-items: center;
      border-radius: 10px;
      font-size: 1.5rem;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    .dpad-btn:active {
      background: rgba(255,255,255,0.5);
    }
    .dpad-up { grid-column: 2; grid-row: 1; }
    .dpad-down { grid-column: 2; grid-row: 3; }
    /* Confetti styles */
    .confetti {
      position: absolute;
      width: 8px;
      height: 8px;
      background-color: #f00;
      border-radius: 50%;
      pointer-events: none;
      z-index: 100;
    }
    @keyframes confetti-fall {
      0% { transform: translateY(-100px) rotate(0deg); }
      100% { transform: translateY(100vh) rotate(360deg); }
    }
    /* Name prompt modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 300;
    }
    .modal-content {
      background: linear-gradient(135deg, #1a2a6c, #b21f1f);
      padding: 30px;
      border-radius: 20px;
      text-align: center;
      max-width: 90%;
      width: 400px;
      box-shadow: 0 0 30px rgba(0,0,0,0.5);
      border: 3px solid gold;
    }
    .modal-title {
      color: gold;
      font-size: 1.8rem;
      margin-bottom: 20px;
      text-shadow: 0 0 10px rgba(255,215,0,0.7);
    }
    .modal-input {
      width: 100%;
      padding: 12px;
      margin-bottom: 20px;
      border-radius: 10px;
      border: 2px solid gold;
      font-size: 1.2rem;
      text-align: center;
      background: rgba(0,0,0,0.7);
      color: white;
    }
    .modal-btn {
      padding: 10px 25px;
      margin: 0 10px;
      border-radius: 50px;
      border: none;
      background: gold;
      color: #000;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    .modal-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 0 15px rgba(255,215,0,0.7);
    }
    @media (max-width: 768px) {
      #leftScore, #rightScore { 
        font-size: 1.8rem; 
        top: 15px; 
      }
      #leftScore { left: 20%; }
      #rightScore { right: 20%; }
      #timer { font-size: 1.2rem; top: 15px; }
      #bonusPoints { font-size: 0.9rem; top: 50px; }
      #commentary { font-size: 0.9rem; padding: 5px 10px; bottom: 15px; }
      .btn-championship { font-size: 1rem; padding: 8px 20px; }
      #titleScreen h1, #lobbyScreen h1 { font-size: 2rem; }
      #titleScreen h2, #lobbyScreen h2 { font-size: 1.3rem; }
      #playerNameInput { width: 80%; font-size: 1rem; }
      .game-item { font-size: 0.9rem; padding: 10px; }
      .control-btn { width: 60px; height: 60px; font-size: 1.5rem; }
      #muteButton, #pauseButton, #fullscreenButton, #dpadToggle, #musicMuteButton {
        width: 35px;
        height: 35px;
        font-size: 0.9rem;
      }
      #muteButton { left: 5px; }
      #pauseButton { left: 45px; }
      #fullscreenButton { left: 85px; }
      #dpadToggle { right: 5px; }
      #musicMuteButton { right: 45px; }
      .dpad-btn {
        width: 45px;
        height: 45px;
        font-size: 1.2rem;
      }
      .modal-content {
        width: 90%;
        padding: 20px;
      }
      .modal-title {
        font-size: 1.5rem;
      }
    }
    @media (max-height: 500px) {
      #titleScreen h1, #lobbyScreen h1 { font-size: 1.5rem; }
      #titleScreen h2, #lobbyScreen h2 { font-size: 1.1rem; }
      .btn-championship { font-size: 0.8rem; padding: 6px 15px; }
      #leftControls, #rightControls { bottom: 10px; }
      .control-btn { width: 50px; height: 50px; font-size: 1.3rem; }
      .dpad-btn {
        width: 40px;
        height: 40px;
        font-size: 1rem;
      }
    }
  </style>
</head>
<body>
  <div id="gameContainer">
    <canvas id="pongCanvas"></canvas>
    
    <!-- Mobile Controls (only visible on small devices) -->
    <div id="leftControls">
      <div class="control-btn" id="upBtnLeft">‚Üë</div>
      <div class="control-btn" id="downBtnLeft">‚Üì</div>
    </div>
    <div id="rightControls">
      <div class="control-btn" id="upBtnRight">‚Üë</div>
      <div class="control-btn" id="downBtnRight">‚Üì</div>
    </div>
    
    <div id="leftScore">0</div>
    <div id="rightScore">0</div>
    <div id="timer">2:00.000</div>
    <div id="bonusPoints"></div>
    <div id="commentary">WELCOME TO THE PONG CHAMPIONSHIP!</div>
    <button id="muteButton">üîä</button>
    <button id="pauseButton">‚è∏Ô∏è</button>
    <button id="fullscreenButton">‚õ∂</button>
    <button id="dpadToggle" title="Toggle D-pad">üéÆ</button>
    <button id="musicMuteButton">üéµ</button>

    <!-- Audio Elements -->
    <audio id="menuMusic" loop>
      <source src="music1.mp3" type="audio/mpeg">
    </audio>
    <audio id="gameMusic1" loop>
      <source src="music2.mp3" type="audio/mpeg">
    </audio>
    <audio id="gameMusic2" loop>
      <source src="music3.mp3" type="audio/mpeg">
    </audio>
    <audio id="gameMusic3" loop>
      <source src="music4.mp3" type="audio/mpeg">
    </audio>
    <audio id="gameMusic4" loop>
      <source src="music5.mp3" type="audio/mpeg">
    </audio>
    <audio id="gameMusic5" loop>
      <source src="music6.mp3" type="audio/mpeg">
    </audio>
    <audio id="gameMusic6" loop>
      <source src="music7.mp3" type="audio/mpeg">
    </audio>
    <audio id="gameMusic7" loop>
      <source src="music8.mp3" type="audio/mpeg">
    </audio>
    <audio id="gameMusic8" loop>
      <source src="music9.mp3" type="audio/mpeg">
    </audio>

    <!-- Countdown Screen -->
    <div id="countdown"></div>

    <!-- Pause Screen -->
    <div id="pauseScreen">
      <h1>GAME PAUSED</h1>
      <button class="btn-championship" onclick="togglePause()">RESUME</button>
      <button class="btn-championship" onclick="returnToMenu()">RETURN TO MENU</button>
    </div>

    <!-- Title Screen -->
    <div id="titleScreen">
      <h1>üèÜ PONG CHAMPIONSHIP üèÜ</h1>
      <h2>CHOOSE YOUR GAME MODE</h2>
      <button class="btn-championship" onclick="showNamePrompt(false)">2 PLAYERS</button>
      <button class="btn-championship" onclick="showNamePrompt(true)">4 PLAYERS</button>
      <button class="btn-championship" onclick="startLocalMultiplayer()">LOCAL MULTIPLAYER</button>
    </div>

    <!-- End Screen -->
    <div id="endScreen" style="display: none;">
      <h1 id="endMessage" style="color: gold; font-size: 1.5rem;"></h1>
      <button class="btn-championship" id="endScreenBtn" onclick="returnToMenu()">RETURN TO MENU</button>
    </div>

    <!-- D-pad for both players -->
    <div id="leftDpad" style="display: none; position: absolute; bottom: 20px; left: 15px;">
      <div class="dpad">
        <div class="dpad-btn dpad-up" id="leftDpadUp">‚Üë</div>
        <div class="dpad-btn dpad-down" id="leftDpadDown">‚Üì</div>
      </div>
    </div>
    <div id="rightDpad" style="display: none; position: absolute; bottom: 20px; right: 15px;">
      <div class="dpad">
        <div class="dpad-btn dpad-up" id="rightDpadUp">‚Üë</div>
        <div class="dpad-btn dpad-down" id="rightDpadDown">‚Üì</div>
      </div>
    </div>
  </div>

  <!-- Name Prompt Modal -->
  <div id="namePrompt" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-title">ENTER TEAM NAMES</div>
      <input type="text" id="leftPlayerName" class="modal-input" placeholder="Left Team Name" maxlength="20">
      <input type="text" id="rightPlayerName" class="modal-input" placeholder="Right Team Name" maxlength="20">
      <button class="modal-btn" onclick="submitNames()">START GAME</button>
    </div>
  </div>

  <!-- Bootstrap JS + Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ===== GAME CONSTANTS =====
    let PADDLE_HEIGHT = 150;
    let PADDLE_WIDTH = 20;
    let FOUR_PLAYER_PADDLE_HEIGHT = 100; // Reduced size for 4-player mode
    const BALL_RADIUS = 12;
    let INITIAL_BALL_SPEED = 6; // Increased ball speed
    let FOUR_PLAYER_BALL_SPEED = 12; // Increased ball speed
    const PADDLE_SPEED = 12;
    const WINNING_SCORE = 10;
    const GAME_TIME = 120; // 2 minutes in seconds
    const OVERTIME_TIME = 30; // 30 seconds overtime
    const canvas = document.getElementById('pongCanvas');
    const ctx = canvas.getContext('2d');
    const leftScoreEl = document.getElementById('leftScore');
    const rightScoreEl = document.getElementById('rightScore');
    const timerEl = document.getElementById('timer');
    const bonusPointsEl = document.getElementById('bonusPoints');
    const commentaryEl = document.getElementById('commentary');
    const muteBtn = document.getElementById('muteButton');
    const pauseBtn = document.getElementById('pauseButton');
    const fullscreenBtn = document.getElementById('fullscreenButton');
    const dpadToggleBtn = document.getElementById('dpadToggle');
    const musicMuteBtn = document.getElementById('musicMuteButton');
    const pauseScreen = document.getElementById('pauseScreen');
    const countdownEl = document.getElementById('countdown');
    const titleScreen = document.getElementById('titleScreen');
    const endScreen = document.getElementById('endScreen');
    const endMessage = document.getElementById('endMessage');
    const endScreenBtn = document.getElementById('endScreenBtn');
    const upBtnLeft = document.getElementById('upBtnLeft');
    const downBtnLeft = document.getElementById('downBtnLeft');
    const upBtnRight = document.getElementById('upBtnRight');
    const downBtnRight = document.getElementById('downBtnRight');
    const leftDpad = document.getElementById('leftDpad');
    const rightDpad = document.getElementById('rightDpad');
    const leftDpadUp = document.getElementById('leftDpadUp');
    const leftDpadDown = document.getElementById('leftDpadDown');
    const rightDpadUp = document.getElementById('rightDpadUp');
    const rightDpadDown = document.getElementById('rightDpadDown');
    const menuMusic = document.getElementById('menuMusic');
    const gameMusic = [
      document.getElementById('gameMusic1'),
      document.getElementById('gameMusic2'),
      document.getElementById('gameMusic3'),
      document.getElementById('gameMusic4'),
      document.getElementById('gameMusic5'),
      document.getElementById('gameMusic6'),
      document.getElementById('gameMusic7'),
      document.getElementById('gameMusic8')
    ];
    const namePrompt = document.getElementById('namePrompt');
    const leftPlayerNameInput = document.getElementById('leftPlayerName');
    const rightPlayerNameInput = document.getElementById('rightPlayerName');

    // ===== GAME STATE =====
    let game = {
      ball: { x: 0, y: 0, dx: 0, dy: 0, speed: INITIAL_BALL_SPEED },
      leftPaddle: { y: 0, score: 0 },
      rightPaddle: { y: 0, score: 0 },
      leftTopPaddle: { y: 0 },
      leftBottomPaddle: { y: 0 },
      rightTopPaddle: { y: 0 },
      rightBottomPaddle: { y: 0 },
      isFourPlayer: false,
      isMuted: false,
      isMusicMuted: false,
      isPaused: false,
      gameStarted: false,
      remainingTime: GAME_TIME,
      lastScorer: null,
      matchPoint: false,
      leftPlayer: "TEAM ONE",
      rightPlayer: "TEAM TWO",
      timerInterval: null,
      countdownInterval: null,
      keysPressed: {},
      bonusPoints: 0,
      deuceActive: false,
      startTime: 0,
      elapsedPausedTime: 0,
      pausedTime: 0,
      tournamentRound: "Championship",
      commentaryQueue: [],
      isSpeaking: false,
      hasAnnounced30: false,
      hasAnnounced10: false,
      currentUtterance: null,
      lastSpecialMoveTime: 0,
      betweenPointsTimeout: null,
      mobileControls: {
        leftUp: false,
        leftDown: false,
        rightUp: false,
        rightDown: false
      },
      currentGameMusic: 0,
      dpadEnabled: false,
      musicEnabled: true,
      isLocalMultiplayer: false
    };

    // ===== ENHANCED COMMENTARY SYSTEM =====
    const commentaryPhrases = {
      introductions: [
        "LADIES AND GENTLEMEN! WELCOME TO THE PONG CHAMPIONSHIP FINALS!",
        "THE MOMENT WE'VE ALL BEEN WAITING FOR - THE PONG WORLD CHAMPIONSHIP!",
        "THIS IS IT! THE ULTIMATE PONG BATTLE FOR THE CHAMPIONSHIP TITLE!"
      ],
      playerIntroductions: [
        "IN THE BLUE CORNER, THE FORMIDABLE {leftPlayer}! IN THE RED CORNER, THE INCREDIBLE {rightPlayer}!",
        "TWO LEGENDS ENTER THE ARENA TODAY: {leftPlayer} VERSUS {rightPlayer}!",
        "LET'S MEET OUR GLADIATORS! ON THE LEFT, {leftPlayer}! ON THE RIGHT, {rightPlayer}!"
      ],
      countdown: [
        "THE TENSION IS UNBEARABLE! THE CHAMPIONSHIP MATCH BEGINS IN...",
        "THE CROWD IS ON THEIR FEET! THE TITLE MATCH STARTS IN...",
        "HISTORY WILL BE MADE HERE TODAY! THE CHAMPIONSHIP BEGINS IN..."
      ],
      scores: [
        "INCREDIBLE SHOT! POINT TO {player}!",
        "WHAT A PLAY! {player} SCORES!",
        "UNBELIEVABLE! {player} TAKES THE POINT!",
        "MAGNIFICENT! {player} WINS THE POINT!"
      ],
      deuce: [
        "WE'RE AT DEUCE! BONUS POINT ACTIVATED! NEXT POINT WINS THE CHAMPIONSHIP!",
        "IT'S ALL TIED UP! SUDDEN DEATH POINT FOR THE TITLE!",
        "THE TENSION IS PALPABLE! DEUCE! NEXT POINT TAKES THE CHAMPIONSHIP!"
      ],
      matchPoint: [
        "THIS IS IT! CHAMPIONSHIP POINT FOR {player}!",
        "{player} IS ONE POINT AWAY FROM GLORY!",
        "CAN {player} CLINCH THE CHAMPIONSHIP HERE?",
        "THE CROWD IS SILENT! CHAMPIONSHIP POINT FOR {player}!"
      ],
      timeWarnings: [
        "ONLY 30 SECONDS REMAINING IN THE CHAMPIONSHIP MATCH! THE CLOCK IS TICKING!",
        "THE SANDS OF TIME ARE RUNNING OUT! 30 SECONDS LEFT IN THE TITLE MATCH!",
        "THE FINAL COUNTDOWN! 30 SECONDS TO DECIDE THE CHAMPION!"
      ],
      overtime: [
        "WE'RE GOING TO OVERTIME IN THE CHAMPIONSHIP! NEXT POINT WINS THE TITLE!",
        "SUDDEN DEATH OVERTIME! THE CROWD IS GOING WILD!",
        "IT'S ALL COME DOWN TO THIS! OVERTIME IN THE CHAMPIONSHIP MATCH!"
      ],
      victories: [
        "WHAT A PERFORMANCE! {player} IS THE PONG CHAMPION!",
        "ABSOLUTELY DOMINANT! {player} TAKES THE CHAMPIONSHIP TITLE!",
        "HISTORY HAS BEEN MADE! {player} WINS THE WORLD CHAMPIONSHIP!",
        "THE CROWD ERUPTS! {player} IS CROWNED CHAMPION!"
      ],
      specialMoves: [
        "OH MY GOODNESS! WHAT AN INCREDIBLE SHOT!",
        "INCREDIBLE! DID YOU SEE THAT CHAMPIONSHIP-LEVEL PLAY?",
        "UNBELIEVABLE PLAY! THE CROWD IS IN A FRENZY!",
        "THAT WAS CHAMPIONSHIP-LEVEL SKILL RIGHT THERE!"
      ],
      betweenPoints: [
        "THE TENSION COULD CUT A KNIFE! WHO WILL TAKE CONTROL OF THIS CHAMPIONSHIP MATCH?",
        "THIS CHAMPIONSHIP MATCH IS HEATING UP! THE NEXT POINT IS CRUCIAL!",
        "EVERY POINT MATTERS IN THIS EPIC CHAMPIONSHIP BATTLE!"
      ],
      reactions: [
        "WOW!",
        "OH!",
        "INCREDIBLE!",
        "UNBELIEVABLE!",
        "WHAT A SHOT!"
      ],
      crowdChants: [
        "THE CROWD IS CHANTING {player}'S NAME!",
        "THE STADIUM IS ROCKING WITH EXCITEMENT!",
        "THE FANS ARE GOING WILD FOR THIS CHAMPIONSHIP MATCH!"
      ]
    };

    function getRandomCommentary(type) {
      const phrases = commentaryPhrases[type];
      if (!phrases) return "";
      
      let phrase = phrases[Math.floor(Math.random() * phrases.length)];
      phrase = phrase.replace(/{leftPlayer}/g, game.leftPlayer);
      phrase = phrase.replace(/{rightPlayer}/g, game.rightPlayer);
      phrase = phrase.replace(/{player}/g, game.lastScorer || "the player");
      
      return phrase;
    }

    function queueCommentary(text, important = false, force = false) {
      if (force) {
        // Clear any current speech and queue
        window.speechSynthesis.cancel();
        game.commentaryQueue = [];
        game.isSpeaking = false;
      }
      
      // Skip less important commentary if there's new important ones
      if (important) {
        game.commentaryQueue = [{text, important}];
      } else if (!game.commentaryQueue.some(item => item.important)) {
        game.commentaryQueue.push({text, important});
      }
      
      if (!game.isSpeaking || force) {
        speakNextCommentary();
      }
    }

    function announceCommentary(text, important = false) {
      commentaryEl.textContent = text;
      
      if (!game.isMuted && game.musicEnabled) {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.rate = 0.9;
        utterance.pitch = 1.2;
        utterance.volume = 1.0;
        
        utterance.onend = () => {
          game.isSpeaking = false;
          speakNextCommentary();
        };
        
        if (game.currentUtterance) {
          window.speechSynthesis.cancel();
        }
        
        window.speechSynthesis.speak(utterance);
        game.currentUtterance = utterance;
        game.isSpeaking = true;
      }
    }

    function speakNextCommentary() {
      if (game.commentaryQueue.length > 0 && !game.isSpeaking) {
        const {text, important} = game.commentaryQueue.shift();
        announceCommentary(text, important);
      }
    }

    function checkForSpecialMove() {
      const speedThreshold = game.isFourPlayer ? FOUR_PLAYER_BALL_SPEED * 1.8 : INITIAL_BALL_SPEED * 1.8;
      const now = Date.now();
      
      if (game.ball.speed >= speedThreshold && now - game.lastSpecialMoveTime > 5000) {
        game.lastSpecialMoveTime = now;
        return true;
      }
      return false;
    }

    // ===== MOBILE CONTROLS =====
    function setupMobileControls() {
      // Left controls
      upBtnLeft.addEventListener('touchstart', (e) => {
        e.preventDefault();
        game.mobileControls.leftUp = true;
      });
      upBtnLeft.addEventListener('touchend', (e) => {
        e.preventDefault();
        game.mobileControls.leftUp = false;
      });
      downBtnLeft.addEventListener('touchstart', (e) => {
        e.preventDefault();
        game.mobileControls.leftDown = true;
      });
      downBtnLeft.addEventListener('touchend', (e) => {
        e.preventDefault();
        game.mobileControls.leftDown = false;
      });

      // Right controls
      upBtnRight.addEventListener('touchstart', (e) => {
        e.preventDefault();
        game.mobileControls.rightUp = true;
      });
      upBtnRight.addEventListener('touchend', (e) => {
        e.preventDefault();
        game.mobileControls.rightUp = false;
      });
      downBtnRight.addEventListener('touchstart', (e) => {
        e.preventDefault();
        game.mobileControls.rightDown = true;
      });
      downBtnRight.addEventListener('touchend', (e) => {
        e.preventDefault();
        game.mobileControls.rightDown = false;
      });

      // Mouse controls for testing on desktop
      upBtnLeft.addEventListener('mousedown', () => game.mobileControls.leftUp = true);
      upBtnLeft.addEventListener('mouseup', () => game.mobileControls.leftUp = false);
      downBtnLeft.addEventListener('mousedown', () => game.mobileControls.leftDown = true);
      downBtnLeft.addEventListener('mouseup', () => game.mobileControls.leftDown = false);
      upBtnRight.addEventListener('mousedown', () => game.mobileControls.rightUp = true);
      upBtnRight.addEventListener('mouseup', () => game.mobileControls.rightUp = false);
      downBtnRight.addEventListener('mousedown', () => game.mobileControls.rightDown = true);
      downBtnRight.addEventListener('mouseup', () => game.mobileControls.rightDown = false);
    }

    // ===== DPAD CONTROLS =====
    function setupDpadControls() {
      // Left D-pad
      leftDpadUp.addEventListener('touchstart', (e) => {
        e.preventDefault();
        game.mobileControls.leftUp = true;
      });
      leftDpadUp.addEventListener('touchend', (e) => {
        e.preventDefault();
        game.mobileControls.leftUp = false;
      });
      leftDpadDown.addEventListener('touchstart', (e) => {
        e.preventDefault();
        game.mobileControls.leftDown = true;
      });
      leftDpadDown.addEventListener('touchend', (e) => {
        e.preventDefault();
        game.mobileControls.leftDown = false;
      });

      // Right D-pad
      rightDpadUp.addEventListener('touchstart', (e) => {
        e.preventDefault();
        game.mobileControls.rightUp = true;
      });
      rightDpadUp.addEventListener('touchend', (e) => {
        e.preventDefault();
        game.mobileControls.rightUp = false;
      });
      rightDpadDown.addEventListener('touchstart', (e) => {
        e.preventDefault();
        game.mobileControls.rightDown = true;
      });
      rightDpadDown.addEventListener('touchend', (e) => {
        e.preventDefault();
        game.mobileControls.rightDown = false;
      });

      // Mouse controls for testing
      leftDpadUp.addEventListener('mousedown', () => game.mobileControls.leftUp = true);
      leftDpadUp.addEventListener('mouseup', () => game.mobileControls.leftUp = false);
      leftDpadDown.addEventListener('mousedown', () => game.mobileControls.leftDown = true);
      leftDpadDown.addEventListener('mouseup', () => game.mobileControls.leftDown = false);
      rightDpadUp.addEventListener('mousedown', () => game.mobileControls.rightUp = true);
      rightDpadUp.addEventListener('mouseup', () => game.mobileControls.rightUp = false);
      rightDpadDown.addEventListener('mousedown', () => game.mobileControls.rightDown = true);
      rightDpadDown.addEventListener('mouseup', () => game.mobileControls.rightDown = false);
    }

    function toggleDpad() {
      game.dpadEnabled = !game.dpadEnabled;
      leftDpad.style.display = game.dpadEnabled ? 'block' : 'none';
      rightDpad.style.display = game.dpadEnabled ? 'block' : 'none';
      dpadToggleBtn.textContent = game.dpadEnabled ? 'üéÆ' : 'üïπÔ∏è';
    }

    // ===== FULLSCREEN FUNCTIONALITY =====
    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => {
          console.log(`Error attempting to enable fullscreen: ${err.message}`);
        });
      } else {
        if (document.exitFullscreen) {
          document.exitFullscreen();
        }
      }
    }

    // Handle fullscreen change events
    document.addEventListener('fullscreenchange', () => {
      if (document.fullscreenElement) {
        // Adjust game elements when entering fullscreen
        resizeCanvas();
        resetPaddles();
        resetBall();
      }
    });

    // ===== NAME PROMPT =====
    function showNamePrompt(fourPlayerMode) {
      game.isFourPlayer = fourPlayerMode;
      namePrompt.style.display = 'flex';
      leftPlayerNameInput.focus();
    }

    function submitNames() {
      const leftName = leftPlayerNameInput.value.trim() || "TEAM ONE";
      const rightName = rightPlayerNameInput.value.trim() || "TEAM TWO";
      
      game.leftPlayer = leftName;
      game.rightPlayer = rightName;
      
      namePrompt.style.display = 'none';
      startGame();
    }

    // ===== LOCAL MULTIPLAYER =====
    function startLocalMultiplayer() {
      game.isLocalMultiplayer = true;
      game.isFourPlayer = false;
      
      // Set default names for local multiplayer
      game.leftPlayer = "PLAYER 1";
      game.rightPlayer = "PLAYER 2";
      
      startGame();
    }

    // ===== GAME INITIALIZATION =====
    function initGame() {
      // Start menu music
      menuMusic.volume = 0.5;
      menuMusic.play().catch(e => console.log('Menu music play prevented:', e));
      
      // Set up responsive design
      handleResize();
      window.addEventListener('resize', handleResize);
      
      // Set up controls
      setupMobileControls();
      setupDpadControls();
      setupKeyboardControls();
      
      // Initialize game elements
      resizeCanvas();
      resetBall();
      resetPaddles();
      
      // Set up button event listeners
      muteBtn.addEventListener('click', toggleMute);
      pauseBtn.addEventListener('click', togglePause);
      fullscreenBtn.addEventListener('click', toggleFullscreen);
      dpadToggleBtn.addEventListener('click', toggleDpad);
      musicMuteBtn.addEventListener('click', toggleMusicMute);
      
      // Start game loop
      gameLoop();
    }

    // ===== CANVAS RESIZING =====
    function resizeCanvas() {
      // Adjust for fullscreen on mobile devices
      const isMobile = window.innerWidth <= 768;
      const width = isMobile ? window.innerWidth : window.innerWidth;
      const height = isMobile ? window.innerHeight : window.innerHeight;
      
      canvas.width = width;
      canvas.height = height;
      
      // Adjust paddle and ball sizes based on screen size
      const sizeFactor = Math.min(width, height) / 800; // Base size on 800px minimum dimension
      
      PADDLE_HEIGHT = 150 * sizeFactor;
      FOUR_PLAYER_PADDLE_HEIGHT = 100 * sizeFactor; // Smaller paddles for 4-player mode
      INITIAL_BALL_SPEED = 15 * Math.sqrt(sizeFactor); // Scale speed with square root for better feel
      FOUR_PLAYER_BALL_SPEED = 12 * Math.sqrt(sizeFactor); // Scale speed with square root for better feel
      
      // Ensure minimum sizes
      PADDLE_HEIGHT = Math.max(PADDLE_HEIGHT, 80);
      FOUR_PLAYER_PADDLE_HEIGHT = Math.max(FOUR_PLAYER_PADDLE_HEIGHT, 60);
      INITIAL_BALL_SPEED = Math.max(INITIAL_BALL_SPEED, 8);
      FOUR_PLAYER_BALL_SPEED = Math.max(FOUR_PLAYER_BALL_SPEED, 6);
      
      // Update ball speed if game is in progress
      if (game.gameStarted) {
        game.ball.speed = game.isFourPlayer ? FOUR_PLAYER_BALL_SPEED : INITIAL_BALL_SPEED;
      }
    }

    // ===== RESPONSIVE DESIGN =====
    function handleResize() {
      const isMobile = window.innerWidth <= 768;
      const controlMargin = window.innerWidth * 0.05;
      document.getElementById('leftControls').style.left = `${controlMargin}px`;
      document.getElementById('rightControls').style.right = `${controlMargin}px`;
      
      const controlSize = Math.min(60, window.innerWidth * 0.12);
      document.querySelectorAll('.control-btn').forEach(btn => {
        btn.style.width = `${controlSize}px`;
        btn.style.height = `${controlSize}px`;
      });
      
      if (game.gameStarted) {
        resizeCanvas();
        resetPaddles();
        resetBall();
      }
    }

    // ===== PADDLE PHYSICS =====
    function getBallAngle(paddleY, hitY, paddleHeight) {
      const relativeY = (hitY - paddleY) / paddleHeight;
      const normalizedY = (relativeY * 2) - 1;
      return normalizedY * Math.PI / 3;
    }

    // ===== GAME LOOP =====
    function gameLoop() {
      if (!game.gameStarted || game.isPaused) {
        requestAnimationFrame(gameLoop);
        return;
      }

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      drawPaddles();
      drawBall();
      drawNet();

      updateBall();
      updatePaddles();
      checkCollisions();

      requestAnimationFrame(gameLoop);
    }

    // ===== UPDATE PADDLES =====
    function updatePaddles() {
      if (game.isPaused) return;

      // Mobile controls
      if (game.mobileControls.leftUp) game.leftPaddle.y -= PADDLE_SPEED;
      if (game.mobileControls.leftDown) game.leftPaddle.y += PADDLE_SPEED;
      if (game.mobileControls.rightUp) game.rightPaddle.y -= PADDLE_SPEED;
      if (game.mobileControls.rightDown) game.rightPaddle.y += PADDLE_SPEED;

      // Keyboard controls - fixed for fullscreen on iPad with keyboard
      if (!game.isFourPlayer) {
        if (game.isLocalMultiplayer) {
          // Player 1: W/S keys
          if (game.keysPressed['w'] || game.keysPressed['W']) game.leftPaddle.y -= PADDLE_SPEED;
          if (game.keysPressed['s'] || game.keysPressed['S']) game.leftPaddle.y += PADDLE_SPEED;
          // Player 2: Arrow Up/Down keys
          if (game.keysPressed['ArrowUp']) game.rightPaddle.y -= PADDLE_SPEED;
          if (game.keysPressed['ArrowDown']) game.rightPaddle.y += PADDLE_SPEED;
        } else {
          // Single player controls (both paddles can be controlled)
          if (game.keysPressed['w'] || game.keysPressed['W']) game.leftPaddle.y -= PADDLE_SPEED;
          if (game.keysPressed['s'] || game.keysPressed['S']) game.leftPaddle.y += PADDLE_SPEED;
          if (game.keysPressed['ArrowUp']) game.rightPaddle.y -= PADDLE_SPEED;
          if (game.keysPressed['ArrowDown']) game.rightPaddle.y += PADDLE_SPEED;
        }
      } else {
        // 4-player mode controls
        if (game.keysPressed['w'] || game.keysPressed['W']) game.leftTopPaddle.y -= PADDLE_SPEED;
        if (game.keysPressed['s'] || game.keysPressed['S']) game.leftTopPaddle.y += PADDLE_SPEED;
        if (game.keysPressed['q'] || game.keysPressed['Q']) game.leftBottomPaddle.y -= PADDLE_SPEED;
        if (game.keysPressed['a'] || game.keysPressed['A']) game.leftBottomPaddle.y += PADDLE_SPEED;
        if (game.keysPressed['o'] || game.keysPressed['O']) game.rightTopPaddle.y -= PADDLE_SPEED;
        if (game.keysPressed['l'] || game.keysPressed['L']) game.rightTopPaddle.y += PADDLE_SPEED;
        if (game.keysPressed['ArrowUp']) game.rightBottomPaddle.y -= PADDLE_SPEED;
        if (game.keysPressed['ArrowDown']) game.rightBottomPaddle.y += PADDLE_SPEED;
      }
      
      constrainPaddles();
    }

    // ===== GAME MECHANICS =====
    function resetBall() {
      game.ball.x = canvas.width / 2;
      game.ball.y = canvas.height / 2;
      game.ball.speed = game.isFourPlayer ? FOUR_PLAYER_BALL_SPEED : INITIAL_BALL_SPEED;
      game.ball.dx = Math.random() > 0.5 ? game.ball.speed : -game.ball.speed;
      game.ball.dy = (Math.random() * 2 - 1) * game.ball.speed;
    }

    function resetPaddles() {
      const paddleHeight = game.isFourPlayer ? FOUR_PLAYER_PADDLE_HEIGHT : PADDLE_HEIGHT;
      const centerY = (canvas.height - paddleHeight) / 2;
      
      game.leftPaddle.y = centerY;
      game.rightPaddle.y = centerY;
      
      if (game.isFourPlayer) {
        // Remove vertical limits for 4-player mode
        game.leftTopPaddle.y = canvas.height * 0.25 - paddleHeight/2;
        game.leftBottomPaddle.y = canvas.height * 0.75 - paddleHeight/2;
        game.rightTopPaddle.y = canvas.height * 0.25 - paddleHeight/2;
        game.rightBottomPaddle.y = canvas.height * 0.75 - paddleHeight/2;
      }
    }

    function constrainPaddles() {
      const paddleHeight = game.isFourPlayer ? FOUR_PLAYER_PADDLE_HEIGHT : PADDLE_HEIGHT;
      
      if (!game.isFourPlayer) {
        game.leftPaddle.y = Math.max(0, Math.min(canvas.height - paddleHeight, game.leftPaddle.y));
        game.rightPaddle.y = Math.max(0, Math.min(canvas.height - paddleHeight, game.rightPaddle.y));
      } else {
        // No vertical limits for 4-player mode
        game.leftTopPaddle.y = Math.max(0, Math.min(canvas.height - paddleHeight, game.leftTopPaddle.y));
        game.leftBottomPaddle.y = Math.max(0, Math.min(canvas.height - paddleHeight, game.leftBottomPaddle.y));
        game.rightTopPaddle.y = Math.max(0, Math.min(canvas.height - paddleHeight, game.rightTopPaddle.y));
        game.rightBottomPaddle.y = Math.max(0, Math.min(canvas.height - paddleHeight, game.rightBottomPaddle.y));
      }
    }

    // ===== DRAWING FUNCTIONS =====
    function drawPaddles() {
      ctx.fillStyle = 'white';
      const paddleHeight = game.isFourPlayer ? FOUR_PLAYER_PADDLE_HEIGHT : PADDLE_HEIGHT;
      
      if (!game.isFourPlayer) {
        ctx.fillRect(20, game.leftPaddle.y, PADDLE_WIDTH, paddleHeight);
        ctx.fillRect(canvas.width - 20 - PADDLE_WIDTH, game.rightPaddle.y, PADDLE_WIDTH, paddleHeight);
      } else {
        ctx.fillRect(20, game.leftTopPaddle.y, PADDLE_WIDTH, paddleHeight);
        ctx.fillRect(20, game.leftBottomPaddle.y, PADDLE_WIDTH, paddleHeight);
        ctx.fillRect(canvas.width - 20 - PADDLE_WIDTH, game.rightTopPaddle.y, PADDLE_WIDTH, paddleHeight);
        ctx.fillRect(canvas.width - 20 - PADDLE_WIDTH, game.rightBottomPaddle.y, PADDLE_WIDTH, paddleHeight);
      }
    }

    function drawBall() {
      ctx.beginPath();
      ctx.arc(game.ball.x, game.ball.y, BALL_RADIUS, 0, Math.PI * 2);
      ctx.fillStyle = 'white';
      ctx.fill();
      // Add shine effect to make ball look less flat
      ctx.beginPath();
      ctx.arc(game.ball.x - BALL_RADIUS/3, game.ball.y - BALL_RADIUS/3, BALL_RADIUS/4, 0, Math.PI * 2);
      ctx.fillStyle = 'rgba(255,255,255,0.7)';
      ctx.fill();
    }

    function drawNet() {
      ctx.setLineDash([10, 15]);
      ctx.beginPath();
      ctx.moveTo(canvas.width / 2, 0);
      ctx.lineTo(canvas.width / 2, canvas.height);
      ctx.strokeStyle = 'rgba(255,255,255,0.5)';
      ctx.lineWidth = 2;
      ctx.stroke();
      ctx.setLineDash([]);
    }

    // ===== GAME PHYSICS =====
    function updateBall() {
      if (game.isPaused) return;
      
      game.ball.x += game.ball.dx;
      game.ball.y += game.ball.dy;

      if (game.ball.y - BALL_RADIUS < 0 || game.ball.y + BALL_RADIUS > canvas.height) {
        game.ball.dy = -game.ball.dy;
      }
    }

    function checkCollisions() {
      if (game.isPaused) return;
      
      const paddleHeight = game.isFourPlayer ? FOUR_PLAYER_PADDLE_HEIGHT : PADDLE_HEIGHT;

      if (!game.isFourPlayer) {
        if (game.ball.x - BALL_RADIUS < 20 + PADDLE_WIDTH &&
            game.ball.y > game.leftPaddle.y &&
            game.ball.y < game.leftPaddle.y + paddleHeight) {
          const angle = getBallAngle(game.leftPaddle.y, game.ball.y, paddleHeight);
          game.ball.dx = Math.abs(Math.cos(angle)) * game.ball.speed;
          game.ball.dy = Math.sin(angle) * game.ball.speed;
          game.ball.speed *= 1.05;
          game.lastScorer = game.leftPlayer;
        }
        
        if (game.ball.x + BALL_RADIUS > canvas.width - 20 - PADDLE_WIDTH &&
            game.ball.y > game.rightPaddle.y &&
            game.ball.y < game.rightPaddle.y + paddleHeight) {
          const angle = getBallAngle(game.rightPaddle.y, game.ball.y, paddleHeight);
          game.ball.dx = -Math.abs(Math.cos(angle)) * game.ball.speed;
          game.ball.dy = Math.sin(angle) * game.ball.speed;
          game.ball.speed *= 1.05;
          game.lastScorer = game.rightPlayer;
        }
      } else {
        // 4-player mode collisions
        if (game.ball.x - BALL_RADIUS < 20 + PADDLE_WIDTH) {
          if ((game.ball.y > game.leftTopPaddle.y && game.ball.y < game.leftTopPaddle.y + paddleHeight) ||
              (game.ball.y > game.leftBottomPaddle.y && game.ball.y < game.leftBottomPaddle.y + paddleHeight)) {
            const paddle = game.ball.y < canvas.height/2 ? game.leftTopPaddle : game.leftBottomPaddle;
            const angle = getBallAngle(paddle.y, game.ball.y, paddleHeight);
            game.ball.dx = Math.abs(Math.cos(angle)) * game.ball.speed;
            game.ball.dy = Math.sin(angle) * game.ball.speed;
            game.ball.speed *= 1.05;
            game.lastScorer = game.leftPlayer;
          }
        }
        
        if (game.ball.x + BALL_RADIUS > canvas.width - 20 - PADDLE_WIDTH) {
          if ((game.ball.y > game.rightTopPaddle.y && game.ball.y < game.rightTopPaddle.y + paddleHeight) ||
              (game.ball.y > game.rightBottomPaddle.y && game.ball.y < game.rightBottomPaddle.y + paddleHeight)) {
            const paddle = game.ball.y < canvas.height/2 ? game.rightTopPaddle : game.rightBottomPaddle;
            const angle = getBallAngle(paddle.y, game.ball.y, paddleHeight);
            game.ball.dx = -Math.abs(Math.cos(angle)) * game.ball.speed;
            game.ball.dy = Math.sin(angle) * game.ball.speed;
            game.ball.speed *= 1.05;
            game.lastScorer = game.rightPlayer;
          }
        }
      }
      
      if (game.ball.x - BALL_RADIUS < 0) {
        game.rightPaddle.score++;
        rightScoreEl.textContent = game.rightPaddle.score;
        game.lastScorer = game.rightPlayer;
        handleScore();
      }

      if (game.ball.x + BALL_RADIUS > canvas.width) {
        game.leftPaddle.score++;
        leftScoreEl.textContent = game.leftPaddle.score;
        game.lastScorer = game.leftPlayer;
        handleScore();
      }

      if (game.leftPaddle.score >= 5 && game.rightPaddle.score >= 5 && 
          game.leftPaddle.score === game.rightPaddle.score && !game.deuceActive) {
        game.deuceActive = true;
        game.bonusPoints++;
        bonusPointsEl.textContent = `‚ö° BONUS POINT: +${game.bonusPoints}`;
        queueCommentary(getRandomCommentary('deuce'), true, true);
      } else if (game.leftPaddle.score !== game.rightPaddle.score) {
        game.deuceActive = false;
      }
    }

    function handleScore() {
      const winningThreshold = WINNING_SCORE + game.bonusPoints;

      if (game.betweenPointsTimeout) {
        clearTimeout(game.betweenPointsTimeout);
        game.betweenPointsTimeout = null;
      }

      if (checkForSpecialMove()) {
        queueCommentary(getRandomCommentary('specialMoves'), true, true);
      }
      else if ((game.leftPaddle.score === winningThreshold - 1 || 
               game.rightPaddle.score === winningThreshold - 1) && !game.matchPoint) {
        game.matchPoint = true;
        const leader = game.leftPaddle.score > game.rightPaddle.score ? game.leftPlayer : game.rightPlayer;
        const commentary = getRandomCommentary('matchPoint').replace(/{player}/g, leader);
        queueCommentary(commentary, true, true);
      }
      else {
        queueCommentary(getRandomCommentary('scores'));
      }

      if (game.leftPaddle.score >= winningThreshold || game.rightPaddle.score >= winningThreshold) {
        endGame();
        return;
      }

      if (Math.random() < 0.3) {
        game.betweenPointsTimeout = setTimeout(() => {
          queueCommentary(getRandomCommentary('betweenPoints'));
        }, 1500);
      }

      resetBall();
    }

    // ===== GAME TIMER =====
    function startTimer() {
      if (game.timerInterval) clearInterval(game.timerInterval);
      
      game.hasAnnounced30 = false;
      game.hasAnnounced10 = false;
      game.startTime = Date.now();
      
      game.timerInterval = setInterval(() => {
        if (game.isPaused) return;
        
        const elapsed = Date.now() - game.startTime;
        const remaining = Math.max(0, game.remainingTime * 1000 - elapsed);
        
        const minutes = Math.floor(remaining / 60000);
        const seconds = Math.floor((remaining % 60000) / 1000);
        const milliseconds = remaining % 1000;
        
        timerEl.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}.${milliseconds < 100 ? (milliseconds < 10 ? '00' : '0') : ''}${milliseconds}`;
        
        if (remaining <= 30000 && !game.hasAnnounced30) {
          game.hasAnnounced30 = true;
          queueCommentary(getRandomCommentary('timeWarnings'), true, true);
        }
        
        if (remaining <= 10000 && !game.hasAnnounced10) {
          game.hasAnnounced10 = true;
          queueCommentary(getRandomCommentary('timeWarnings').replace('30', '10'), true, true);
        }
        
        if (remaining <= 0) {
          clearInterval(game.timerInterval);
          handleTimeExpired();
        }
      }, 10);
    }

    function handleTimeExpired() {
      if (game.leftPaddle.score === game.rightPaddle.score) {
        game.remainingTime = OVERTIME_TIME;
        game.hasAnnounced30 = false;
        game.hasAnnounced10 = false;
        if (!game.deuceActive) {
          game.bonusPoints++;
          bonusPointsEl.textContent = `‚ö° BONUS POINT: +${game.bonusPoints}`;
        }
        queueCommentary(getRandomCommentary('overtime'), true, true);
        startTimer();
      } else {
        endGame();
      }
    }

    // ===== CONFETTI EFFECT =====
    function createConfetti() {
      const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff', '#ffffff'];
      
      for (let i = 0; i < 150; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = Math.random() * 100 + 'vw';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.animation = `confetti-fall ${Math.random() * 3 + 2}s linear forwards`;
        confetti.style.animationDelay = Math.random() * 0.5 + 's';
        
        const size = Math.random() * 8 + 5;
        confetti.style.width = size + 'px';
        confetti.style.height = size + 'px';
        
        if (Math.random() > 0.5) {
          confetti.style.borderRadius = '50%';
        } else {
          confetti.style.borderRadius = '0';
        }
        
        document.body.appendChild(confetti);
        
        setTimeout(() => {
          confetti.remove();
        }, 5000);
      }
    }

    // ===== GAME END =====
    function endGame() {
      game.gameStarted = false;
      clearInterval(game.timerInterval);
      
      // Stop all game music
      gameMusic.forEach(music => {
        music.pause();
        music.currentTime = 0;
      });
      
      if (game.musicEnabled) {
        menuMusic.play().catch(e => console.log("Menu music play prevented:", e));
      }
      
      let winner, loser, winnerScore, loserScore;
      if (game.leftPaddle.score > game.rightPaddle.score) {
        winner = game.leftPlayer;
        loser = game.rightPlayer;
        winnerScore = game.leftPaddle.score;
        loserScore = game.rightPaddle.score;
      } else {
        winner = game.rightPlayer;
        loser = game.leftPlayer;
        winnerScore = game.rightPaddle.score;
        loserScore = game.leftPaddle.score;
      }
      
      endMessage.textContent = `${winner} WINS ${winnerScore}-${loserScore}! üèÜ`;
      endScreen.style.display = "flex";
      
      // Hide D-pad if visible
      leftDpad.style.display = 'none';
      rightDpad.style.display = 'none';
      
      createConfetti();
      
      queueCommentary(`${winner} defeats ${loser} ${winnerScore}-${loserScore}!`, true, true);
      queueCommentary(getRandomCommentary('victories').replace(/{player}/g, winner), true);
      queueCommentary("What an incredible championship match we've witnessed today!", true);
    }

    // ===== MUTE TOGGLE =====
    function toggleMute() {
      game.isMuted = !game.isMuted;
      muteBtn.textContent = game.isMuted ? "üîá" : "üîä";
      window.speechSynthesis.cancel();
      
      if (game.isMuted) {
        queueCommentary("Commentary muted", true, true);
      } else {
        queueCommentary("Commentary unmuted", true, true);
      }
    }

    function toggleMusicMute() {
      game.isMusicMuted = !game.isMusicMuted;
      musicMuteBtn.textContent = game.isMusicMuted ? "üîá" : "üéµ";
      
      if (game.isMusicMuted) {
        menuMusic.volume = 0;
        gameMusic.forEach(music => music.volume = 0);
        queueCommentary("Music muted", true, true);
      } else {
        menuMusic.volume = 0.5;
        gameMusic.forEach(music => music.volume = 0.5);
        queueCommentary("Music unmuted", true, true);
        if (!game.gameStarted) {
          menuMusic.play().catch(e => console.log("Music play prevented:", e));
        } else {
          gameMusic[game.currentGameMusic].play().catch(e => console.log("Music play prevented:", e));
        }
      }
    }

    // ===== PAUSE FUNCTIONALITY =====
    function togglePause() {
      game.isPaused = !game.isPaused;
      pauseScreen.style.display = game.isPaused ? "flex" : "none";
      
      if (game.isPaused) {
        game.pausedTime = Date.now();
        if (game.musicEnabled) {
          gameMusic[game.currentGameMusic].pause();
        }
        queueCommentary("GAME PAUSED", true, true);
      } else {
        const pauseDuration = Date.now() - game.pausedTime;
        game.startTime += pauseDuration;
        if (game.musicEnabled) {
          gameMusic[game.currentGameMusic].currentTime = 0;
          gameMusic[game.currentGameMusic].play().catch(e => console.log("Music play prevented:", e));
        }
        queueCommentary("GAME RESUMED", true, true);
      }
    }

    function returnToMenu() {
      game.isPaused = false;
      pauseScreen.style.display = "none";
      endScreen.style.display = "none";
      titleScreen.style.display = "flex";
      clearInterval(game.timerInterval);
      game.gameStarted = false;
      game.isLocalMultiplayer = false;
      
      // Stop all game music and play menu music
      gameMusic.forEach(music => {
        music.pause();
        music.currentTime = 0;
      });
      
      if (game.musicEnabled) {
        menuMusic.play().catch(e => console.log("Music play prevented:", e));
      }
      
      // Hide D-pad if visible
      leftDpad.style.display = 'none';
      rightDpad.style.display = 'none';
      
      queueCommentary("RETURNING TO MENU", true, true);
    }

    // ===== COUNTDOWN FUNCTION =====
    function startCountdown() {
      let count = 3;
      countdownEl.style.display = "flex";
      
      function updateCountdown() {
        if (count > 0) {
          countdownEl.textContent = count;
          if (!game.isMuted && game.musicEnabled) {
            const utterance = new SpeechSynthesisUtterance(count.toString());
            utterance.rate = 0.8;
            utterance.pitch = 1.3;
            window.speechSynthesis.speak(utterance);
          }
          count--;
        } else if (count === 0) {
          countdownEl.textContent = "GO!";
          queueCommentary(getRandomCommentary('reactions'), true, true);
          if (!game.isMuted && game.musicEnabled) {
            const utterance = new SpeechSynthesisUtterance("GO!");
            utterance.rate = 0.7;
            utterance.pitch = 1.5;
            window.speechSynthesis.speak(utterance);
          }
          count--;
        } else {
          clearInterval(game.countdownInterval);
          countdownEl.style.display = "none";
          game.gameStarted = true;
          game.startTime = Date.now();
          menuMusic.pause();
          
          // Select random game music and start from beginning
          if (game.musicEnabled) {
            game.currentGameMusic = Math.floor(Math.random() * gameMusic.length);
            gameMusic[game.currentGameMusic].currentTime = 0;
            gameMusic[game.currentGameMusic].play().catch(e => {
              console.log("Game music error:", e);
            });
          }
          startTimer();
        }
      }
      
      updateCountdown();
      game.countdownInterval = setInterval(updateCountdown, 1000);
    }

    // ===== START/RESTART GAME =====
    function startGame() {
      game.isPaused = false;
      game.leftPaddle.score = 0;
      game.rightPaddle.score = 0;
      game.remainingTime = GAME_TIME;
      game.matchPoint = false;
      game.bonusPoints = 0;
      game.deuceActive = false;
      game.commentaryQueue = [];
      game.hasAnnounced30 = false;
      game.hasAnnounced10 = false;
      bonusPointsEl.textContent = "";
      game.ball.speed = game.isFourPlayer ? FOUR_PLAYER_BALL_SPEED : INITIAL_BALL_SPEED;

      titleScreen.style.display = "none";
      endScreen.style.display = "none";
      pauseScreen.style.display = "none";
      resetBall();
      resetPaddles();
      
      leftScoreEl.textContent = "0";
      rightScoreEl.textContent = "0";
      timerEl.textContent = "2:00.000";
      
      // Show D-pad for both players if enabled
      if (window.innerWidth <= 768) {
        leftDpad.style.display = game.dpadEnabled ? 'block' : 'none';
        rightDpad.style.display = game.dpadEnabled ? 'block' : 'none';
      }
      
      // Enhanced tournament introductions
      queueCommentary(getRandomCommentary('introductions'), true, true);
      setTimeout(() => {
        queueCommentary(getRandomCommentary('playerIntroductions'), true);
      }, 3000);
      setTimeout(() => {
        queueCommentary(getRandomCommentary('countdown'), true);
      }, 6000);
      
      startCountdown();
    }

    // ===== KEYBOARD CONTROLS =====
    function setupKeyboardControls() {
      document.addEventListener('keydown', (e) => {
        if (e.key === 'p' || e.key === 'P') {
          togglePause();
        } else if (e.key === 'm' || e.key === 'M') {
          toggleMute();
        } else if (e.key === 'f' || e.key === 'F') {
          toggleFullscreen();
        } else {
          game.keysPressed[e.key] = true;
        }
      });

      document.addEventListener('keyup', (e) => {
        game.keysPressed[e.key] = false;
      });
    }

    // ===== INITIALIZE GAME =====
    document.addEventListener('DOMContentLoaded', () => {
      initGame();
    });
  </script>
</body>
</html>
